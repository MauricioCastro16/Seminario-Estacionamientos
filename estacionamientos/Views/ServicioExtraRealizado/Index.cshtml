@model IEnumerable<estacionamientos.Models.ServicioExtraRealizado>

@{
    ViewData["Title"] = "Servicios Extra Realizados";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Servicios Extra</h2>
    <a asp-action="Create" class="btn btn-primary shadow-sm">
        <i class="bi bi-plus-circle"></i> Registrar nuevo servicio
    </a>
</div>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger shadow-sm">
        <i class="fa-solid fa-triangle-exclamation me-2"></i>
        @TempData["Error"]
    </div>
}

<div class="mb-3">
    <p class="text-muted mb-0">
        <i class="fa-solid fa-location-dot me-1 text-primary"></i>
        Playa: <strong>@ViewBag.PlayaNombre</strong>
    </p>
</div>

<!-- TABLA -->
<div class="table-responsive mt-3">
    <table class="table table-striped table-hover table-sm align-middle text-center shadow-sm">
        <thead class="table-light">
            <tr>
                <th class="text-center">Servicio</th>
                <th class="text-center">Patente</th>
                <th class="text-center">Estado</th>
                <th class="text-center">Comentario</th>
                <th class="text-center">Acciones</th>
            </tr>
        </thead>
        <tbody>
        @if (!Model.Any())
        {
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fa-regular fa-circle-xmark me-1"></i>
                    No hay servicios registrados en este turno.
                </td>
            </tr>
        }
        else
        {
            foreach (var s in Model)
            {
                <tr>
                    <td>@s.ServicioProveido?.Servicio?.SerNom</td>
                    <td><span class="fw-semibold">@s.VehPtnt</span></td>
                    <td>
                        @switch (s.ServExEstado)
                        {
                            case "Pendiente":
                                <span class="text-warning fw-bold">Pendiente</span>;                                
                                break;
                            case "En curso":
                                <span class="text-info fw-bold">En curso</span>;
                                break;
                            case "Completado":
                                <span class="text-success fw-bold",>Completado</span>;
                                break;
                            case "Cancelado":
                                <span class="text-danger fw-bold">Cancelado</span>;
                                break;
                            default:
                                <span class="badge bg-secondary px-3 py-2 shadow-sm">Sin estado</span>;
                                break;
                        }
                    </td>
                    <td class="text-muted small">@s.ServExComp</td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-2">

                            @{
                                var servicioKey = $"{s.PlyID}_{s.SerID}_{s.VehPtnt}_{s.ServExFyHIni:o}";
                                var tieneOcupacion = ViewBag.ServiciosConOcupacion != null && 
                                                    ((Dictionary<string, bool>)ViewBag.ServiciosConOcupacion).ContainsKey(servicioKey) &&
                                                    ((Dictionary<string, bool>)ViewBag.ServiciosConOcupacion)[servicioKey];
                                var puedeRetirar = !tieneOcupacion && s.ServExEstado == "Completado" && s.PagNum == null;
                            }

                            @if (s.ServExEstado == "Pendiente")
                            {
                                <form asp-action="CambiarEstado" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="plyID" value="@s.PlyID" />
                                    <input type="hidden" name="serID" value="@s.SerID" />
                                    <input type="hidden" name="vehPtnt" value="@s.VehPtnt" />
                                    <input type="hidden" name="servExFyHIni" value="@s.ServExFyHIni.ToString("o")" />
                                    <input type="hidden" name="nuevoEstado" value="En curso" />
                                    <button type="submit" class="btn btn-outline-secondary btn-sm" title="Iniciar servicio">
                                        <i class="fa-solid fa-play"></i>
                                    </button>
                                </form>
                            }
                            else if (s.ServExEstado == "En curso")
                            {
                                <form asp-action="CambiarEstado" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="plyID" value="@s.PlyID" />
                                    <input type="hidden" name="serID" value="@s.SerID" />
                                    <input type="hidden" name="vehPtnt" value="@s.VehPtnt" />
                                    <input type="hidden" name="servExFyHIni" value="@s.ServExFyHIni.ToString("o")" />
                                    <input type="hidden" name="nuevoEstado" value="Finalizado" />
                                    <button type="submit" class="btn btn-outline-success btn-sm" title="Finalizar servicio">
                                        <i class="fa-solid fa-check"></i>
                                    </button>
                                </form>
                            }
                            else
                            {
                                <button class="btn btn-outline-secondary btn-sm" disabled title="Sin acciones disponibles">
                                    <i class="fa-solid fa-ban"></i>
                                </button>
                            }

                            <!-- Botón Retirar - siempre visible, cambia según estado -->
                            @if (s.PagNum != null)
                            {
                                <button type="button" 
                                        class="btn btn-success btn-sm" 
                                        title="Ya retirado y cobrado"
                                        disabled>
                                    <i class="fa-solid fa-check-circle"></i> Retirado
                                </button>
                            }
                            else if (tieneOcupacion && s.ServExEstado == "Completado")
                            {
                                <button type="button" 
                                        class="btn btn-info btn-sm" 
                                        title="Se cobrará junto con la ocupación al momento del egreso"
                                        disabled>
                                    <i class="fa-solid fa-info-circle"></i> Pendiente
                                </button>
                            }
                            else if (puedeRetirar)
                            {
                                <a asp-action="Retirar"
                                   asp-route-plyID="@s.PlyID"
                                   asp-route-serID="@s.SerID"
                                   asp-route-vehPtnt="@s.VehPtnt"
                                   asp-route-servExFyHIni="@s.ServExFyHIni.ToString("o")"
                                   class="btn btn-outline-warning btn-sm"
                                   title="Retirar y cobrar">
                                    <i class="fa-solid fa-money-bill-wave"></i> Retirar
                                </a>
                            }
                            else
                            {
                                <button type="button" 
                                        class="btn btn-outline-warning btn-sm disabled" 
                                        title="Debe estar completado para retirar"
                                        disabled>
                                    <i class="fa-solid fa-money-bill-wave"></i> Retirar
                                </button>
                            }

                            <!-- Detalles -->
                            <a asp-action="Details"
                               asp-route-plyID="@s.PlyID"
                               asp-route-serID="@s.SerID"
                               asp-route-vehPtnt="@s.VehPtnt"
                               asp-route-servExFyHIni="@s.ServExFyHIni.ToString("o")"
                               class="btn btn-outline-primary btn-sm"
                               title="Ver detalles">
                                <i class="fa-solid fa-eye"></i>
                            </a>

                        </div>
                    </td>
                </tr>
            }
        }
        </tbody>
    </table>
</div>
