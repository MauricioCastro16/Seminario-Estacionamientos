@model IEnumerable<estacionamientos.Models.ServicioExtraRealizado>

@{
    ViewData["Title"] = "Servicios Extra Realizados";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Servicios Extra</h2>
    <a asp-action="Create" class="btn btn-primary shadow-sm">
        <i class="bi bi-plus-circle"></i> Registrar nuevo servicio
    </a>
</div>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger shadow-sm">
        <i class="fa-solid fa-triangle-exclamation me-2"></i>
        @TempData["Error"]
    </div>
}

<div class="mb-3">
    <p class="text-muted mb-0">
        <i class="fa-solid fa-location-dot me-1 text-primary"></i>
        Playa: <strong>@ViewBag.PlayaNombre</strong>
    </p>
</div>

<!-- TABLA -->
<div class="table-responsive mt-3">
    <table class="table table-striped table-hover table-sm align-middle text-center shadow-sm">
        <thead class="table-light">
            <tr>
                <th class="text-center">Servicio</th>
                <th class="text-center">Patente</th>
                <th class="text-center">Estado</th>
                <th class="text-center">Comentario</th>
                <th class="text-center" style="width: 280px; min-width: 280px;">Acciones</th>
            </tr>
        </thead>
        <tbody>
        @if (!Model.Any())
        {
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fa-regular fa-circle-xmark me-1"></i>
                    No hay servicios registrados en este turno.
                </td>
            </tr>
        }
        else
        {
            foreach (var s in Model)
            {
                <tr>
                    <td>@s.ServicioProveido?.Servicio?.SerNom</td>
                    <td><span class="fw-semibold">@s.VehPtnt</span></td>
                    <td>
                        @switch (s.ServExEstado)
                        {
                            case "Pendiente":
                                <span class="text-warning fw-bold">Pendiente</span>;                                
                                break;
                            case "En curso":
                                <span class="text-info fw-bold">En curso</span>;
                                break;
                            case "Completado":
                                <span class="text-success fw-bold",>Completado</span>;
                                break;
                            case "Cancelado":
                                <span class="text-danger fw-bold">Cancelado</span>;
                                break;
                            default:
                                <span class="badge bg-secondary px-3 py-2 shadow-sm">Sin estado</span>;
                                break;
                        }
                    </td>
                    <td class="text-muted small">@s.ServExComp</td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-2 align-items-center" style="min-height: 38px;">

                            @{
                                var servicioKey = $"{s.PlyID}_{s.SerID}_{s.VehPtnt}_{s.ServExFyHIni:o}";
                                var tieneOcupacion = ViewBag.ServiciosConOcupacion != null && 
                                                    ((Dictionary<string, bool>)ViewBag.ServiciosConOcupacion).ContainsKey(servicioKey) &&
                                                    ((Dictionary<string, bool>)ViewBag.ServiciosConOcupacion)[servicioKey];
                                var puedeRetirar = !tieneOcupacion && s.ServExEstado == "Completado" && s.PagNum == null;
                            }

                            @if (s.ServExEstado == "Pendiente")
                            {
                                <form asp-action="CambiarEstado" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="plyID" value="@s.PlyID" />
                                    <input type="hidden" name="serID" value="@s.SerID" />
                                    <input type="hidden" name="vehPtnt" value="@s.VehPtnt" />
                                    <input type="hidden" name="servExFyHIni" value="@s.ServExFyHIni.ToString("o")" />
                                    <input type="hidden" name="nuevoEstado" value="En curso" />
                                    <button type="submit" class="btn btn-outline-primary btn-sm" title="Iniciar servicio" style="min-width: 38px;">
                                        <i class="fa-solid fa-play"></i>
                                    </button>
                                </form>
                            }
                            else if (s.ServExEstado == "En curso")
                            {
                                <form asp-action="CambiarEstado" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="plyID" value="@s.PlyID" />
                                    <input type="hidden" name="serID" value="@s.SerID" />
                                    <input type="hidden" name="vehPtnt" value="@s.VehPtnt" />
                                    <input type="hidden" name="servExFyHIni" value="@s.ServExFyHIni.ToString("o")" />
                                    <input type="hidden" name="nuevoEstado" value="Finalizado" />
                                    <button type="submit" class="btn btn-outline-success btn-sm" title="Finalizar servicio" style="min-width: 38px;">
                                        <i class="fa-solid fa-check"></i>
                                    </button>
                                </form>
                            }
                            else
                            {
                                <button class="btn btn-outline-secondary btn-sm" disabled title="Sin acciones disponibles" style="min-width: 38px;">
                                    <i class="fa-solid fa-ban"></i>
                                </button>
                            }

                            <!-- Botón Retirar - siempre visible, cambia según estado -->
                            @if (s.PagNum != null)
                            {
                                <button type="button" 
                                        class="btn btn-success btn-sm" 
                                        title="Ya retirado y cobrado"
                                        disabled
                                        style="min-width: 100px;">
                                    <i class="fa-solid fa-check-circle"></i> Retirado
                                </button>
                            }
                            else if (tieneOcupacion && s.ServExEstado == "Completado")
                            {
                                <button type="button" 
                                        class="btn btn-info btn-sm" 
                                        title="Se cobrará junto con la ocupación al momento del egreso"
                                        disabled
                                        style="min-width: 100px;">
                                    <i class="fa-solid fa-info-circle"></i> Pendiente
                                </button>
                            }
                            else if (puedeRetirar)
                            {
                                <a asp-action="Retirar"
                                   asp-route-plyID="@s.PlyID"
                                   asp-route-serID="@s.SerID"
                                   asp-route-vehPtnt="@s.VehPtnt"
                                   asp-route-servExFyHIni="@s.ServExFyHIni.ToString("o")"
                                   class="btn btn-outline-primary btn-sm"
                                   title="Retirar y cobrar"
                                   style="min-width: 100px;">
                                    <i class="fa-solid fa-money-bill-wave"></i> Retirar
                                </a>
                            }
                            else
                            {
                                <button type="button" 
                                        class="btn btn-outline-warning btn-sm disabled" 
                                        title="Debe estar completado para retirar"
                                        disabled
                                        style="min-width: 100px;">
                                    <i class="fa-solid fa-money-bill-wave"></i> Retirar
                                </button>
                            }

                            <!-- Detalles -->
                            <button type="button" 
                                    class="btn btn-outline-primary btn-sm" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#detallesModal"
                                    onclick="cargarDetalles(@s.PlyID, @s.SerID, '@s.VehPtnt', '@s.ServExFyHIni.ToString("yyyy-MM-ddTHH:mm:ss.fffZ")')"
                                    title="Ver detalles"
                                    style="min-width: 38px;">
                                <i class="fa-solid fa-eye"></i>
                            </button>

                        </div>
                    </td>
                </tr>
            }
        }
        </tbody>
    </table>
</div>

<div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detallesModalLabel">
                    <i class="fa fa-eye me-2"></i>
                    Detalles de Servicio Extra
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detallesContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    function cargarDetalles(plyID, serID, vehPtnt, servExFyHIni) {
        // Mostrar spinner
        document.getElementById('detallesContent').innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        `;
        
        // Hacer petición AJAX
        const url = `/ServicioExtraRealizado/DetallesJson?plyID=${plyID}&serID=${serID}&vehPtnt=${vehPtnt}&servExFyHIni=${encodeURIComponent(servExFyHIni)}`;
        console.log('Cargando detalles:', url);
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Datos recibidos:', data);
                if (data.error) {
                    throw new Error(data.error);
                }
                mostrarDetalles(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('detallesContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        Error al cargar los detalles: ${error.message}
                        <br><small class="text-muted">URL: ${url}</small>
                    </div>
                `;
            });
    }
    
    function mostrarDetalles(data) {
        const horaInicio = new Date(data.servExFyHIni).toLocaleString();
        const estaRetirado = data.pago != null;
        
        let comentarioHtml = '';
        if (data.servExComp && data.servExComp.trim() !== '') {
            comentarioHtml = `
                <tr>
                    <td><strong>Comentario:</strong></td>
                    <td>${data.servExComp}</td>
                </tr>
            `;
        }

        const estadoBadgeClass = data.servExEstado?.toLowerCase() === 'pendiente' ? 'bg-warning' :
                                 data.servExEstado?.toLowerCase() === 'en curso' ? 'bg-info' :
                                 data.servExEstado?.toLowerCase() === 'completado' ? 'bg-success' :
                                 data.servExEstado?.toLowerCase() === 'cancelado' ? 'bg-danger' : 'bg-secondary';

        let pagoInfo = '';
        if (data.pago) {
            pagoInfo = `
                <div class="row mb-3">
                    <div class="col-12">
                        <h6 class="text-primary">Información de Pago</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Número de Pago:</strong></td>
                                <td>${data.pago.pagNum}</td>
                            </tr>
                            <tr>
                                <td><strong>Método de Pago:</strong></td>
                                <td>${data.pago.metodoPago}</td>
                            </tr>
                            <tr>
                                <td><strong>Monto:</strong></td>
                                <td class="fw-bold text-success">$${data.pago.pagMonto.toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;
        }

        document.getElementById('detallesContent').innerHTML = `
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6 class="text-primary">Información del Servicio</h6>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Servicio:</strong></td>
                            <td>${data.servicioNombre}</td>
                        </tr>
                        <tr>
                            <td><strong>Patente:</strong></td>
                            <td>${data.vehPtnt}</td>
                        </tr>
                        <tr>
                            <td><strong>Tipo de vehículo:</strong></td>
                            <td>${data.clasificacionVehiculo}</td>
                        </tr>
                        <tr>
                            <td><strong>Estado:</strong></td>
                            <td><span class="badge ${estadoBadgeClass}">${data.servExEstado}</span></td>
                        </tr>
                        ${comentarioHtml}
                    </table>
                </div>
                <div class="col-md-6">
                    <h6 class="text-primary">Información de Cobro</h6>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Hora de inicio:</strong></td>
                            <td>${horaInicio}</td>
                        </tr>
                        <tr>
                            <td><strong>Retirado:</strong></td>
                            <td>
                                ${estaRetirado 
                                    ? '<span class="badge bg-success">Sí</span>' 
                                    : '<span class="badge bg-secondary">No</span>'}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            ${pagoInfo}
        `;
    }
</script>
