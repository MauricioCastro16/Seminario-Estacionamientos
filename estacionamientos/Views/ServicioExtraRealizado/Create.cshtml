@model estacionamientos.Models.ServicioExtraRealizado
@{
    ViewData["Title"] = "Registrar Servicio Extra";
}

<h2>Registrar Servicio Extra</h2>

<!-- 游댳 Bloque de errores -->
@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
            <div>@error.ErrorMessage</div>
        }
    </div>
}

<form asp-action="Create" method="post">
    @Html.AntiForgeryToken()

    <div class="mb-3">
        <label class="form-label">Playa</label>
        @if (User.IsInRole("Playero") && ViewBag.SelectedPlyID != null)
        {
            <input type="text" class="form-control" value="@ViewBag.SelectedPlyNombre" disabled />
            <!-- usar asp-for para asegurar el binding correcto -->
            <input type="hidden" asp-for="PlyID" />
        }
    </div>

    <div class="mb-3">
        <label asp-for="SerID" class="form-label">Servicio</label>
        <select asp-for="SerID" class="form-select" asp-items="(SelectList)ViewBag.SerID">
            <option value="">Seleccione un servicio...</option>
        </select>
        <small id="servicioDesc" class="text-muted d-block mt-1"></small>
    </div>

    <div class="mb-3">
        <label asp-for="VehPtnt" class="form-label">Patente</label>
        <input asp-for="VehPtnt" class="form-control" autocomplete="off" id="VehPtnt" />
        <div id="ocupacionBadge" class="mt-2" style="display: none;">
            <span class="badge" id="badgeOcupacion"></span>
        </div>
    </div>

    <div class="mb-3">
        <label for="ClasVehID" class="form-label">Tipo de Veh칤culo</label>
        <select id="ClasVehID" name="ClasVehID" class="form-select" asp-items="(SelectList)ViewBag.ClasVehID">
            <option value="">Seleccione un tipo de veh칤culo...</option>
        </select>
        <!-- Campo oculto para mantener el valor cuando el select est치 deshabilitado -->
        <input type="hidden" id="ClasVehID_Hidden" name="ClasVehID" />
    </div>

    <!-- 游댳 Contenedor para mensaje de error -->
    <div id="tarifaError" class="text-danger mt-3 d-none"></div>

    <div class="mb-3">
        <label asp-for="ServExComp" class="form-label">Comentario (opcional)</label>
        <textarea asp-for="ServExComp" class="form-control"></textarea>
    </div>

    <!-- dejar que el model binder maneje el valor; el controlador sobreescribe con UTC en POST -->
    <input type="hidden" asp-for="ServExFyHIni" />


    <button type="submit" class="btn btn-primary">Registrar</button>
    <a asp-action="Index" class="btn btn-secondary ms-2">Volver</a>

</form>

@section Scripts {
<script>
$(function () {
    const $submitBtn = $('form').find('button[type=submit]');
    const $tarifaError = $('#tarifaError');
    const $ocupacionBadge = $('#ocupacionBadge');
    const $badgeOcupacion = $('#badgeOcupacion');

    function verificarTarifa() {
        const serID = $('#SerID').val();
        const clasVehID = $('#ClasVehID').val();
        const plyID = $('input[name="PlyID"]').val();

        // Limpia cualquier mensaje previo
        $tarifaError.text('').addClass('d-none');
        $submitBtn.prop('disabled', false);

        if (!serID || !clasVehID || !plyID) return;

        $.getJSON('@Url.Action("VerificarTarifaVigente", "ServicioExtraRealizado")', {
            plyID: plyID,
            serID: serID,
            clasVehID: clasVehID
        })
        .done(function (tieneTarifa) {
            if (!tieneTarifa) {
                $tarifaError
                    .text(' No hay tarifas vigentes para el servicio y tipo de veh칤culo seleccionados.')
                    .removeClass('d-none');
                $submitBtn.prop('disabled', true);
            }
        })
    }

    function verificarOcupacion() {
        const vehPtnt = $('#VehPtnt').val();
        const plyID = $('input[name="PlyID"]').val();
        const $clasVehSelect = $('#ClasVehID');
        const $clasVehAutocompletado = $('#clasVehAutocompletado');

        if (!vehPtnt || !plyID) {
            $ocupacionBadge.hide();
            $clasVehSelect.prop('disabled', false);
            $clasVehAutocompletado.hide();
            return;
        }

        $.getJSON('@Url.Action("VerificarOcupacionActiva", "ServicioExtraRealizado")', {
            plyID: plyID,
            vehPtnt: vehPtnt
        })
        .done(function (data) {
            if (data.tieneOcupacion) {
                $badgeOcupacion
                    .removeClass('bg-danger bg-secondary')
                    .addClass('bg-success')
                    .text('Con ocupaci칩n activa');
                
                // Autocompletar el tipo de veh칤culo seg칰n la ocupaci칩n activa
                if (data.clasVehID) {
                    $clasVehSelect.val(data.clasVehID);
                    // Sincronizar con el campo hidden y deshabilitar el select
                    $('#ClasVehID_Hidden').val(data.clasVehID);
                    $clasVehSelect.prop('disabled', true);
                    // Remover el name del select para que no se env칤e, usar el hidden
                    $clasVehSelect.removeAttr('name');
                    $clasVehAutocompletado.show();
                    // Verificar tarifa despu칠s de autocompletar
                    verificarTarifa();
                }
            } else {
                $badgeOcupacion
                    .removeClass('bg-success bg-secondary')
                    .addClass('bg-danger')
                    .text('Sin ocupaci칩n activa');
                
                // Habilitar el campo para selecci칩n manual
                $clasVehSelect.prop('disabled', false);
                // Restaurar el name del select y limpiar el hidden
                $clasVehSelect.attr('name', 'ClasVehID');
                $('#ClasVehID_Hidden').val('');
                $clasVehAutocompletado.hide();
            }
            $ocupacionBadge.show();
        })
        .fail(function () {
            $ocupacionBadge.hide();
            $clasVehSelect.prop('disabled', false);
            $clasVehSelect.attr('name', 'ClasVehID');
            $('#ClasVehID_Hidden').val('');
            $clasVehAutocompletado.hide();
        });
    }

    // 游댳 Verificar cada vez que cambia servicio o tipo de veh칤culo
    $('#SerID, #ClasVehID').on('change', verificarTarifa);

    // 游댳 Verificar ocupaci칩n cuando cambia la patente (con debounce)
    let ocupacionTimeout;
    $('#VehPtnt').on('input', function () {
        clearTimeout(ocupacionTimeout);
        ocupacionTimeout = setTimeout(verificarOcupacion, 500);
    });

    // 游댳 Verificaci칩n inicial por si ya hay algo seleccionado
    verificarTarifa();
    
    // 游댳 Verificar ocupaci칩n inicial si hay patente en el modelo (despu칠s de error de validaci칩n)
    @if (ViewBag.TieneOcupacionActiva != null && !string.IsNullOrWhiteSpace(Model.VehPtnt))
    {
        <text>
        if ($('#VehPtnt').val()) {
            const tieneOcupacion = @((ViewBag.TieneOcupacionActiva as bool?) == true ? "true" : "false");
            if (tieneOcupacion) {
                $badgeOcupacion
                    .removeClass('bg-danger bg-secondary')
                    .addClass('bg-success')
                    .text('Con ocupaci칩n activa');
                
                // Autocompletar el tipo de veh칤culo si est치 disponible
                @if (ViewBag.ClasVehIDOcupacion != null)
                {
                    <text>
                    const clasVehID = @ViewBag.ClasVehIDOcupacion;
                    if (clasVehID) {
                        $clasVehSelect.val(clasVehID);
                        $('#ClasVehID_Hidden').val(clasVehID);
                        $clasVehSelect.prop('disabled', true);
                        $clasVehSelect.removeAttr('name');
                        $clasVehAutocompletado.show();
                    }
                    </text>
                }
            } else {
                $badgeOcupacion
                    .removeClass('bg-success bg-secondary')
                    .addClass('bg-danger')
                    .text('Sin ocupaci칩n activa');
            }
            $ocupacionBadge.show();
        }
        </text>
    }
});
</script>
}
