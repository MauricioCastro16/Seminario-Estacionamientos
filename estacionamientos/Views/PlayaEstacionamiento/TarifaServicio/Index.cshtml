@model estacionamientos.Models.ViewModels.TarifasIndexVM
@{
    ViewData["Title"] = "Tarifas de Servicios";

    string LabelFiltro(string v) => v switch {
        "playa" => "Playa",
        "servicio" => "Servicio",
        "clase" => "Clase Veh√≠culo",
        "vigencia" => "Vigencia",
        _ => "Todos"
    };

    bool hayFiltros = Model.FilterBy != "all"
                   || !string.IsNullOrWhiteSpace(Model.Q);
}

<div class="container">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">
            Tarifas de Servicios
            @if (ViewBag.PlayaNombre != null)
            {
                <span>: @ViewBag.PlayaNombre</span>
            }
        </h1>

        <a asp-action="Create"
           asp-route-plySel="@ViewBag.PlyID"
           class="btn btn-primary">
            + Nueva Tarifa
        </a>
    </div>

    <!-- Formulario de b√∫squeda/filtros -->
    <form method="get" id="searchForm" class="row g-2 align-items-center">
        <!-- üëá input oculto para mantener la playa -->
        <input type="hidden" name="plyID" value="@ViewBag.PlyID" />

        <!-- Campo de texto -->
        <div class="col-md-5 @(Model.FilterBy == "vigencia" ? "d-none" : "")" id="qWrapper">
            <input name="Q" id="qInput" value="@Model.Q" class="form-control" placeholder="Buscar..." />
        </div>

        <!-- Select de Vigencia -->
        <div class="col-md-5 @(Model.FilterBy == "vigencia" ? "" : "d-none")" id="vigWrapper">
            <select name="selectedOption" id="vigSelect" class="form-select">
                <option value="">Seleccionar vigencia‚Ä¶</option>
                <option value="Vigente"
                    selected="@(Model.SelectedOption != null && Model.SelectedOption.Equals("Vigente", StringComparison.OrdinalIgnoreCase) ? "selected" : null)">
                    Vigente
                </option>
                <option value="No vigente"
                    selected="@(Model.SelectedOption != null && Model.SelectedOption.Equals("No vigente", StringComparison.OrdinalIgnoreCase) ? "selected" : null)">
                    No vigente
                </option>
            </select>
        </div>

        <!-- Bot√≥n Filtrar -->
        <div class="col-auto">
            <div class="btn-group">
                <input type="hidden" name="FilterBy" id="filterBy" value="@Model.FilterBy" />
                <button type="button" class="btn btn-outline-secondary dropdown-toggle"
                        data-bs-toggle="dropdown" aria-expanded="false" id="filterBtn">
                    <i class="fa-solid fa-filter"></i> Filtrar: @Model.FilterBy
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" data-value="all">Todos</a></li>
                    <li><a class="dropdown-item" href="#" data-value="servicio">Servicio</a></li>
                    <li><a class="dropdown-item" href="#" data-value="clase">Clase</a></li>
                    <li><a class="dropdown-item" href="#" data-value="vigencia">Vigencia</a></li>
                </ul>
            </div>
        </div>

        <!-- Buscar + Limpiar -->
        <div class="col-auto">
            <button type="submit" class="btn btn-secondary" title="Buscar">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
            <a id="btnLimpiar"
               class="btn btn-outline-secondary"
               asp-action="Index"
               asp-route-plyID="@ViewBag.PlyID"
               title="Limpiar filtros">
                <i class="fa-regular fa-circle-xmark"></i>
            </a>
        </div>
    </form>

    <!-- Tabla -->
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th>Servicio</th>
                <th>Clase Veh√≠culo</th>
                <th>Vigencia</th>
                <th>Monto</th>
                <th class="text-end">Acciones</th>
            </tr>
        </thead>
        <tbody>
        @if (Model.Tarifas == null || !Model.Tarifas.Any())
        {
            <tr>
                <td colspan="6" class="text-center text-muted py-4">No se encontraron resultados.</td>
            </tr>
        }
        else
        {
            @foreach (var item in Model.Tarifas)
            {
                var esVigente = item.TasFecFin == null || item.TasFecFin > DateTime.UtcNow;
                <tr class="@(esVigente ? "" : "table-secondary")">
                    <td>@item.ServicioProveido.Servicio.SerNom</td>
                    <td>@item.ClasificacionVehiculo.ClasVehTipo</td>
                    <td>
                        @if (esVigente && item.ServicioProveido?.SerProvHab == true)
                        {
                            <span class="badge bg-success">Vigente</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">No vigente</span>
                        }
                    </td>

                    <td>$@item.TasMonto</td>
                    <td class="text-center align-middle">
                        <a asp-action="Details"
                           asp-route-plyID="@item.PlyID"
                           asp-route-serID="@item.SerID"
                           asp-route-clasVehID="@item.ClasVehID"
                           asp-route-tasFecIni="@item.TasFecIni"
                           class="btn btn-outline-primary btn-sm me-2"
                           title="Detalles">
                            <i class="fa-solid fa-eye"></i>
                        </a>
                        <a asp-action="Edit"
                           asp-route-plyID="@item.PlyID"
                           asp-route-serID="@item.SerID"
                           asp-route-clasVehID="@item.ClasVehID"
                           asp-route-tasFecIni="@item.TasFecIni"
                           class="btn btn-sm btn-outline-secondary me-1"
                           title="Editar">
                            <i class="fa-regular fa-pen-to-square"></i>
                        </a>
                        @if (esVigente)
                        {
                            <a asp-action="Delete"
                               asp-route-plyID="@item.PlyID"
                               asp-route-serID="@item.SerID"
                               asp-route-clasVehID="@item.ClasVehID"
                               asp-route-tasFecIni="@item.TasFecIni"
                               class="btn btn-outline-danger btn-sm"
                               title="Suspender tarifa">
                                <i class="fa-regular fa-trash-can"></i>
                            </a>
                        }
                        else
                        {
                            <button class="btn btn-sm btn-outline-secondary" disabled title="No vigente">
                                <i class="fa-regular fa-circle-xmark"></i>
                            </button>
                        }
                    </td>
                </tr>
            }
        }
        </tbody>
    </table>
</div>

@if (ViewBag.PlayaNombre != null)
{
    <div class="mt-3">
        <a asp-controller="PlayaEstacionamiento" asp-action="Index" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left"></i> Volver
        </a>
    </div>
}

<script>
  const mapLbl = {
    all: 'Todos',
    playa: 'Playa',
    servicio: 'Servicio',
    clase: 'Clase Veh√≠culo',
    vigencia: 'Vigencia'
  };

  const formEl = document.getElementById('searchForm');

  // Cambiar filtro desde el dropdown
  document.querySelectorAll('.dropdown-menu .dropdown-item').forEach(el => {
    el.addEventListener('click', (e) => {
      e.preventDefault();
      const value = el.getAttribute('data-value');
      document.getElementById('filterBy').value = value;
      document.getElementById('filterBtn').innerHTML =
        '<i class="fa-solid fa-filter"></i> Filtrar: ' + (mapLbl[value] || 'Todos');
      formEl.submit();
    });
  });

  // Cambiar la opci√≥n de Vigencia
  document.getElementById('vigSelect')?.addEventListener('change', () => {
    formEl.submit();
  });

  // Buscar con Enter en el input de texto
  document.getElementById('qInput')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      formEl.submit();
    }
  });
</script>
