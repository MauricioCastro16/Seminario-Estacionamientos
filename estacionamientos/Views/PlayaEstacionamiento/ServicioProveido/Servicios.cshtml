@model estacionamientos.ViewModels.ServiciosViewModel

@{
    ViewData["Title"] = "Servicios disponibles";
}

<form asp-action="AsignarServicios" asp-route-plyID="@Model.PlayaID"
      method="post"
      class="container d-flex flex-column gap-3 align-items-center"
      style="max-width:1000px;">
      
    <div class="mb-3 position-relative w-100">
      <div class="text-center">
        <h1 class="display-6 fw-semibold mb-0">@ViewData["Title"]</h1>
        <h5 class="text-muted">@Model.PlayaNom</h5>
      </div>
      <button type="button" 
              class="btn btn-outline-secondary btn-sm position-absolute" 
              id="btnConfiguracionAbono"
              data-bs-toggle="modal" 
              data-bs-target="#modalConfiguracionAbono"
              disabled
              style="top: 8px; right: 10px;">
        <i class="bi bi-gear me-1"></i>Configurar abonos
      </button>
    </div>

    <div class="row row-cols-1 row-cols-md-3 g-4">
        @for (int i = 0; i < Model.ServiciosDisponibles.Count; i++)
        {
            var servicio = Model.ServiciosDisponibles[i];
            bool seleccionado = Model.ServiciosAsignados.Contains(servicio.SerID);
            string cid = $"ser_{servicio.SerID}";

            // Asignación de icono dependiendo del SerID
            string icon = "bi-cart-check-fill"; // Icono predeterminado

            // Elegir icono según el SerID
            if (servicio.SerID == 1) icon = "bi-bucket-fill";
            else if (servicio.SerID == 2) icon = "bi-wrench";
            else if (servicio.SerID == 3) icon = "bi-fuel-pump";
            else if (servicio.SerID == 4) icon = "bi-bookmark-check-fill";
            else if (servicio.SerID == 5) icon = "bi-car-front-fill";
            else if (servicio.SerID == 6) icon = "bi-car-front-fill";
            else if (servicio.SerID == 7) icon = "bi-car-front-fill";
            else if (servicio.SerID == 8) icon = "bi-car-front-fill";
            else if (servicio.SerID == 9) icon = "bi-car-front-fill";

            <div class="col">
                <label class="card servicio-card d-flex gap-3 flex-row align-items-center px-3 py-2 w-100"
                       style="cursor:pointer; min-height: 150px; max-height: 200px; width: 100%; height: auto;">
                    <input type="checkbox"
                           id="@cid"
                           name="ServiciosAsignados"
                           value="@servicio.SerID"
                           class="form-check-input me-2"
                           @(seleccionado ? "checked" : "") />

                    <div class="d-flex align-items-center gap-3 flex-grow-1">
                        <i class="bi @icon fs-3 text-primary"></i>
                        <div class="text-center flex-grow-1">
                            <h5 class="card-title mb-1">@servicio.SerNom</h5>
                            <p class="m-0 text-muted small">@servicio.SerDesc</p>
                        </div>
                    </div>
                </label>
            </div>
        }
    </div>

    <input type="hidden" name="PlayaID" value="@Model.PlayaID" />

    <div class="d-flex w-100 mt-4 gap-2">
        <button type="submit" class="btn btn-primary flex-fill" id="btnGuardar">Guardar</button>
        <a asp-controller="PlayaEstacionamiento" asp-action="Index" class="btn btn-outline-secondary flex-fill">Cancelar</a>
    </div>
</form>

<!-- Modal de Configuración General de Abono -->
<div class="modal fade" id="modalConfiguracionAbono" tabindex="-1" aria-labelledby="modalConfiguracionAbonoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalConfiguracionAbonoLabel">Configuración general de abono</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3 fw-medium">
                    ¿Cobrar tarifa de estacionamiento si el vehículo permanece después de que vence el abono?
                </p>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="chkCobrarTarifaPostAbono" />
                    <label class="form-check-label" for="chkCobrarTarifaPostAbono">
                        Sí, aplicar tarifa luego de 1 día.
                    </label>
                </div>
                <p class="small text-muted mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    Si se activa, se cobrará al día siguiente si el abono no fue renovado.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarConfiguracion">Guardar</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Tarjeta base */
.servicio-card {
    transition: all .2s ease-in-out;
    border: 1px solid var(--bs-border-color);
    border-radius: .75rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 150px;  /* Altura mínima */
    max-height: 200px;  /* Altura máxima para asegurarse de que no crezca demasiado */
    width: 100%;  /* Asegura que ocupe todo el ancho disponible */
}

/* No seleccionado */
.servicio-card:not(:has(input:checked)) {
    opacity: .6;
    background-color: var(--bs-light);
}

/* Seleccionado */
.servicio-card:has(input:checked) {
    opacity: 1;
    background-color: var(--bs-primary-bg-subtle);
    box-shadow: 0 0 0 .2rem rgba(var(--bs-primary-rgb), .2);
    border-color: rgba(var(--bs-primary-rgb), .5);
}

/* Asegurar que las tarjetas tengan un contenido alineado y consistente */
.card-body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
</style>

@section Scripts {
<script>
  const playaID = @Model.PlayaID;
  const serviciosAbono = [7, 8, 9]; // SerID de servicios de abono
  
  // Fallback para navegadores sin :has()
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.servicio-card').forEach(c => {
      const chk = c.querySelector('input[type="checkbox"]');
      if (!chk) return;
      function sync() {
        if (chk.checked) {
          c.classList.add('is-on');
        } else {
          c.classList.remove('is-on');
        }
      }
      sync();
      chk.addEventListener('change', () => {
        sync();
        verificarServiciosAbono();
      });
    });
    
    // Verificar servicios de abono al cargar
    verificarServiciosAbono();
    
    // Prevenir que se abra el modal si no hay abono seleccionado
    const btnConfig = document.getElementById('btnConfiguracionAbono');
    if (btnConfig) {
      btnConfig.addEventListener('click', function(e) {
        if (btnConfig.disabled) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      });
    }
    
    // Cargar configuración cuando se abre el modal
    const modal = document.getElementById('modalConfiguracionAbono');
    if (modal) {
      modal.addEventListener('show.bs.modal', function () {
        // Solo cargar si el botón no está deshabilitado
        if (!btnConfig || !btnConfig.disabled) {
          cargarConfiguracion();
        }
      });
    }
    
    // Guardar configuración
    const btnGuardarConfig = document.getElementById('btnGuardarConfiguracion');
    if (btnGuardarConfig) {
      btnGuardarConfig.addEventListener('click', guardarConfiguracion);
    }
  });
  
  function verificarServiciosAbono() {
    const btnConfig = document.getElementById('btnConfiguracionAbono');
    if (!btnConfig) return;
    
    // Verificar si algún servicio de abono está seleccionado
    let hayAbonoSeleccionado = false;
    serviciosAbono.forEach(serID => {
      const checkbox = document.getElementById(`ser_${serID}`);
      if (checkbox && checkbox.checked) {
        hayAbonoSeleccionado = true;
      }
    });
    
    // Cambiar el estado del botón según si hay abono seleccionado
    if (hayAbonoSeleccionado) {
      // Habilitado y azul cuando hay abono seleccionado
      btnConfig.disabled = false;
      btnConfig.classList.remove('btn-outline-secondary');
      btnConfig.classList.add('btn-outline-primary');
    } else {
      // Deshabilitado y gris cuando no hay abono seleccionado
      btnConfig.disabled = true;
      btnConfig.classList.remove('btn-outline-primary');
      btnConfig.classList.add('btn-outline-secondary');
    }
  }
  
  function cargarConfiguracion() {
    fetch(`/ServicioProveido/GetConfiguracionAbono?plyID=${playaID}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById('chkCobrarTarifaPostAbono').checked = data.cobrarTarifaPostAbono;
        } else {
          console.error('Error cargando configuración:', data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }
  
  function guardarConfiguracion() {
    const cobrarTarifa = document.getElementById('chkCobrarTarifaPostAbono').checked;
    
    fetch('/ServicioProveido/GuardarConfiguracionAbono', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        PlyID: playaID,
        CobrarTarifaPostAbono: cobrarTarifa
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Cerrar el modal
          const modalEl = bootstrap.Modal.getInstance(document.getElementById('modalConfiguracionAbono'));
          if (modalEl) {
            modalEl.hide();
          }
        } else {
          alert('Error guardando configuración: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar la configuración.');
      });
  }
</script>
}
