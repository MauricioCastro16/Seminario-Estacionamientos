@model IEnumerable<estacionamientos.Models.PlayaEstacionamiento>

@{
    ViewData["Title"] = "Mapa de Estacionamientos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        body { margin:0; padding:0; overflow:hidden; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #mapContainer { position:fixed; top:60px; left:0; width:100vw; height:calc(100vh - 60px); z-index:1; pointer-events:auto; }

        @@media (max-width: 768px){
            .main-footer{ display:none !important; }
            #mapContainer{ height:100vh !important; top:0 !important; }
        }

        .main-content{ background:transparent; padding-top:0; position:relative; z-index:1; }
        .main-header{ background:rgba(255,255,255,.95); backdrop-filter:blur(10px); }
        .main-header, .main-content, .mobile-sidebar, .sidebar-overlay, .navbar, .sidebar{ position:relative !important; z-index:1000 !important; }
        .main-footer, .footer{ position:relative !important; z-index:100 !important; }

        .main-header, .navbar{
            position:fixed !important; top:0 !important; left:0 !important; right:0 !important;
            z-index:10000 !important; background:rgba(255,255,255,.95) !important;
            backdrop-filter:blur(10px) !important; height:60px !important; pointer-events:auto !important;
        }
        .navbar *{ pointer-events:auto !important; }
        .dropdown-menu, .nav-item.dropdown, .user-menu{ z-index:10001 !important; position:relative !important; }
        .dropdown.show .dropdown-menu{ display:block !important; z-index:10001 !important; position:absolute !important; top:100% !important; left:0 !important; }

        .controls{ position:fixed; top:80px; right:20px; z-index:1000; display:flex; flex-direction:column; gap:10px; }
        .search-bar{
            position:fixed; top:80px; left:50%; transform:translateX(-50%); z-index:1000; display:flex; align-items:center;
            background:rgba(255,255,255,.95); border-radius:25px; padding:8px 15px; box-shadow:0 4px 15px rgba(0,0,0,.1); backdrop-filter:blur(10px);
            width:90%; max-width:600px; min-width:280px;
        }
        .search-bar input{ flex:1; border:none; outline:none; background:transparent; padding:8px 12px; font-size:16px; min-width:0; width:100%; }
        .search-bar button{ 
            background:transparent; 
            color:#0d6efd; 
            border:1px solid #0d6efd; 
            border-radius:50%; 
            width:40px; 
            height:40px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            cursor:pointer; 
            margin-left:8px; 
            transition:.3s; 
            flex-shrink:0; 
        }
        .search-bar button:hover{ 
            background:#cfe2ff; 
            color:#0d6efd; 
            border-color:#0d6efd; 
            transform:scale(1.05); 
        }
        .search-bar .home-btn{ 
            background:transparent; 
            color:#0d6efd; 
            border:1px solid #0d6efd; 
        }
        .search-bar .home-btn:hover{ 
            background:#cfe2ff; 
            color:#0d6efd; 
            border-color:#0d6efd; 
        }

        @@media (max-width:768px){
            .search-bar{ width:95%; max-width:500px; padding:6px 12px; top:70px; }
            .search-bar input{ font-size:14px; padding:6px 10px; }
            .search-bar button{ width:36px; height:36px; margin-left:6px; }
            .search-bar .home-btn{ margin-left:4px; }
        }
        @@media (max-width:480px){
            .search-bar{ width:98%; max-width:none; padding:5px 10px; top:65px; border-radius:20px; }
            .search-bar input{ font-size:13px; padding:5px 8px; }
            .search-bar button{ width:32px; height:32px; margin-left:4px; }
        }
        @@media (max-width:360px){
            .search-bar{ width:100%; margin:0 5px; padding:4px 8px; top:60px; }
            .search-bar input{ font-size:12px; padding:4px 6px; }
            .search-bar button{ width:28px; height:28px; margin-left:3px; }
            .search-bar button i{ font-size:12px; }
        }

        .control-btn{ background:rgba(255,255,255,.9); border:none; border-radius:8px; padding:12px; cursor:pointer; font-size:18px; box-shadow:0 2px 10px rgba(0,0,0,.1); transition:.3s; min-width:50px; height:50px; display:flex; align-items:center; justify-content:center; }
        .control-btn:hover{ background:#fff; transform:translateY(-2px); box-shadow:0 4px 15px rgba(0,0,0,.2); }

        .loading{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(255,255,255,.95); padding:20px; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,.1); z-index:1002; display:flex; align-items:center; gap:10px; }
        .spinner{ width:20px; height:20px; border:2px solid #f3f3f3; border-top:2px solid #3498db; border-radius:50%; animation:spin 1s linear infinite; }
        @@keyframes spin{ 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

        #bottomMenu{
            position:fixed; bottom:-100%; left:10px; right:10px; background:#fff; border-radius:20px 20px 0 0; padding:25px;
            box-shadow:0 -4px 20px rgba(0,0,0,.1); z-index:10001; transition:bottom .3s ease; max-height:40vh; overflow-y:auto;
        }
        #bottomMenu.show{ bottom:0; }
        @@media (max-width:768px){
            #bottomMenu{ left:5px; right:5px; padding:20px; max-height:80vh !important; border-radius:15px 15px 0 0; }
        }

        .menu-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .close-btn{ background:none; border:none; font-size:24px; cursor:pointer; color:#666; }
        .info-row{ display:flex; justify-content:space-between; margin-bottom:10px; }
        .info-label{ font-weight:600; color:#333; }
        .info-value{ color:#666; }
        .status-badge{ padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600; }
        .status-badge.open{ background:#d4edda; color:#155724; }
        .status-badge.closed{ background:#f8d7da; color:#721c24; }
        .availability-bar{ width:100%; height:8px; background:#e9ecef; border-radius:4px; overflow:hidden; margin:5px 0; }
        .availability-fill{ height:100%; background:linear-gradient(90deg,#28a745,#ffc107,#dc3545); transition:width .3s; }

        .custom-parking-icon{ background:#3498db; color:#fff; border:2px solid #fff; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; box-shadow:0 2px 8px rgba(0,0,0,.3); cursor:pointer; }
        .custom-parking-icon.available{ background:#28a745; }
        .custom-parking-icon.closed{ background:#95a5a6; }
        .custom-parking-icon.search-result{ background:#dc3545; }
        .search-location-marker{ background:transparent !important; border:none !important; }

        .custom-scale{ position:fixed; bottom:20px; left:20px; background:rgba(255,255,255,.9); border:1px solid #ccc; border-radius:4px; padding:8px 12px; font-size:12px; font-weight:bold; color:#333; z-index:1000; box-shadow:0 2px 4px rgba(0,0,0,.2); backdrop-filter:blur(5px); }
        .scale-line{ height:2px; background:#333; margin:4px 0; position:relative; }
        .scale-line::before, .scale-line::after{ content:''; position:absolute; top:-3px; width:1px; height:8px; background:#333; }
        .scale-line::before{ left:0; } .scale-line::after{ right:0; }

        .custom-parking-icon:hover{ transform:scale(1.2); transition:transform .2s; }
        .simplified-map{ filter:grayscale(20%) contrast(1.1) brightness(1.1); }
        .leaflet-control-container .leaflet-top.leaflet-left,
        .leaflet-control-container .leaflet-top.leaflet-right,
        .leaflet-control-container .leaflet-bottom.leaflet-left,
        .leaflet-control-container .leaflet-bottom.leaflet-right{ display:none; }

        /* ==== Favoritos ==== */
        .favorites-panel{
            position:fixed; top:140px; left:20px; z-index:1000; background:rgba(255,255,255,.97);
            border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.15); width:260px; max-height:50vh; overflow:hidden;
            display:flex; flex-direction:column; font-size:13px;
        }
        .favorites-header{ display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid #eee; }
        .favorite-map-icon{ display:flex; align-items:center; justify-content:center; width:30px; height:30px; border-radius:50%; background:rgba(255,255,255,.95); box-shadow:0 2px 8px rgba(0,0,0,.35); border:2px solid #f1c40f; }
        .favorite-map-icon i{ color:#f1c40f; font-size:18px; }
        .favorites-title{ display:flex; align-items:center; gap:6px; font-weight:600; color:#333; }
        .favorites-title i{ color:#f1c40f; }
        .favorites-toggle{ border:none; background:transparent; cursor:pointer; color:#666; padding:4px; border-radius:50%; }
        .favorites-toggle:hover{ background:#f4f4f4; }
        .favorites-body{ padding:6px 8px 8px 8px; overflow-y:auto; }
        #listaFavoritos{ list-style:none; margin:0; padding:0; }
        .favorite-item{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; gap:4px; }

        .favorite-main-btn{ flex:1; border:none; background:#f8f9fa; border-radius:6px; padding:6px 8px; text-align:left; font-size:12px; cursor:pointer; display:flex; flex-direction:column; }
        .favorite-main-btn span:first-child{ font-weight:600; color:#333; }
        .favorite-main-btn span:last-child{ color:#777; font-size:11px; }
        .favorite-main-btn:hover{ background:#e9ecef; }

        .favorite-view-btn{ 
            border:1px solid #0d6efd; 
            background:transparent; 
            color:#0d6efd; 
            border-radius:6px; 
            width:28px; 
            height:28px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            cursor:pointer; 
            flex-shrink:0; 
            font-size:12px; 
        }
        .favorite-view-btn:hover{ 
            background:#cfe2ff; 
            color:#0d6efd; 
            border-color:#0d6efd; 
        }

        .favorite-edit-btn{ 
            border:1px solid #0d6efd; 
            background:transparent; 
            color:#0d6efd; 
            border-radius:6px; 
            width:28px; 
            height:28px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            cursor:pointer; 
            flex-shrink:0; 
            font-size:12px; 
        }
        .favorite-edit-btn:hover{ 
            background:#cfe2ff; 
            color:#0d6efd; 
            border-color:#0d6efd; 
        }

        .favorite-remove-btn{ 
            border:1px solid #0d6efd; 
            background:transparent; 
            color:#0d6efd; 
            border-radius:6px; 
            width:28px; 
            height:28px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            cursor:pointer; 
            flex-shrink:0; 
            font-size:12px; 
        }
        .favorite-remove-btn:hover{ 
            background:#cfe2ff; 
            color:#0d6efd; 
            border-color:#0d6efd; 
        }

        .favorites-empty{ font-size:11px; color:#777; padding:4px 2px; }
        .favorites-panel.collapsed{ max-height:44px; }
        .favorites-panel.collapsed .favorites-body{ display:none; }
        
        /* Estilo para bot√≥n de eliminar favorito - azul/celeste */
        .btn-eliminar-favorito{ 
            background:#0d6efd; 
            color:#fff; 
            border:none; 
        }
        .btn-eliminar-favorito:hover{ 
            background:#0b5ed7; 
            color:#fff; 
        }
        .btn-eliminar-favorito:active{ 
            background:#0a58ca; 
            color:#fff; 
        }
        
        /* Estilo para bot√≥n de favorito - azul/celeste outline */
        .btn-favorito-azul{
            background:transparent;
            color:#0d6efd;
            border:1px solid #0d6efd;
        }
        .btn-favorito-azul:hover{
            background:#cfe2ff;
            color:#0d6efd;
            border-color:#0b5ed7;
        }
        .btn-favorito-azul:active{
            background:#9ec5fe;
            color:#0a58ca;
            border-color:#0a58ca;
        }
        
        @@media (max-width:768px){
            .favorites-panel{ top:140px; left:10px; right:auto; width:260px; max-height:50vh; display:flex; }
        }

        /* Bot√≥n de favoritos en la barra */
        .fav-btn{ background:#f1c40f; color:#fff; border:none; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; margin-left:5px; cursor:pointer; flex-shrink:0; }
        .fav-btn i{ font-size:16px; }

        /* Badge de filtro aplicado */
        .filter-badge{
            position:fixed; 
            top:140px; 
            left:50%; 
            transform:translateX(-50%); 
            z-index:1000; 
            display:flex; 
            align-items:center; 
            gap:8px; 
            background:#cfe2ff; 
            border:1px solid #0d6efd; 
            border-radius:20px; 
            padding:8px 12px; 
            box-shadow:0 2px 8px rgba(13,110,253,.2); 
            backdrop-filter:blur(10px);
            font-size:14px;
            color:#0d6efd;
            max-width:90%;
        }

        .filter-badge i.fa-filter{ font-size:12px; }
        .filter-badge span{ flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:300px; }
        .filter-close-btn{
            background:transparent;
            border:none;
            color:#0d6efd;
            cursor:pointer;
            padding:2px 4px;
            border-radius:50%;
            width:20px;
            height:20px;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:.2s;
        }
        .filter-close-btn:hover{
            background:#9ec5fe;
            color:#0b5ed7;
        }
        .filter-close-btn i{ font-size:10px; }
        
        @@media (max-width:768px){
            .filter-badge{ top:130px; font-size:12px; padding:6px 10px; }
            .filter-badge span{ max-width:200px; }
        }
    </style>
</head>
<body>
    @Html.AntiForgeryToken()

    <div id="mapContainer"></div>

    <!-- Panel de favoritos -->
    <div class="favorites-panel" id="favoritesPanel">
        <div class="favorites-header">
            <div class="favorites-title">
                <i class="fa-solid fa-star"></i>
                <span>Favoritos</span>
            </div>
            <button class="favorites-toggle" type="button" onclick="toggleFavorites()">
                <i class="fa-solid fa-chevron-down" id="favoritesToggleIcon"></i>
            </button>
        </div>
        <div class="favorites-body">
            <ul id="listaFavoritos"></ul>
            <div class="favorites-empty" id="favoritosVacio">
                A√∫n no agregaste playas favoritas.<br />
                Toc√° una playa en el mapa y us√° ‚òÖ para guardarla.
            </div>
        </div>
    </div>

    <!-- Barra de b√∫squeda -->
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Buscar direcci√≥n..." />
        <button onclick="buscarDireccion()" id="btnBuscar" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Buscar"><i class="fa-solid fa-magnifying-glass"></i></button>
        <button class="home-btn" onclick="centerOnConductor()" id="btnHome" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Reubicar mapa"><i class="fa-solid fa-house"></i></button>
        <button class="fav-btn" id="favBtn" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Ubicaciones favoritas"><i class="fa-solid fa-star"></i></button>
    </div>

    <!-- Indicador de filtro aplicado -->
    <div class="filter-badge" id="filterBadge" style="display:none;">
        <i class="fa-solid fa-filter"></i>
        <span id="filterText"></span>
        <button class="filter-close-btn" onclick="limpiarBusqueda()" title="Quitar filtro">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>

    <div class="loading" id="loading"><div class="spinner"></div>Cargando mapa...</div>

    <div class="custom-scale" id="customScale">
        <div id="scaleText">1 km</div>
        <div class="scale-line" id="scaleLine"></div>
    </div>

    <div id="bottomMenu">
        <div class="menu-header">
            <div style="display:flex; align-items:center; gap:15px; flex:1;">
                <h4 id="playaNombre" style="margin:0; flex:1;">Selecciona una playa</h4>
                <div id="serviciosIconos" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;"></div>
            </div>
            <button class="close-btn" onclick="closeMenu()">√ó</button>
        </div>
        <div id="playaInfo" style="display:none;">
            <div class="info-row"><span class="info-label">Estado:</span><span class="status-badge" id="estadoBadge">Abierto</span></div>
            <div class="info-row"><span class="info-label">Ocupaci√≥n:</span><span class="info-value" id="disponibilidadTexto">15% ocupado</span></div>
            <div class="availability-bar"><div class="availability-fill" id="disponibilidadBarra" style="width:85%"></div></div>
            <div class="info-row"><span class="info-label">Tipo de piso:</span><span class="info-value" id="tipoPiso">Hormig√≥n</span></div>
            <div class="info-row"><span class="info-label">Direcci√≥n:</span><span class="info-value" id="direccion">Av. Principal 123</span></div>
            <div class="info-row"><span class="info-label">Valor promedio:</span><span class="info-value" id="valorPromedio">$500/hora</span></div>
            <div class="info-row mt-3" id="horariosSection" style="display:none;"><span class="info-label">Horarios de atenci√≥n:</span><div class="info-value" id="horariosInfo" style="font-size:.9em;"></div></div>
            <div class="info-row mt-3" id="tarifasSection" style="display:none; flex-direction:column; align-items:flex-start;">
                <span class="info-label" style="margin-bottom:8px;">Tarifas:</span>
                <div class="info-value" id="tarifasInfo" style="font-size:.9em; width:100%;"></div>
            </div>
            <div class="info-row mt-2" id="debugInfoSection" style="display:none; font-size:.8em; color:#666;"><div id="debugInfo"></div></div>
            <button class="btn btn-primary w-100 mt-3" onclick="abrirNavegacion()"><i class="bi bi-navigation me-2"></i>Ver en Google Maps</button>
        </div>
        <div id="valoracionesInfo" style="display:none;">
            <div id="valoracionesContent">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet & libs -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let map, playas = [], playaSeleccionada = null;
        let favoriteMarkers = [], conductorMarker, parkingMarkers = [];
        let searchResults = [], isSearchMode = false, searchLocationMarker = null, customScale = null;

        let favoritos = [], antiforgeryToken = null;
        let playaIdToMarker = new Map();
        let transientPopup = null; // popup temporal cuando no hay marker

        // Fallback Resistencia
        let conductorLat = -27.451000, conductorLon = -58.986000;
        let vehiculoFavorito = null;

        $(document).ready(function () {
            antiforgeryToken = $('input[name="__RequestVerificationToken"]').val();
            obtenerVehiculoSeleccionado();
            inicializarMapa();
            cargarUbicacionesFavoritas();

            // tooltips
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

            // Enter en b√∫squeda
            $('#searchInput').keypress(function(e){ if(e.which === 13) buscarDireccion(); });

            // ‚≠ê abre panel (mobile y desktop)
            document.getElementById('favBtn')?.addEventListener('click', openFavoritesFromStar);

            // sync veh√≠culo si cambia en otra pesta√±a
            window.addEventListener('storage', function(e){
                if (e.key === 'vehiculoSeleccionado' && e.newValue) {
                    vehiculoFavorito = JSON.parse(e.newValue);
                    if (conductorMarker) conductorMarker.setIcon(crearIconoConductor());
                }
            });
        });

        function openFavoritesFromStar(){
            const panel = document.getElementById('favoritesPanel');
            const icon  = document.getElementById('favoritesToggleIcon');
            panel.classList.remove('collapsed');
            if (icon){ icon.classList.remove('fa-chevron-up'); icon.classList.add('fa-chevron-down'); }
        }

        function obtenerVehiculoSeleccionado(){
            const guardado = sessionStorage.getItem('vehiculoSeleccionado');
            if (guardado){ vehiculoFavorito = JSON.parse(guardado); return; }
            $.get('/Conductor/GetVehiculoSeleccionado')
             .done(d => { if(!d.error){ vehiculoFavorito = d; sessionStorage.setItem('vehiculoSeleccionado', JSON.stringify(d)); }})
             .fail(() => vehiculoFavorito = null);
        }

        function crearIconoConductor(){
            let imagenUrl = '/estacionamientos/Resources/Map/auto.png';
            if (vehiculoFavorito?.tipo){
                const t = vehiculoFavorito.tipo.toLowerCase();
                if (t.includes('camioneta') || t.includes('suv')) imagenUrl = '/estacionamientos/Resources/Map/camioneta.png';
                else if (t.includes('moto')) imagenUrl = '/estacionamientos/Resources/Map/moto.png';
                else if (t.includes('camion')) imagenUrl = '/estacionamientos/Resources/Map/suv.png';
            }
            return L.divIcon({
                className:'conductor-marker',
                html:`<div style="background:#fff;border:3px solid #3498db;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,.3);overflow:hidden;"><img src="${imagenUrl}" style="width:40px;height:40px;object-fit:contain" alt="Veh√≠culo"></div>`,
                iconSize:[50,50], iconAnchor:[25,25]
            });
        }

        function inicializarMapa(){
            map = L.map('mapContainer', { zoomControl:false, scrollWheelZoom:true, doubleClickZoom:true, boxZoom:true, keyboard:true, dragging:true, touchZoom:true, attributionControl:false, minZoom:12 });
            L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{ attribution:'&copy; OpenStreetMap & CARTO'}).addTo(map);
            L.control.zoom({ position:'topright' }).addTo(map);

            if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const { latitude:lat, longitude:lon } = pos.coords;
                        map.setView([lat, lon], 16);
                        conductorMarker = L.marker([lat, lon], { icon:crearIconoConductor() }).addTo(map).bindPopup('<b>Tu ubicaci√≥n</b><br>Ubicaci√≥n detectada').openPopup();
                        conductorLat = lat; conductorLon = lon;
                        cargarPlayas(); inicializarEscalaPersonalizada();
                    },
                    () => fallbackMapa(),
                    { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
                );
            } else fallbackMapa();

            function fallbackMapa(){
                map.setView([conductorLat, conductorLon], 14);
                conductorMarker = L.marker([conductorLat, conductorLon], { icon:crearIconoConductor() }).addTo(map).bindPopup('<b>Tu ubicaci√≥n</b><br>Resistencia, Chaco').openPopup();
                cargarPlayas(); inicializarEscalaPersonalizada();
            }
        }

        function cargarPlayas(){
            $('#loading').show();
            
            // Primero obtener el tipo de veh√≠culo
            $.get('/Conductor/GetVehiculoSeleccionado')
             .done(vehiculoData => {
                 const tipoVehiculo = vehiculoData?.tipo || null;
                 
                 // Cargar todas las playas
                 $.get('/Conductor/GetPlayasCercanas', { lat:conductorLat, lon:conductorLon, radioKm:50 })
                  .done(data => {
                      const todasLasPlayas = data || [];
                      
                      if (!tipoVehiculo) {
                          // Si no hay tipo de veh√≠culo, mostrar todas las playas
                          playas = todasLasPlayas;
                          mostrarPlayasEnMapa();
                          $('#loading').hide();
                          return;
                      }
                      
                      // Filtrar playas que tienen servicios/tarifas para el tipo de veh√≠culo
                      filtrarPlayasPorTipoVehiculo(todasLasPlayas, tipoVehiculo);
                  })
                  .fail((_,__,err)=> $('#loading').html('<div class="spinner"></div>Error al cargar playas: ' + err));
             })
             .fail(() => {
                 // Si no se puede obtener el veh√≠culo, mostrar todas las playas
                 $.get('/Conductor/GetPlayasCercanas', { lat:conductorLat, lon:conductorLon, radioKm:50 })
                  .done(data => { playas = data || []; mostrarPlayasEnMapa(); $('#loading').hide(); })
                  .fail((_,__,err)=> $('#loading').html('<div class="spinner"></div>Error al cargar playas: ' + err));
             });
        }
        
        function filtrarPlayasPorTipoVehiculo(todasLasPlayas, tipoVehiculo){
            if (todasLasPlayas.length === 0) {
                playas = [];
                mostrarPlayasEnMapa();
                $('#loading').hide();
                return;
            }
            
            let playasFiltradas = [];
            let verificadas = 0;
            
            todasLasPlayas.forEach((playa, index) => {
                // Verificar si la playa tiene servicios/tarifas para el tipo de veh√≠culo
                $.get('/Conductor/GetTarifasYServicios', { id: playa.plyID, tipoVehiculo: tipoVehiculo })
                 .done(data => {
                     if (data && !data.error && data.servicios && data.servicios.length > 0) {
                         // Verificar que tenga al menos un servicio con tarifas para el tipo de veh√≠culo
                         const serviciosConTarifas = data.servicios.filter(s => {
                             if (!s.tarifas || s.tarifas.length === 0) return false;
                             return s.tarifas.some(t => t.clasificacionVehiculo === tipoVehiculo);
                         });
                         
                         if (serviciosConTarifas.length > 0) {
                             playasFiltradas.push(playa);
                         }
                     }
                     
                     verificadas++;
                     
                     // Cuando se hayan verificado todas las playas, mostrar las filtradas
                     if (verificadas === todasLasPlayas.length) {
                         playas = playasFiltradas;
                         mostrarPlayasEnMapa();
                         $('#loading').hide();
                     }
                 })
                 .fail(() => {
                     verificadas++;
                     if (verificadas === todasLasPlayas.length) {
                         playas = playasFiltradas;
                         mostrarPlayasEnMapa();
                         $('#loading').hide();
                     }
                 });
            });
        }

        function crearIconoPlaya(playa, esResultadoBusqueda=false){
            let className = 'custom-parking-icon';
            if (esResultadoBusqueda) className += ' search-result';
            else if (!playa.estaAbierto) className += ' closed';
            else if (playa.disponibilidad > 50) className += ' available';
            return L.divIcon({ className, html:'P', iconSize:[30,30], iconAnchor:[15,15] });
        }

        function mostrarPlayasEnMapa(){
            parkingMarkers.forEach(m => map.removeLayer(m));
            parkingMarkers = [];
            playaIdToMarker.clear();

            const playasAMostrar = isSearchMode ? searchResults : playas;

            playasAMostrar.forEach(playa => {
                if (playa.plyLat == null || playa.plyLon == null || isNaN(playa.plyLat) || isNaN(playa.plyLon)){
                    console.warn(`Coordenadas inv√°lidas para ${playa.plyNom}: lat=${playa.plyLat}, lon=${playa.plyLon}`);
                    return;
                }

                const icon = crearIconoPlaya(playa, isSearchMode);
                const marker = L.marker([playa.plyLat, playa.plyLon], { icon }).addTo(map);

                const favorito = esFavorita(playa);
                const botonFavorito = favorito 
                    ? `<button class="btn btn-sm btn-eliminar-favorito flex-fill" onclick="window.eliminarFavoritaDesdePopup('${favorito.apodo}', ${playa.plyID})">Eliminar favorito</button>`
                    : `<button class="btn btn-sm btn-favorito-azul flex-fill" onclick="window.agregarFavoritaDesdePopup(${playa.plyID})">‚òÖ Favorito</button>`;
                
                const popupContent = `
                  <div style="min-width:220px;">
                    <h6 style="margin:0 0 10px;color:#2c3e50;">${playa.plyNom}</h6>
                    <p style="margin:5px 0;font-size:14px;"><strong>Direcci√≥n:</strong> ${playa.plyDir}</p>
                    <p style="margin:5px 0;font-size:14px;"><strong>Disponibilidad:</strong> ${playa.disponibilidad}%</p>
                    <p style="margin:5px 0;font-size:14px;"><strong>Estado:</strong> ${playa.estaAbierto ? 'Abierto' : 'Cerrado'}</p>
                    ${isSearchMode ? `<p style="margin:5px 0;font-size:14px;color:#dc3545;"><strong>üìç Distancia:</strong> ${Number(playa.distancia||0).toFixed(2)} km</p>` : ''}
                    ${isSearchMode ? '<p style="margin:5px 0;font-size:12px;color:#dc3545;font-weight:bold;">üîç Uno de los 3 m√°s cercanos</p>' : ''}
                    <div class="d-flex gap-1 mt-2 flex-wrap">
                      <button class="btn btn-sm btn-primary flex-fill" onclick="window.seleccionarPlayaDesdePopup(${playa.plyID})">Ver detalles</button>
                      <button class="btn btn-sm btn-primary flex-fill" onclick="window.abrirValoraciones(${playa.plyID}, '${playa.plyNom}')">Valoraciones</button>
                      ${botonFavorito}
                    </div>
                  </div>`;
                marker.bindPopup(popupContent);

                marker.on('click', () => seleccionarPlaya(playa));
                marker.on('popupopen', () => console.log('üìã Popup abierto para:', playa.plyNom));

                if (playa.plyID != null) playaIdToMarker.set(playa.plyID, marker);

                parkingMarkers.push(marker);
            });
        }

        function openMarkerPopup(playaLike){
            // Intenta abrir el popup del marker existente
            const marker = playaIdToMarker.get(playaLike?.plyID);
            if (marker){ marker.openPopup(); return; }

            // Si no hay marker (p.ej. vino de favorito aislado), muestra popup temporal
            if (transientPopup) map.closePopup(transientPopup);
            const nombre = playaLike?.plyNom || playaLike?.apodo || 'Ubicaci√≥n';
            const dir = playaLike?.plyDir || playaLike?.direccion || '';
            transientPopup = L.popup({ closeOnClick:true, autoClose:true })
                .setLatLng([playaLike.plyLat || playaLike.lat, playaLike.plyLon || playaLike.lon])
                .setContent(`<strong>${nombre}</strong><br>${dir}`)
                .openOn(map);
        }

        // Mostrar favoritos con ‚≠ê
        function crearIconoFavorito(){
            return L.divIcon({ className:'favorite-map-icon', html:'<i class="fa-solid fa-star"></i>', iconSize:[30,30], iconAnchor:[15,15] });
        }

        function mostrarFavoritosEnMapa(){
            favoriteMarkers.forEach(m => map.removeLayer(m));
            favoriteMarkers = [];
            if (!favoritos?.length) return;

            favoritos.forEach(fav => {
                const lat = parseFloat(fav.lat ?? fav.ubfLat ?? fav.UbfLat);
                const lon = parseFloat(fav.lon ?? fav.ubfLon ?? fav.UbfLon);
                if (isNaN(lat) || isNaN(lon)) return;

                const marker = L.marker([lat, lon], { icon:crearIconoFavorito(), zIndexOffset:500 })
                    .addTo(map)
                    .bindPopup(`<strong>${fav.apodo}</strong><br>${fav.direccion || fav.ciudad || ''}`);

                marker.on('click', () => irAFavorito(fav));
                favoriteMarkers.push(marker);
            });
        }

        // Funci√≥n para verificar si una playa es favorita
        function esFavorita(playa){
            if (!favoritos?.length || !playa?.plyLat || !playa?.plyLon) return null;
            const playaLat = parseFloat(playa.plyLat);
            const playaLon = parseFloat(playa.plyLon);
            if (isNaN(playaLat) || isNaN(playaLon)) return null;
            
            // Buscar favorito por coordenadas (con tolerancia de 0.0001 grados, aprox 11 metros)
            const favorito = favoritos.find(fav => {
                const favLat = parseFloat(fav.lat ?? fav.ubfLat ?? fav.UbfLat);
                const favLon = parseFloat(fav.lon ?? fav.ubfLon ?? fav.UbfLon);
                if (isNaN(favLat) || isNaN(favLon)) return false;
                return Math.abs(favLat - playaLat) < 0.0001 && Math.abs(favLon - playaLon) < 0.0001;
            });
            return favorito || null;
        }

        // === Helpers del popup de la playa ===
        window.seleccionarPlayaDesdePopup = function (plyID) {
        const playa = playas.find(p => p.plyID === plyID);
        if (!playa) return;

        // Abrir el popup del marcador si existe
        const mk = playaIdToMarker.get(plyID);
        if (mk) mk.openPopup();

        // Mostrar el detalle en el footer
        seleccionarPlaya(playa);
        };

        window.agregarFavoritaDesdePopup = function(plyID){
            const playa = playas.find(p => p.plyID === plyID);
            if (!playa) return alert('No se pudo guardar la playa como favorita.');
            const apodo = prompt('¬øC√≥mo quer√©s llamar a esta playa favorita?', playa.plyNom);
            if (apodo == null || apodo.trim() === '') return;
            const payload = { apodo: apodo.trim(), provincia: playa.plyProv || '', ciudad: playa.plyCiu || '', direccion: playa.plyDir || '', tipo:'Playa', lat: playa.plyLat, lon: playa.plyLon };
            guardarUbicacionFavorita(payload).then(() => {
                cargarUbicacionesFavoritas().then(() => {
                    // Actualizar el popup del marcador para mostrar el bot√≥n de eliminar
                    const marker = playaIdToMarker.get(plyID);
                    if (marker) {
                        const playaActualizada = playas.find(p => p.plyID === plyID);
                        if (playaActualizada) {
                            marker.setPopupContent(buildPopupContent(playaActualizada, isSearchMode));
                        }
                    }
                });
            });
        };

        window.eliminarFavoritaDesdePopup = function(apodo, plyID){
            if (!confirm(`¬øEliminar "${apodo}" de tus favoritos?`)) return;
            
            $.ajax({
                url: '@Url.Action("EliminarUbicacionFavorita", "Conductor")' + '?apodo=' + encodeURIComponent(apodo),
                type: 'DELETE'
            })
            .done(function(data) {
                if (data.success) {
                    favoritos = favoritos.filter(f => f.apodo !== apodo);
                    refreshFavoritesUI();
                    
                    // Actualizar el popup del marcador para mostrar el bot√≥n de agregar
                    const marker = playaIdToMarker.get(plyID);
                    if (marker) {
                        const playa = playas.find(p => p.plyID === plyID);
                        if (playa) {
                            marker.setPopupContent(buildPopupContent(playa, isSearchMode));
                        }
                    }
                    
                    alert('Ubicaci√≥n favorita eliminada correctamente.');
                } else {
                    alert(data.error || 'No se pudo eliminar el favorito.');
                }
            })
            .fail(function() {
                alert('Ocurri√≥ un error al eliminar el favorito.');
            });
        };

        function buildPopupContent(playa, esResultadoBusqueda = false){
            const favorito = esFavorita(playa);
            const botonFavorito = favorito 
                ? `<button class="btn btn-sm btn-eliminar-favorito flex-fill" onclick="window.eliminarFavoritaDesdePopup('${favorito.apodo}', ${playa.plyID})">Eliminar favorito</button>`
                : `<button class="btn btn-sm btn-favorito-azul flex-fill" onclick="window.agregarFavoritaDesdePopup(${playa.plyID})">‚òÖ Favorito</button>`;
            
            return `
                <div style="min-width:220px;">
                    <h6 style="margin:0 0 10px;color:#2c3e50;">${playa.plyNom}</h6>
                    <p style="margin:5px 0;font-size:14px;"><strong>Direcci√≥n:</strong> ${playa.plyDir || ''}</p>
                    <p style="margin:5px 0;font-size:14px;"><strong>Disponibilidad:</strong> ${playa.disponibilidad ?? '‚Äî'}%</p>
                    <p style="margin:5px 0;font-size:14px;"><strong>Estado:</strong> ${playa.estaAbierto ? 'Abierto' : 'Cerrado'}</p>
                    ${esResultadoBusqueda && typeof playa.distancia === 'number' ? `
                        <p style="margin:5px 0;font-size:14px;color:#dc3545;"><strong>üìç Distancia:</strong> ${playa.distancia.toFixed(2)} km</p>
                        <p style="margin:5px 0;font-size:12px;color:#dc3545;font-weight:bold;">üîç Uno de los 3 m√°s cercanos</p>
                    ` : ''}

                    <div class="d-flex gap-1 mt-2 flex-wrap">
                        <button class="btn btn-sm btn-primary flex-fill" onclick="window.seleccionarPlayaDesdePopup(${playa.plyID})">Ver detalles</button>
                        <button class="btn btn-sm btn-primary flex-fill" onclick="window.abrirValoraciones(${playa.plyID}, '${playa.plyNom}')">Valoraciones</button>
                        ${botonFavorito}
                    </div>
                </div>
            `;
        }

        function seleccionarPlaya(playa){
            playaSeleccionada = playa;
            map.setView([playa.plyLat, playa.plyLon], 16);

            // Asegurar que se muestren los detalles, no las valoraciones
            $('#valoracionesInfo').hide();
            $('#playaInfo').show();

            $.get('/Conductor/GetDetallePlaya', { id: playa.plyID })
             .done(detalle => {
                 mostrarDetallePlaya(detalle);
                 cargarTarifasYServicios(playa.plyID);
                 $('#bottomMenu').addClass('show');
                 // abrir popup (marker o temporal)
                 openMarkerPopup({ ...detalle, plyLat: detalle.plyLat ?? playa.plyLat, plyLon: detalle.plyLon ?? playa.plyLon });
             })
             .fail(() => {
                 mostrarDetallePlayaBasico(playa);
                 cargarTarifasYServicios(playa.plyID);
                 $('#bottomMenu').addClass('show');
                 openMarkerPopup(playa);
             });
        }

        function mostrarDetallePlaya(detalle){
            $('#playaNombre').text(detalle.plyNom);
            $('#estadoBadge').text(detalle.estaAbierto ? 'Abierto' : 'Cerrado').removeClass('open closed').addClass(detalle.estaAbierto ? 'open' : 'closed');
            const ocupacion = 100 - detalle.disponibilidad;
            $('#disponibilidadTexto').text(ocupacion + '% ocupado'); $('#disponibilidadBarra').css('width', ocupacion + '%');
            $('#tipoPiso').text(detalle.plyTipoPiso); $('#direccion').text(detalle.plyDir);
            $('#valorPromedio').text('$' + (parseFloat(detalle.plyValProm || 0).toFixed(2)) + '/hora');

            let horariosHtml = '<div style="margin-top:5px;">', tiene=false;
            if (detalle.horariosLunesViernes?.length){ tiene=true; horariosHtml += '<div style="margin-bottom:5px;"><strong>Lunes a Viernes:</strong> ' + detalle.horariosLunesViernes.map(h=>`${h.horaInicio} - ${h.horaFin}`).join(', ') + '</div>'; }
            if (detalle.horariosFinSemana?.length){ tiene=true; horariosHtml += '<div style="margin-bottom:5px;"><strong>S√°bado Domingo:</strong> ' + detalle.horariosFinSemana.map(h=>`${h.horaInicio} - ${h.horaFin}`).join(', ') + '</div>'; }
            horariosHtml += '</div>';
            $('#horariosInfo').html(tiene ? horariosHtml : '<span style="color:#dc3545;">No hay horarios configurados</span>');
            $('#horariosSection').show(); $('#debugInfoSection').hide(); $('#playaInfo').show();
        }

        function cargarTarifasYServicios(plyID){
            // Obtener el tipo de veh√≠culo del cliente
            $.get('/Conductor/GetVehiculoSeleccionado')
             .done(vehiculoData => {
                 const tipoVehiculo = vehiculoData?.tipo || null;
                 
                 if (!tipoVehiculo) {
                     $('#tarifasInfo').html('<span style="color:#dc3545;">No se pudo obtener el tipo de veh√≠culo. Por favor selecciona un veh√≠culo.</span>');
                     $('#serviciosIconos').html('');
                     $('#tarifasSection').show();
                     return;
                 }
                 
                 $.get('/Conductor/GetTarifasYServicios', { id: plyID, tipoVehiculo: tipoVehiculo })
                  .done(data => {
                      if (data && !data.error && data.servicios){
                          // El backend ya filtra por tipo de veh√≠culo, pero validamos nuevamente en el frontend
                          // Filtrar servicios que tienen tarifas EXACTAMENTE para el tipo de veh√≠culo del conductor
                          const serviciosConTarifas = data.servicios
                              .map(servicio => {
                                  // Filtrar solo las tarifas del tipo de veh√≠culo del conductor
                                  const tarifasFiltradas = servicio.tarifas 
                                      ? servicio.tarifas.filter(t => t.clasificacionVehiculo === tipoVehiculo)
                                      : [];
                                  
                                  return {
                                      ...servicio,
                                      tarifas: tarifasFiltradas
                                  };
                              })
                              .filter(s => s.tarifas && s.tarifas.length > 0); // Solo servicios con tarifas del tipo de veh√≠culo
                          
                          if (serviciosConTarifas.length > 0) {
                              mostrarTarifas(serviciosConTarifas, tipoVehiculo);
                              mostrarServicios(serviciosConTarifas);
                          } else {
                              $('#tarifasInfo').html('<span style="color:#dc3545;">No hay tarifas disponibles para tu tipo de veh√≠culo (' + tipoVehiculo + ')</span>');
                              $('#serviciosIconos').html('');
                              $('#tarifasSection').show();
                          }
                      } else {
                          $('#tarifasInfo').html('<span style="color:#dc3545;">No hay tarifas disponibles para tu tipo de veh√≠culo</span>');
                          $('#serviciosIconos').html('');
                          $('#tarifasSection').show();
                      }
                  })
                  .fail(() => {
                      $('#tarifasInfo').html('<span style="color:#dc3545;">Error al cargar tarifas</span>');
                      $('#serviciosIconos').html('');
                      $('#tarifasSection').show();
                  });
             })
             .fail(() => {
                 $('#tarifasInfo').html('<span style="color:#dc3545;">No se pudo obtener el tipo de veh√≠culo. Por favor selecciona un veh√≠culo.</span>');
                 $('#serviciosIconos').html('');
                 $('#tarifasSection').show();
             });
        }

        function mostrarTarifas(servicios, tipoVehiculo){
            // Filtrar tarifas por tipo de veh√≠culo - SOLO mostrar las del tipo del conductor
            if (!tipoVehiculo) {
                $('#tarifasInfo').html('<span style="color:#dc3545;">No se pudo obtener el tipo de veh√≠culo</span>');
                $('#tarifasSection').show();
                return;
            }
            
            const serviciosFiltrados = servicios.map(servicio => {
                if (servicio.tarifas && servicio.tarifas.length > 0) {
                    // Filtrar SOLO las tarifas que corresponden al tipo de veh√≠culo del conductor
                    const tarifasFiltradas = servicio.tarifas.filter(t => t.clasificacionVehiculo === tipoVehiculo);
                    return {
                        ...servicio,
                        tarifas: tarifasFiltradas
                    };
                }
                return null; // Excluir servicios sin tarifas
            }).filter(s => s !== null && s.tarifas && s.tarifas.length > 0); // Solo servicios con tarifas del tipo de veh√≠culo
            
            if (serviciosFiltrados.length === 0){
                $('#tarifasInfo').html('<span style="color:#dc3545;">No hay tarifas configuradas para tu tipo de veh√≠culo</span>');
                $('#tarifasSection').show();
                return;
            }
            
            const serviciosConTarifas = serviciosFiltrados;

            // Agrupar servicios por tipo
            const serviciosPorTipo = {};
            serviciosConTarifas.forEach(servicio => {
                const tipo = servicio.serTipo || 'Otros';
                if (!serviciosPorTipo[tipo]) {
                    serviciosPorTipo[tipo] = [];
                }
                serviciosPorTipo[tipo].push(servicio);
            });

            let tarifasHtml = '<div class="accordion" id="accordionTarifas" style="margin-top:5px;">';
            
            // Crear lista desplegable para cada tipo
            Object.keys(serviciosPorTipo).forEach((tipo, index) => {
                const serviciosDelTipo = serviciosPorTipo[tipo];
                const tipoId = 'tarifas-' + tipo.replace(/\s+/g, '-').toLowerCase();
                
                tarifasHtml += `
                    <div class="accordion-item" style="border:1px solid #dee2e6; border-radius:8px; margin-bottom:8px;">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" onclick="toggleTarifaAccordion('${tipoId}')" style="background:#cfe2ff !important; color:#0d6efd !important; font-weight:600; padding:10px 15px; box-shadow:none; width:100%; text-align:left; border:none;">
                                ${tipo}
                            </button>
                        </h2>
                        <div id="${tipoId}" class="accordion-collapse collapse">
                            <div class="accordion-body" style="padding:15px;">
                                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:8px; justify-items:start;">
                `;
                
                serviciosDelTipo.forEach(servicio => {
                    const duracion = servicio.serDuracionMinutos 
                        ? servicio.serDuracionMinutos >= 60 
                            ? `${Math.round(servicio.serDuracionMinutos / 60)}h`
                            : `${servicio.serDuracionMinutos}min`
                        : '';
                    
                    servicio.tarifas.forEach(tarifa => {
                        tarifasHtml += `
                            <div class="tarifa-card" style="
                                background-color: #ffffff;
                                border: 1px solid rgba(13, 110, 253, 0.5);
                                border-radius: 0.75rem;
                                padding: 8px 10px;
                                min-height: 70px;
                                display: flex;
                                flex-direction: column;
                                justify-content: center;
                                align-items: center;
                                text-align: center;
                                box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.2);
                                transition: all 0.2s ease-in-out;
                            ">
                                <div style="font-size: 0.75em; color: #0d6efd; font-weight: 600; margin-bottom: 4px; line-height: 1.2;">
                                    ${servicio.serNom}
                                </div>
                                ${duracion ? `<div style="font-size: 0.7em; color: #666; margin-bottom: 4px;">${duracion}</div>` : ''}
                                <div style="font-size: 0.7em; color: #666; margin-bottom: 2px;">${tarifa.clasificacionVehiculo}</div>
                                <div style="font-size: 0.85em; color: #0d6efd; font-weight: 700;">
                                    $${parseFloat(tarifa.monto).toFixed(2)}
                                </div>
                            </div>
                        `;
                    });
                });
                
                tarifasHtml += `
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            tarifasHtml += '</div>';
            
            $('#tarifasInfo').html(tarifasHtml);
            $('#tarifasSection').show();
        }

        function toggleTarifaAccordion(tipoId){
            const collapseElement = document.getElementById(tipoId);
            const button = collapseElement.previousElementSibling.querySelector('.accordion-button');
            
            if (collapseElement.classList.contains('show')) {
                collapseElement.classList.remove('show');
                button.classList.add('collapsed');
                button.setAttribute('aria-expanded', 'false');
            } else {
                collapseElement.classList.add('show');
                button.classList.remove('collapsed');
                button.setAttribute('aria-expanded', 'true');
            }
        }

        function obtenerIconoServicio(serID){
            // Mapeo de iconos seg√∫n SerID (igual que en Servicios.cshtml)
            if (serID == 1) return 'bi-bucket-fill';
            else if (serID == 2) return 'bi-wrench';
            else if (serID == 3) return 'bi-fuel-pump';
            else if (serID == 4) return 'bi-bookmark-check-fill';
            else if (serID >= 5 && serID <= 9) return 'bi-car-front-fill';
            else return 'bi-cart-check-fill'; // Icono predeterminado
        }

        function mostrarServicios(servicios){
            if (!servicios || servicios.length === 0){
                $('#serviciosIconos').html('');
                return;
            }

            // Mostrar iconos en el header
            let iconosHtml = '';
            servicios.forEach(servicio => {
                const icono = obtenerIconoServicio(servicio.serID);
                iconosHtml += `
                    <div style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 8px 10px;
                        background-color: #cfe2ff;
                        border: 1px solid rgba(13, 110, 253, 0.5);
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s ease-in-out;
                    " title="${servicio.serNom}" data-bs-toggle="tooltip" data-bs-placement="top">
                        <i class="bi ${icono} fs-5" style="color: #0d6efd;"></i>
                    </div>
                `;
            });
            
            $('#serviciosIconos').html(iconosHtml);
            
            // Inicializar tooltips para los nuevos elementos
            setTimeout(() => {
                document.querySelectorAll('#serviciosIconos [data-bs-toggle="tooltip"]').forEach(el => {
                    new bootstrap.Tooltip(el);
                });
            }, 100);
        }

        function mostrarDetallePlayaBasico(playa){
            $('#playaNombre').text(playa.plyNom);
            $('#estadoBadge').text(playa.estaAbierto ? 'Abierto' : 'Cerrado').removeClass('open closed').addClass(playa.estaAbierto ? 'open' : 'closed');
            const ocupacion = 100 - playa.disponibilidad; $('#disponibilidadTexto').text(ocupacion + '% ocupado'); $('#disponibilidadBarra').css('width', ocupacion + '%');
            $('#tipoPiso').text(playa.plyTipoPiso); $('#direccion').text(playa.plyDir);
            $('#valorPromedio').text('$' + (parseFloat(playa.plyValProm || 0).toFixed(2)) + '/hora');
            $('#playaInfo').show();
        }

        function closeMenu(){ 
            $('#bottomMenu').removeClass('show'); 
            $('#playaInfo').show();
            $('#valoracionesInfo').hide();
            playaSeleccionada = null; 
        }
        function centerOnConductor(){ map.setView([conductorLat, conductorLon], 15); }
        function abrirNavegacion(){ if (playaSeleccionada) window.open(`https://www.google.com/maps/dir/?api=1&destination=${playaSeleccionada.plyLat},${playaSeleccionada.plyLon}`, '_blank'); }

        function buscarDireccion(){
            const direccion = $('#searchInput').val().trim();
            if (!direccion) return alert('Por favor ingresa una direcci√≥n');
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion + ', Resistencia, Chaco')}&limit=1`;
            $('#loading').show();
            $.get(url)
             .done(data => {
                 if (data?.length){
                    const lat = parseFloat(data[0].lat), lon = parseFloat(data[0].lon);
                    map.setView([lat, lon], 15);
                    buscarPlayasCercanas(lat, lon);
                 } else { alert('No se encontr√≥ la direcci√≥n.'); $('#loading').hide(); }
             })
             .fail(()=>{ alert('Error al buscar la direcci√≥n.'); $('#loading').hide(); });
        }

        function buscarPlayasCercanas(lat, lon){
            // Primero obtener el tipo de veh√≠culo
            $.get('/Conductor/GetVehiculoSeleccionado')
             .done(vehiculoData => {
                 const tipoVehiculo = vehiculoData?.tipo || null;
                 
                 $.get('/Conductor/GetPlayasCercanas', { lat, lon, radioKm:10 })
                  .done(data => {
                      const todasLasPlayas = (data || []).sort((a,b)=>a.distancia - b.distancia);
                      
                      if (!tipoVehiculo) {
                          // Si no hay tipo de veh√≠culo, mostrar todas las playas (m√°ximo 3)
                          searchResults = todasLasPlayas.slice(0,3);
                          mostrarPlayasBuscadas(lat, lon);
                          return;
                      }
                      
                      // Filtrar playas que tienen servicios/tarifas para el tipo de veh√≠culo
                      filtrarPlayasBuscadasPorTipoVehiculo(todasLasPlayas, tipoVehiculo, lat, lon);
                  })
                  .fail(()=> $('#loading').hide());
             })
             .fail(() => {
                 // Si no se puede obtener el veh√≠culo, mostrar todas las playas
                 $.get('/Conductor/GetPlayasCercanas', { lat, lon, radioKm:10 })
                  .done(data => {
                      searchResults = (data || []).sort((a,b)=>a.distancia - b.distancia).slice(0,3);
                      mostrarPlayasBuscadas(lat, lon);
                  })
                  .fail(()=> $('#loading').hide());
             });
        }
        
        function mostrarPlayasBuscadas(lat, lon){
            if (searchLocationMarker) map.removeLayer(searchLocationMarker);
            searchLocationMarker = L.marker([lat, lon], { icon: L.divIcon({ className:'search-location-marker', html:'<i class="fa-solid fa-location-dot" style="color:#dc3545;font-size:24px;text-shadow:2px 2px 4px rgba(0,0,0,.3);"></i>', iconSize:[30,30], iconAnchor:[15,15] }) }).addTo(map);
            searchLocationMarker.bindPopup('<b>Ubicaci√≥n buscada</b><br>Direcci√≥n: ' + $('#searchInput').val()).openPopup();
            isSearchMode = true; 
            mostrarPlayasEnMapa(); 
            $('#loading').hide();
            // Mostrar badge de filtro
            const direccionBuscada = $('#searchInput').val().trim();
            $('#filterText').text(direccionBuscada);
            $('#filterBadge').fadeIn(300);
        }
        
        function filtrarPlayasBuscadasPorTipoVehiculo(todasLasPlayas, tipoVehiculo, lat, lon){
            if (todasLasPlayas.length === 0) {
                searchResults = [];
                mostrarPlayasBuscadas(lat, lon);
                return;
            }
            
            let playasFiltradas = [];
            let verificadas = 0;
            const maxPlayas = 3;
            
            todasLasPlayas.forEach((playa, index) => {
                // Verificar si la playa tiene servicios/tarifas para el tipo de veh√≠culo
                $.get('/Conductor/GetTarifasYServicios', { id: playa.plyID, tipoVehiculo: tipoVehiculo })
                 .done(data => {
                     if (data && !data.error && data.servicios && data.servicios.length > 0) {
                         // Verificar que tenga al menos un servicio con tarifas para el tipo de veh√≠culo
                         const serviciosConTarifas = data.servicios.filter(s => {
                             if (!s.tarifas || s.tarifas.length === 0) return false;
                             return s.tarifas.some(t => t.clasificacionVehiculo === tipoVehiculo);
                         });
                         
                         if (serviciosConTarifas.length > 0 && playasFiltradas.length < maxPlayas) {
                             playasFiltradas.push(playa);
                         }
                     }
                     
                     verificadas++;
                     
                     // Cuando se hayan verificado todas las playas o tengamos 3, mostrar las filtradas
                     if (verificadas === todasLasPlayas.length || playasFiltradas.length >= maxPlayas) {
                         searchResults = playasFiltradas;
                         mostrarPlayasBuscadas(lat, lon);
                     }
                 })
                 .fail(() => {
                     verificadas++;
                     if (verificadas === todasLasPlayas.length) {
                         searchResults = playasFiltradas;
                         mostrarPlayasBuscadas(lat, lon);
                     }
                 });
            });
        }

        function volverAVistaNormal(){
            isSearchMode = false; searchResults = []; $('#searchInput').val('');
            if (searchLocationMarker){ map.removeLayer(searchLocationMarker); searchLocationMarker = null; }
            $('#filterBadge').fadeOut(300);
            cargarPlayas();
        }
        function limpiarBusqueda(){ $('#searchInput').val(''); volverAVistaNormal(); }

        function inicializarEscalaPersonalizada(){ map.on('zoomend', actualizarEscala); map.on('moveend', actualizarEscala); actualizarEscala(); }
        function actualizarEscala(){
            if (!map?.getCenter) return;
            try{
                const d = map.containerPointToLatLng([0,0]).distanceTo(map.containerPointToLatLng([100,0]));
                let text='1 km';
                if (d >= 1000) text = Math.round(d/1000) + ' km';
                else if (d >= 100) text = Math.round(d/100)*100 + ' m';
                else if (d >= 10) text = Math.round(d/10)*10 + ' m';
                else text = Math.round(d) + ' m';
                $('#scaleText').text(text); $('#scaleLine').css('width', '100px');
            } catch(e){ $('#scaleText').text('1 km'); $('#scaleLine').css('width','100px'); }
        }

        /* ===== Favoritos (panel) ===== */
        function toggleFavorites(){
            const panel = document.getElementById('favoritesPanel');
            const icon = document.getElementById('favoritesToggleIcon');
            panel.classList.toggle('collapsed');
            if (panel.classList.contains('collapsed')){ icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-up'); }
            else { icon.classList.remove('fa-chevron-up'); icon.classList.add('fa-chevron-down'); }
        }

        function guardarUbicacionFavorita(ubicacion){
            return fetch('@Url.Action("AgregarUbicacionFavorita", "Conductor")', {
                method:'POST', headers:{ 'Content-Type':'application/json', 'RequestVerificationToken': antiforgeryToken }, body: JSON.stringify(ubicacion)
            }).then(r=>r.json()).then(d=>{
                if (d.success) alert('Ubicaci√≥n favorita guardada correctamente.');
                else alert(d.error || 'No se pudo guardar la ubicaci√≥n favorita.');
                return d;
            }).catch(()=> alert('Ocurri√≥ un error al guardar la ubicaci√≥n favorita.'));
        }

        function cargarUbicacionesFavoritas(){
            return $.get('@Url.Action("GetUbicacionesFavoritas", "Conductor")')
             .done(data => { 
                 if (data && !data.error){ 
                     favoritos = data; 
                     renderizarFavoritos(); 
                     mostrarFavoritosEnMapa();
                     // Actualizar popups de marcadores existentes
                     actualizarPopupsMarcadores();
                 }
             });
        }

        function actualizarPopupsMarcadores(){
            parkingMarkers.forEach(marker => {
                const playa = playas.find(p => {
                    const markerLat = marker.getLatLng().lat;
                    const markerLon = marker.getLatLng().lng;
                    return Math.abs(parseFloat(p.plyLat) - markerLat) < 0.0001 && 
                           Math.abs(parseFloat(p.plyLon) - markerLon) < 0.0001;
                });
                if (playa) {
                    marker.setPopupContent(buildPopupContent(playa, isSearchMode));
                }
            });
        }

        function renderizarFavoritos(){
            const lista = document.getElementById('listaFavoritos');
            const mensajeVacio = document.getElementById('favoritosVacio');
            lista.innerHTML = '';
            if (!favoritos?.length){ mensajeVacio.style.display = 'block'; return; }
            mensajeVacio.style.display = 'none';

            favoritos.forEach(fav => {
                const li = document.createElement('li'); li.classList.add('favorite-item');

                const mainBtn = document.createElement('button');
                mainBtn.type = 'button'; mainBtn.className = 'favorite-main-btn';
                mainBtn.innerHTML = `<span>${fav.apodo}</span><span>${fav.direccion || (fav.ciudad || '')}</span>`;
                mainBtn.onclick = () => irAFavorito(fav);

                const viewBtn = document.createElement('button');
                viewBtn.type = 'button'; 
                viewBtn.className = 'favorite-view-btn'; 
                viewBtn.setAttribute('data-bs-toggle', 'tooltip');
                viewBtn.setAttribute('data-bs-placement', 'top');
                viewBtn.title = 'Visualizar ubicaci√≥n favorita';
                viewBtn.innerHTML = '<i class="fa-solid fa-eye"></i>';
                viewBtn.onclick = (e)=>{ e.stopPropagation(); irAFavorito(fav); };
                new bootstrap.Tooltip(viewBtn);

                const editBtn = document.createElement('button');
                editBtn.type = 'button'; 
                editBtn.className = 'favorite-edit-btn'; 
                editBtn.setAttribute('data-bs-toggle', 'tooltip');
                editBtn.setAttribute('data-bs-placement', 'top');
                editBtn.title = 'Renombrar ubicaci√≥n favorita';
                editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
                editBtn.onclick = (e)=>{ e.stopPropagation(); editarFavorito(fav); };
                new bootstrap.Tooltip(editBtn);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button'; 
                removeBtn.className = 'favorite-remove-btn'; 
                removeBtn.setAttribute('data-bs-toggle', 'tooltip');
                removeBtn.setAttribute('data-bs-placement', 'top');
                removeBtn.title = 'Eliminar ubicaci√≥n favorita';
                removeBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                removeBtn.onclick = (e)=>{ e.stopPropagation(); eliminarFavorito(fav); };
                new bootstrap.Tooltip(removeBtn);

                li.appendChild(mainBtn); li.appendChild(viewBtn); li.appendChild(editBtn); li.appendChild(removeBtn);
                lista.appendChild(li);
            });
        }

        function irAFavorito(fav){
            const lat = parseFloat(fav.lat ?? fav.ubfLat ?? fav.UbfLat);
            const lon = parseFloat(fav.lon ?? fav.ubfLon ?? fav.UbfLon);
            if (isNaN(lat) || isNaN(lon)) return alert('Este favorito no tiene coordenadas v√°lidas.');

            // Centrar el mapa con animaci√≥n suave
            map.flyTo([lat, lon], 16, {
                animate: true,
                duration: 0.8
            });
            
            // Asegurar que el mapa se actualice despu√©s de centrar
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
            
            $('#loading').show();

            // ¬øExiste ya alguna playa en memoria en esas coords?
            const playaCoincidente = playas.find(p => p.plyLat && p.plyLon && Math.abs(parseFloat(p.plyLat)-lat) < 0.0001 && Math.abs(parseFloat(p.plyLon)-lon) < 0.0001);

            if (playaCoincidente){
                $('#loading').hide();
                seleccionarPlaya(playaCoincidente);
                setTimeout(() => {
                    openMarkerPopup(playaCoincidente);
                    map.invalidateSize();
                }, 500);
                return;
            }

            // Buscar en servidor
            $.get('/Conductor/GetPlayasCercanas', { lat, lon, radioKm:2 })
             .done(data => {
                 $('#loading').hide();
                 if (data?.length){
                    const playa = data[0];
                    seleccionarPlaya(playa);
                    setTimeout(()=> {
                        openMarkerPopup(playa);
                        map.invalidateSize();
                    }, 500);
                 } else {
                    // No hay playas ‚Üí mostrar datos del favorito y popup de ubicaci√≥n
                    $('#playaNombre').text(fav.apodo);
                    $('#estadoBadge').text('N/A').removeClass('open closed');
                    $('#disponibilidadTexto').text('Sin datos'); $('#disponibilidadBarra').css('width','0%');
                    $('#tipoPiso').text('No disponible'); $('#direccion').text(fav.direccion || fav.ciudad || ''); $('#valorPromedio').text('N/A');
                    $('#horariosInfo').html('<span style="color:#dc3545;">Sin playas cercanas</span>'); $('#horariosSection').show(); $('#playaInfo').show(); $('#bottomMenu').addClass('show');

                    if (transientPopup) map.closePopup(transientPopup);
                    setTimeout(() => {
                        transientPopup = L.popup().setLatLng([lat, lon]).setContent(`<strong>${fav.apodo}</strong><br>${fav.direccion || ''}`).openOn(map);
                        map.invalidateSize();
                    }, 500);
                 }
             })
             .fail(()=> $('#loading').hide());
        }

        function eliminarFavorito(fav) {
            if (!confirm(`¬øEliminar "${fav.apodo}" de tus favoritos?`)) return;

            $.ajax({
                url: '@Url.Action("EliminarUbicacionFavorita", "Conductor")' + '?apodo=' + encodeURIComponent(fav.apodo),
                type: 'DELETE'
            })
            .done(function(data) {
            if (data.success) {
                favoritos = favoritos.filter(f => f.apodo !== fav.apodo);
                refreshFavoritesUI(); // üëà tambi√©n se actualiza
            } else {
                alert(data.error || 'No se pudo eliminar el favorito.');
            }
            })

            .fail(function() {
                alert('Ocurri√≥ un error al eliminar el favorito.');
            });
        }


        function refreshFavoritesUI() {
            renderizarFavoritos();
            mostrarFavoritosEnMapa(); // limpia y vuelve a dibujar estrellas seg√∫n "favoritos"
            actualizarPopupsMarcadores(); // actualiza los popups de los marcadores existentes
        }

        function editarFavorito(fav){
            const nuevo = prompt('Nuevo nombre para esta ubicaci√≥n favorita:', fav.apodo);
            if (nuevo == null) return;
            if (nuevo.trim() === '') return alert('El nombre no puede estar vac√≠o.');
            fetch('@Url.Action("EditarUbicacionFavorita", "Conductor")', {
                method:'POST', headers:{ 'Content-Type':'application/json', 'RequestVerificationToken': antiforgeryToken },
                body: JSON.stringify({ apodoActual: fav.apodo, nuevoApodo: nuevo.trim() })
            }).then(r=>r.json()).then(d=>{
                if (d.success){ fav.apodo = nuevo.trim(); refreshFavoritesUI(); }
                else alert(d.error || 'No se pudo renombrar la ubicaci√≥n favorita.');
            }).catch(()=> alert('Ocurri√≥ un error al renombrar la ubicaci√≥n favorita.'));
        }

        // === Valoraciones ===
        let valoracionActual = null;
        let playaValoracionActual = null;

        window.abrirValoraciones = function(plyID, playaNombre){
            playaValoracionActual = { plyID, playaNombre };
            $('#playaNombre').text(`Valoraciones - ${playaNombre}`);
            $('#valoracionesContent').html('<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>');
            
            // Ocultar detalles de playa y mostrar valoraciones
            $('#playaInfo').hide();
            $('#valoracionesInfo').show();
            $('#bottomMenu').addClass('show');
            
            cargarValoraciones(plyID);
        };

        function cargarValoraciones(plyID){
            $.get('/Conductor/GetValoraciones', { id: plyID })
             .done(data => {
                 if (data && !data.error){
                     mostrarValoraciones(data);
                 } else {
                     $('#valoracionesContent').html('<div class="alert alert-warning">No se pudieron cargar las valoraciones.</div>');
                 }
             })
             .fail(() => {
                 $('#valoracionesContent').html('<div class="alert alert-danger">Error al cargar las valoraciones.</div>');
             });
        }
        
        function volverADetalles(){
            $('#valoracionesInfo').hide();
            $('#playaInfo').show();
            if(playaSeleccionada){
                $('#playaNombre').text(playaSeleccionada.plyNom);
                // Recargar detalles si es necesario
                $.get('/Conductor/GetDetallePlaya', { id: playaSeleccionada.plyID })
                 .done(detalle => {
                     mostrarDetallePlaya(detalle);
                     cargarTarifasYServicios(playaSeleccionada.plyID);
                 })
                 .fail(() => {
                     mostrarDetallePlayaBasico(playaSeleccionada);
                     cargarTarifasYServicios(playaSeleccionada.plyID);
                 });
            }
        }

        function mostrarValoraciones(data){
            const { valoraciones, promedio, miValoracion } = data;
            valoracionActual = miValoracion;
            
            let html = '';
            
            // Promedio y estad√≠sticas
            html += `<div class="mb-3 p-3" style="background:#cfe2ff; border-radius:8px; border:1px solid #0d6efd;">`;
            html += `<div class="text-center">`;
            html += `<h4 style="color:#0d6efd; margin:0;">${promedio.toFixed(1)}</h4>`;
            html += `<div class="mb-2">${generarEstrellas(promedio, true)}</div>`;
            html += `<small style="color:#666; display:block; margin-bottom:8px;">${valoraciones.length} valoraci√≥n${valoraciones.length !== 1 ? 'es' : ''}</small>`;
            html += `<div style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(13,110,253,0.3);">`;
            html += `<small style="color:#0d6efd; font-weight:500;"><i class="fa-solid fa-comments me-1"></i> Ver comentarios de otros conductores abajo</small>`;
            html += `</div>`;
            html += `</div></div>`;
            
            // Formulario para agregar/editar valoraci√≥n
            html += `<div class="mb-3 p-3" style="background:#f8f9fa; border-radius:8px; border:1px solid #dee2e6;">`;
            html += `<h6 style="color:#333; margin-bottom:15px;">${miValoracion ? 'Editar mi valoraci√≥n' : 'Agregar valoraci√≥n'}</h6>`;
            html += `<div class="mb-3">`;
            html += `<label class="form-label" style="font-weight:600; color:#333;">Puntuaci√≥n:</label>`;
            html += `<div class="d-flex justify-content-center gap-2 mb-2" id="estrellasInput">`;
            for(let i = 1; i <= 5; i++){
                const activa = miValoracion && miValoracion.valNumEst >= i;
                html += `<i class="fa-star ${activa ? 'fa-solid' : 'fa-regular'}" style="font-size:24px; color:${activa ? '#ffc107' : '#ddd'}; cursor:pointer;" data-rating="${i}" onclick="seleccionarEstrellas(${i})"></i>`;
            }
            html += `</div>`;
            html += `<div class="text-center"><span id="ratingText" style="color:#666; font-size:0.9em;">${miValoracion ? miValoracion.valNumEst + ' estrellas' : 'Selecciona una puntuaci√≥n'}</span></div>`;
            html += `</div>`;
            html += `<div class="mb-3">`;
            html += `<label class="form-label" style="font-weight:600; color:#333;">Comentario (opcional):</label>`;
            html += `<textarea class="form-control" id="valComentario" rows="3" placeholder="Escribe tu comentario aqu√≠..." maxlength="500" style="resize:vertical;">${miValoracion && miValoracion.valComentario ? (miValoracion.valComentario || '') : ''}</textarea>`;
            html += `<small class="text-muted" style="font-size:0.8em;">M√°ximo 500 caracteres</small>`;
            html += `</div>`;
            html += `<button class="btn btn-primary w-100" onclick="guardarValoracion()" style="background:#0d6efd; border-color:#0d6efd;">${miValoracion ? 'Actualizar valoraci√≥n' : 'Guardar valoraci√≥n'}</button>`;
            if(miValoracion){
                html += `<button class="btn btn-outline-danger w-100 mt-2" onclick="eliminarValoracion()">Eliminar mi valoraci√≥n</button>`;
            }
            html += `</div>`;
            
            // Lista de valoraciones
            html += `<h6 style="color:#333; margin-bottom:15px; margin-top:20px;">Valoraciones de otros usuarios:</h6>`;
            if(valoraciones.length === 0){
                html += `<div class="alert alert-info" style="background:#cfe2ff; border-color:#0d6efd; color:#0d6efd;">A√∫n no hay valoraciones de otros usuarios.</div>`;
            } else {
                html += `<div style="max-height:250px; overflow-y:auto;">`;
                valoraciones.forEach(v => {
                    html += `<div class="mb-2 p-2" style="background:#fff; border:1px solid #dee2e6; border-radius:8px;">`;
                    html += `<div class="d-flex justify-content-between align-items-start mb-1">`;
                    html += `<div>`;
                    html += `<strong style="color:#333; font-size:0.9em;">${v.conductorNombre || 'Usuario'}</strong>`;
                    html += `${v.valFav ? ' <span style="color:#f1c40f;">‚òÖ</span>' : ''}`;
                    html += `</div>`;
                    html += `<div>${generarEstrellas(v.valNumEst, false)}</div>`;
                    html += `</div>`;
                    if(v.valComentario && v.valComentario.trim()){
                        html += `<div class="mt-2 p-2" style="background:#f8f9fa; border-radius:6px; border-left:3px solid #0d6efd;">`;
                        html += `<p style="margin:0; color:#333; font-size:0.9em; white-space:pre-wrap;">${v.valComentario}</p>`;
                        html += `</div>`;
                    }
                    html += `<small style="color:#666; font-size:0.8em;">${v.fecha || ''}</small>`;
                    html += `</div>`;
                });
                html += `</div>`;
            }
            
            $('#valoracionesContent').html(html);
        }

        function generarEstrellas(promedio, esPromedio){
            let html = '';
            const num = Math.round(promedio);
            for(let i = 1; i <= 5; i++){
                if(i <= num){
                    html += '<i class="fa-solid fa-star" style="color:#ffc107;"></i>';
                } else if(i - 0.5 <= promedio){
                    html += '<i class="fa-solid fa-star-half-stroke" style="color:#ffc107;"></i>';
                } else {
                    html += '<i class="fa-regular fa-star" style="color:#ddd;"></i>';
                }
            }
            return html;
        }

        let ratingSeleccionado = null;
        function seleccionarEstrellas(rating){
            ratingSeleccionado = rating;
            const estrellas = document.querySelectorAll('#estrellasInput .fa-star');
            estrellas.forEach((star, index) => {
                if(index < rating){
                    star.classList.remove('fa-regular');
                    star.classList.add('fa-solid');
                    star.style.color = '#ffc107';
                } else {
                    star.classList.remove('fa-solid');
                    star.classList.add('fa-regular');
                    star.style.color = '#ddd';
                }
            });
            document.getElementById('ratingText').textContent = rating + ' estrella' + (rating > 1 ? 's' : '');
        }

        function guardarValoracion(){
            if(!ratingSeleccionado && !valoracionActual){
                alert('Por favor selecciona una puntuaci√≥n.');
                return;
            }
            
            const rating = ratingSeleccionado || (valoracionActual ? valoracionActual.valNumEst : null);
            if(!rating){
                alert('Por favor selecciona una puntuaci√≥n.');
                return;
            }
            
            const valComentario = document.getElementById('valComentario').value.trim();
            
            const payload = {
                plyID: playaValoracionActual.plyID,
                valNumEst: rating,
                valFav: false,
                valComentario: valComentario || null
            };
            
            $.ajax({
                url: '/Conductor/GuardarValoracion',
                method: 'POST',
                contentType: 'application/json',
                headers: { 'RequestVerificationToken': antiforgeryToken },
                data: JSON.stringify(payload)
            })
            .done(data => {
                if(data.success){
                    alert('Valoraci√≥n guardada correctamente.');
                    cargarValoraciones(playaValoracionActual.plyID);
                    ratingSeleccionado = null;
                } else {
                    alert(data.error || 'No se pudo guardar la valoraci√≥n.');
                }
            })
            .fail(() => {
                alert('Ocurri√≥ un error al guardar la valoraci√≥n.');
            });
        }

        function eliminarValoracion(){
            if(!confirm('¬øEliminar tu valoraci√≥n?')) return;
            
            $.ajax({
                url: '/Conductor/EliminarValoracion',
                method: 'DELETE',
                data: { id: playaValoracionActual.plyID },
                headers: { 'RequestVerificationToken': antiforgeryToken }
            })
            .done(data => {
                if(data.success){
                    alert('Valoraci√≥n eliminada correctamente.');
                    cargarValoraciones(playaValoracionActual.plyID);
                    ratingSeleccionado = null;
                } else {
                    alert(data.error || 'No se pudo eliminar la valoraci√≥n.');
                }
            })
            .fail(() => {
                alert('Ocurri√≥ un error al eliminar la valoraci√≥n.');
            });
        }

        // Teclado
        $(document).keydown(function(e){
            if (e.key === 'Escape') closeMenu();
            if (e.key === 'c' || e.key === 'C') centerOnConductor();
        });
    </script>
</body>
</html>