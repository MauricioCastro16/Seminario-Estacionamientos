@model IEnumerable<estacionamientos.Models.PlayaEstacionamiento>

@{
    ViewData["Title"] = "Mapa de Estacionamientos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        body { margin:0; padding:0; overflow:hidden; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #mapContainer { position:fixed; top:60px; left:0; width:100vw; height:calc(100vh - 60px); z-index:1; pointer-events:auto; }

        @@media (max-width: 768px){
            .main-footer{ display:none !important; }
            #mapContainer{ height:100vh !important; top:0 !important; }
        }

        .main-content{ background:transparent; padding-top:0; position:relative; z-index:1; }
        .main-header{ background:rgba(255,255,255,.95); backdrop-filter:blur(10px); }
        .main-header, .main-content, .mobile-sidebar, .sidebar-overlay, .navbar, .sidebar{ position:relative !important; z-index:1000 !important; }
        .main-footer, .footer{ position:relative !important; z-index:100 !important; }

        .main-header, .navbar{
            position:fixed !important; top:0 !important; left:0 !important; right:0 !important;
            z-index:10000 !important; background:rgba(255,255,255,.95) !important;
            backdrop-filter:blur(10px) !important; height:60px !important; pointer-events:auto !important;
        }
        .navbar *{ pointer-events:auto !important; }
        .dropdown-menu, .nav-item.dropdown, .user-menu{ z-index:10001 !important; position:relative !important; }
        .dropdown.show .dropdown-menu{ display:block !important; z-index:10001 !important; position:absolute !important; top:100% !important; left:0 !important; }

        .controls{ position:fixed; top:80px; right:20px; z-index:1000; display:flex; flex-direction:column; gap:10px; }
        .search-bar{
            position:fixed; top:80px; left:50%; transform:translateX(-50%); z-index:1000; display:flex; align-items:center;
            background:rgba(255,255,255,.95); border-radius:25px; padding:8px 15px; box-shadow:0 4px 15px rgba(0,0,0,.1); backdrop-filter:blur(10px);
            width:90%; max-width:600px; min-width:280px;
        }
        .search-bar input{ flex:1; border:none; outline:none; background:transparent; padding:8px 12px; font-size:16px; min-width:0; width:100%; }
        .search-bar button{ background:#3498db; color:#fff; border:none; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer; margin-left:8px; transition:.3s; flex-shrink:0; }
        .search-bar button:hover{ background:#2980b9; transform:scale(1.05); }
        .search-bar .home-btn{ background:#6c757d; }
        .search-bar .home-btn:hover{ background:#5a6268; }
        .search-bar .clear-btn{ background:#6c757d; margin-left:5px; display:none; }
        .search-bar .clear-btn.show{ display:flex; }

        @@media (max-width:768px){
            .search-bar{ width:95%; max-width:500px; padding:6px 12px; top:70px; }
            .search-bar input{ font-size:14px; padding:6px 10px; }
            .search-bar button{ width:36px; height:36px; margin-left:6px; }
            .search-bar .home-btn{ margin-left:4px; }
        }
        @@media (max-width:480px){
            .search-bar{ width:98%; max-width:none; padding:5px 10px; top:65px; border-radius:20px; }
            .search-bar input{ font-size:13px; padding:5px 8px; }
            .search-bar button{ width:32px; height:32px; margin-left:4px; }
        }
        @@media (max-width:360px){
            .search-bar{ width:100%; margin:0 5px; padding:4px 8px; top:60px; }
            .search-bar input{ font-size:12px; padding:4px 6px; }
            .search-bar button{ width:28px; height:28px; margin-left:3px; }
            .search-bar button i{ font-size:12px; }
        }

        .control-btn{ background:rgba(255,255,255,.9); border:none; border-radius:8px; padding:12px; cursor:pointer; font-size:18px; box-shadow:0 2px 10px rgba(0,0,0,.1); transition:.3s; min-width:50px; height:50px; display:flex; align-items:center; justify-content:center; }
        .control-btn:hover{ background:#fff; transform:translateY(-2px); box-shadow:0 4px 15px rgba(0,0,0,.2); }

        .loading{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(255,255,255,.95); padding:20px; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,.1); z-index:1002; display:flex; align-items:center; gap:10px; }
        .spinner{ width:20px; height:20px; border:2px solid #f3f3f3; border-top:2px solid #3498db; border-radius:50%; animation:spin 1s linear infinite; }
        @@keyframes spin{ 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

        #bottomMenu{
            position:fixed; bottom:-100%; left:10px; right:10px; background:#fff; border-radius:20px 20px 0 0; padding:25px;
            box-shadow:0 -4px 20px rgba(0,0,0,.1); z-index:10001; transition:bottom .3s ease; max-height:40vh; overflow-y:auto;
        }
        #bottomMenu.show{ bottom:0; }
        @@media (max-width:768px){
            #bottomMenu{ left:5px; right:5px; padding:20px; max-height:80vh !important; border-radius:15px 15px 0 0; }
        }

        .menu-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .close-btn{ background:none; border:none; font-size:24px; cursor:pointer; color:#666; }
        .info-row{ display:flex; justify-content:space-between; margin-bottom:10px; }
        .info-label{ font-weight:600; color:#333; }
        .info-value{ color:#666; }
        .status-badge{ padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600; }
        .status-badge.open{ background:#d4edda; color:#155724; }
        .status-badge.closed{ background:#f8d7da; color:#721c24; }
        .availability-bar{ width:100%; height:8px; background:#e9ecef; border-radius:4px; overflow:hidden; margin:5px 0; }
        .availability-fill{ height:100%; background:linear-gradient(90deg,#28a745,#ffc107,#dc3545); transition:width .3s; }

        .custom-parking-icon{ background:#3498db; color:#fff; border:2px solid #fff; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; box-shadow:0 2px 8px rgba(0,0,0,.3); cursor:pointer; }
        .custom-parking-icon.available{ background:#28a745; }
        .custom-parking-icon.closed{ background:#95a5a6; }
        .custom-parking-icon.search-result{ background:#dc3545; }
        .search-location-marker{ background:transparent !important; border:none !important; }

        .custom-scale{ position:fixed; bottom:20px; left:20px; background:rgba(255,255,255,.9); border:1px solid #ccc; border-radius:4px; padding:8px 12px; font-size:12px; font-weight:bold; color:#333; z-index:1000; box-shadow:0 2px 4px rgba(0,0,0,.2); backdrop-filter:blur(5px); }
        .scale-line{ height:2px; background:#333; margin:4px 0; position:relative; }
        .scale-line::before, .scale-line::after{ content:''; position:absolute; top:-3px; width:1px; height:8px; background:#333; }
        .scale-line::before{ left:0; } .scale-line::after{ right:0; }

        .custom-parking-icon:hover{ transform:scale(1.2); transition:transform .2s; }
        .simplified-map{ filter:grayscale(20%) contrast(1.1) brightness(1.1); }
        .leaflet-control-container .leaflet-top.leaflet-left,
        .leaflet-control-container .leaflet-top.leaflet-right,
        .leaflet-control-container .leaflet-bottom.leaflet-left,
        .leaflet-control-container .leaflet-bottom.leaflet-right{ display:none; }

        /* ==== Favoritos ==== */
        .favorites-panel{
            position:fixed; top:140px; left:20px; z-index:1000; background:rgba(255,255,255,.97);
            border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.15); width:260px; max-height:50vh; overflow:hidden;
            display:flex; flex-direction:column; font-size:13px;
        }
        .favorites-header{ display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid #eee; }
        .favorite-map-icon{ display:flex; align-items:center; justify-content:center; width:30px; height:30px; border-radius:50%; background:rgba(255,255,255,.95); box-shadow:0 2px 8px rgba(0,0,0,.35); border:2px solid #f1c40f; }
        .favorite-map-icon i{ color:#f1c40f; font-size:18px; }
        .favorites-title{ display:flex; align-items:center; gap:6px; font-weight:600; color:#333; }
        .favorites-title i{ color:#f1c40f; }
        .favorites-toggle{ border:none; background:transparent; cursor:pointer; color:#666; padding:4px; border-radius:50%; }
        .favorites-toggle:hover{ background:#f4f4f4; }
        .favorites-body{ padding:6px 8px 8px 8px; overflow-y:auto; }
        #listaFavoritos{ list-style:none; margin:0; padding:0; }
        .favorite-item{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; gap:4px; }

        .favorite-main-btn{ flex:1; border:none; background:#f8f9fa; border-radius:6px; padding:6px 8px; text-align:left; font-size:12px; cursor:pointer; display:flex; flex-direction:column; }
        .favorite-main-btn span:first-child{ font-weight:600; color:#333; }
        .favorite-main-btn span:last-child{ color:#777; font-size:11px; }
        .favorite-main-btn:hover{ background:#e9ecef; }

        .favorite-view-btn{ border:none; background:#e7f0ff; color:#0d6efd; border-radius:6px; width:28px; height:28px; display:flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0; font-size:12px; }
        .favorite-view-btn:hover{ background:#d7e7ff; }

        .favorite-edit-btn{ border:none; background:#e2e3ff; color:#383d7c; border-radius:6px; width:28px; height:28px; display:flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0; font-size:12px; }
        .favorite-edit-btn:hover{ background:#c7c9ff; }

        .favorite-remove-btn{ border:none; background:#f8d7da; color:#721c24; border-radius:6px; width:28px; height:28px; display:flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0; font-size:12px; }
        .favorite-remove-btn:hover{ background:#f5c6cb; }

        .favorites-empty{ font-size:11px; color:#777; padding:4px 2px; }
        .favorites-panel.collapsed{ max-height:44px; }
        .favorites-panel.collapsed .favorites-body{ display:none; }
        @@media (max-width:768px){
            .favorites-panel{ top:auto; bottom:20px; left:10px; right:10px; width:auto; max-height:160px; display:none; }
            .favorites-panel.open{ display:flex; }
        }

        /* Bot√≥n de favoritos en la barra */
        .fav-btn{ background:#f1c40f; color:#fff; border:none; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; margin-left:5px; cursor:pointer; flex-shrink:0; }
        .fav-btn i{ font-size:16px; }
    </style>
</head>
<body>
    @Html.AntiForgeryToken()

    <div id="mapContainer"></div>

    <!-- Panel de favoritos -->
    <div class="favorites-panel" id="favoritesPanel">
        <div class="favorites-header">
            <div class="favorites-title">
                <i class="fa-solid fa-star"></i>
                <span>Favoritos</span>
            </div>
            <button class="favorites-toggle" type="button" onclick="toggleFavorites()">
                <i class="fa-solid fa-chevron-down" id="favoritesToggleIcon"></i>
            </button>
        </div>
        <div class="favorites-body">
            <ul id="listaFavoritos"></ul>
            <div class="favorites-empty" id="favoritosVacio">
                A√∫n no agregaste playas favoritas.<br />
                Toc√° una playa en el mapa y us√° ‚òÖ para guardarla.
            </div>
        </div>
    </div>

    <!-- Barra de b√∫squeda -->
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Buscar direcci√≥n..." />
        <button class="clear-btn" onclick="limpiarBusqueda()" title="Limpiar b√∫squeda" id="clearBtn"><i class="fa-solid fa-xmark"></i></button>
        <button onclick="buscarDireccion()" title="Buscar"><i class="fa-solid fa-magnifying-glass"></i></button>
        <button class="home-btn" onclick="centerOnConductor()" title="Volver al inicio"><i class="fa-solid fa-house"></i></button>
        <button class="fav-btn" id="favBtn" title="Ubicaciones favoritas" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-star"></i></button>
    </div>

    <div class="loading" id="loading"><div class="spinner"></div>Cargando mapa...</div>

    <div class="custom-scale" id="customScale">
        <div id="scaleText">1 km</div>
        <div class="scale-line" id="scaleLine"></div>
    </div>

    <div id="bottomMenu">
        <div class="menu-header">
            <h4 id="playaNombre">Selecciona una playa</h4>
            <button class="close-btn" onclick="closeMenu()">√ó</button>
        </div>
        <div id="playaInfo" style="display:none;">
            <div class="info-row"><span class="info-label">Estado:</span><span class="status-badge" id="estadoBadge">Abierto</span></div>
            <div class="info-row"><span class="info-label">Ocupaci√≥n:</span><span class="info-value" id="disponibilidadTexto">15% ocupado</span></div>
            <div class="availability-bar"><div class="availability-fill" id="disponibilidadBarra" style="width:85%"></div></div>
            <div class="info-row"><span class="info-label">Tipo de piso:</span><span class="info-value" id="tipoPiso">Hormig√≥n</span></div>
            <div class="info-row"><span class="info-label">Direcci√≥n:</span><span class="info-value" id="direccion">Av. Principal 123</span></div>
            <div class="info-row"><span class="info-label">Valor promedio:</span><span class="info-value" id="valorPromedio">$500/hora</span></div>
            <div class="info-row mt-3" id="horariosSection" style="display:none;"><span class="info-label">Horarios de atenci√≥n:</span><div class="info-value" id="horariosInfo" style="font-size:.9em;"></div></div>
            <div class="info-row mt-2" id="debugInfoSection" style="display:none; font-size:.8em; color:#666;"><div id="debugInfo"></div></div>
            <button class="btn btn-primary w-100 mt-3" onclick="abrirNavegacion()"><i class="bi bi-navigation me-2"></i>Ver en Google Maps</button>
        </div>
    </div>

    <!-- Leaflet & libs -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let map, playas = [], playaSeleccionada = null;
        let favoriteMarkers = [], conductorMarker, parkingMarkers = [];
        let searchResults = [], isSearchMode = false, searchLocationMarker = null, customScale = null;

        let favoritos = [], antiforgeryToken = null;
        let playaIdToMarker = new Map();
        let transientPopup = null; // popup temporal cuando no hay marker

        // Fallback Resistencia
        let conductorLat = -27.451000, conductorLon = -58.986000;
        let vehiculoFavorito = null;

        $(document).ready(function () {
            antiforgeryToken = $('input[name="__RequestVerificationToken"]').val();
            obtenerVehiculoSeleccionado();
            inicializarMapa();
            cargarUbicacionesFavoritas();

            // tooltips
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

            // Enter en b√∫squeda
            $('#searchInput').keypress(function(e){ if(e.which === 13) buscarDireccion(); });

            // Mostrar/ocultar clear
            $('#searchInput').on('input', function(){ $(this).val().trim() !== '' ? $('#clearBtn').addClass('show') : $('#clearBtn').removeClass('show'); });

            // ‚≠ê abre panel (mobile y desktop)
            document.getElementById('favBtn')?.addEventListener('click', openFavoritesFromStar);

            // sync veh√≠culo si cambia en otra pesta√±a
            window.addEventListener('storage', function(e){
                if (e.key === 'vehiculoSeleccionado' && e.newValue) {
                    vehiculoFavorito = JSON.parse(e.newValue);
                    if (conductorMarker) conductorMarker.setIcon(crearIconoConductor());
                }
            });
        });

        function openFavoritesFromStar(){
            const panel = document.getElementById('favoritesPanel');
            const icon  = document.getElementById('favoritesToggleIcon');
            if (window.matchMedia('(max-width:768px)').matches){ panel.classList.add('open'); }
            panel.classList.remove('collapsed');
            if (icon){ icon.classList.remove('fa-chevron-up'); icon.classList.add('fa-chevron-down'); }
        }

        function obtenerVehiculoSeleccionado(){
            const guardado = sessionStorage.getItem('vehiculoSeleccionado');
            if (guardado){ vehiculoFavorito = JSON.parse(guardado); return; }
            $.get('/Conductor/GetVehiculoSeleccionado')
             .done(d => { if(!d.error){ vehiculoFavorito = d; sessionStorage.setItem('vehiculoSeleccionado', JSON.stringify(d)); }})
             .fail(() => vehiculoFavorito = null);
        }

        function crearIconoConductor(){
            let imagenUrl = '/estacionamientos/Resources/Map/auto.png';
            if (vehiculoFavorito?.tipo){
                const t = vehiculoFavorito.tipo.toLowerCase();
                if (t.includes('camioneta') || t.includes('suv')) imagenUrl = '/estacionamientos/Resources/Map/camioneta.png';
                else if (t.includes('moto')) imagenUrl = '/estacionamientos/Resources/Map/moto.png';
                else if (t.includes('camion')) imagenUrl = '/estacionamientos/Resources/Map/suv.png';
            }
            return L.divIcon({
                className:'conductor-marker',
                html:`<div style="background:#fff;border:3px solid #3498db;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,.3);overflow:hidden;"><img src="${imagenUrl}" style="width:40px;height:40px;object-fit:contain" alt="Veh√≠culo"></div>`,
                iconSize:[50,50], iconAnchor:[25,25]
            });
        }

        function inicializarMapa(){
            map = L.map('mapContainer', { zoomControl:false, scrollWheelZoom:true, doubleClickZoom:true, boxZoom:true, keyboard:true, dragging:true, touchZoom:true, attributionControl:false, minZoom:12 });
            L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{ attribution:'&copy; OpenStreetMap & CARTO'}).addTo(map);
            L.control.zoom({ position:'topright' }).addTo(map);

            if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const { latitude:lat, longitude:lon } = pos.coords;
                        map.setView([lat, lon], 16);
                        conductorMarker = L.marker([lat, lon], { icon:crearIconoConductor() }).addTo(map).bindPopup('<b>Tu ubicaci√≥n</b><br>Ubicaci√≥n detectada').openPopup();
                        conductorLat = lat; conductorLon = lon;
                        cargarPlayas(); inicializarEscalaPersonalizada();
                    },
                    () => fallbackMapa(),
                    { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
                );
            } else fallbackMapa();

            function fallbackMapa(){
                map.setView([conductorLat, conductorLon], 14);
                conductorMarker = L.marker([conductorLat, conductorLon], { icon:crearIconoConductor() }).addTo(map).bindPopup('<b>Tu ubicaci√≥n</b><br>Resistencia, Chaco').openPopup();
                cargarPlayas(); inicializarEscalaPersonalizada();
            }
        }

        function cargarPlayas(){
            $('#loading').show();
            $.get('/Conductor/GetPlayasCercanas', { lat:conductorLat, lon:conductorLon, radioKm:50 })
             .done(data => { playas = data || []; mostrarPlayasEnMapa(); $('#loading').hide(); })
             .fail((_,__,err)=> $('#loading').html('<div class="spinner"></div>Error al cargar playas: ' + err));
        }

        function crearIconoPlaya(playa, esResultadoBusqueda=false){
            let className = 'custom-parking-icon';
            if (esResultadoBusqueda) className += ' search-result';
            else if (!playa.estaAbierto) className += ' closed';
            else if (playa.disponibilidad > 50) className += ' available';
            return L.divIcon({ className, html:'P', iconSize:[30,30], iconAnchor:[15,15] });
        }

        function mostrarPlayasEnMapa(){
            parkingMarkers.forEach(m => map.removeLayer(m));
            parkingMarkers = [];
            playaIdToMarker.clear();

            const playasAMostrar = isSearchMode ? searchResults : playas;

            playasAMostrar.forEach(playa => {
                if (playa.plyLat == null || playa.plyLon == null || isNaN(playa.plyLat) || isNaN(playa.plyLon)){
                    console.warn(`Coordenadas inv√°lidas para ${playa.plyNom}: lat=${playa.plyLat}, lon=${playa.plyLon}`);
                    return;
                }

                const icon = crearIconoPlaya(playa, isSearchMode);
                const marker = L.marker([playa.plyLat, playa.plyLon], { icon }).addTo(map);

                const popupContent = `
                  <div style="min-width:220px;">
                    <h6 style="margin:0 0 10px;color:#2c3e50;">${playa.plyNom}</h6>
                    <p style="margin:5px 0;font-size:14px;"><strong>Direcci√≥n:</strong> ${playa.plyDir}</p>
                    <p style="margin:5px 0;font-size:14px;"><strong>Disponibilidad:</strong> ${playa.disponibilidad}%</p>
                    <p style="margin:5px 0;font-size:14px;"><strong>Estado:</strong> ${playa.estaAbierto ? 'Abierto' : 'Cerrado'}</p>
                    ${isSearchMode ? `<p style="margin:5px 0;font-size:14px;color:#dc3545;"><strong>üìç Distancia:</strong> ${Number(playa.distancia||0).toFixed(2)} km</p>` : ''}
                    ${isSearchMode ? '<p style="margin:5px 0;font-size:12px;color:#dc3545;font-weight:bold;">üîç Uno de los 3 m√°s cercanos</p>' : ''}
                    <div class="d-flex gap-1 mt-2">
                      <button class="btn btn-sm btn-primary flex-fill" onclick="window.seleccionarPlayaDesdePopup(${playa.plyID})">Ver detalles</button>
                      <button class="btn btn-sm btn-outline-warning flex-fill" onclick="window.agregarFavoritaDesdePopup(${playa.plyID})">‚òÖ Favorito</button>
                    </div>
                  </div>`;
                marker.bindPopup(popupContent);

                marker.on('click', () => seleccionarPlaya(playa));
                marker.on('popupopen', () => console.log('üìã Popup abierto para:', playa.plyNom));

                if (playa.plyID != null) playaIdToMarker.set(playa.plyID, marker);

                parkingMarkers.push(marker);
            });
        }

        function openMarkerPopup(playaLike){
            // Intenta abrir el popup del marker existente
            const marker = playaIdToMarker.get(playaLike?.plyID);
            if (marker){ marker.openPopup(); return; }

            // Si no hay marker (p.ej. vino de favorito aislado), muestra popup temporal
            if (transientPopup) map.closePopup(transientPopup);
            const nombre = playaLike?.plyNom || playaLike?.apodo || 'Ubicaci√≥n';
            const dir = playaLike?.plyDir || playaLike?.direccion || '';
            transientPopup = L.popup({ closeOnClick:true, autoClose:true })
                .setLatLng([playaLike.plyLat || playaLike.lat, playaLike.plyLon || playaLike.lon])
                .setContent(`<strong>${nombre}</strong><br>${dir}`)
                .openOn(map);
        }

        // Mostrar favoritos con ‚≠ê
        function crearIconoFavorito(){
            return L.divIcon({ className:'favorite-map-icon', html:'<i class="fa-solid fa-star"></i>', iconSize:[30,30], iconAnchor:[15,15] });
        }

        function mostrarFavoritosEnMapa(){
            favoriteMarkers.forEach(m => map.removeLayer(m));
            favoriteMarkers = [];
            if (!favoritos?.length) return;

            favoritos.forEach(fav => {
                const lat = parseFloat(fav.lat ?? fav.ubfLat ?? fav.UbfLat);
                const lon = parseFloat(fav.lon ?? fav.ubfLon ?? fav.UbfLon);
                if (isNaN(lat) || isNaN(lon)) return;

                const marker = L.marker([lat, lon], { icon:crearIconoFavorito(), zIndexOffset:500 })
                    .addTo(map)
                    .bindPopup(`<strong>${fav.apodo}</strong><br>${fav.direccion || fav.ciudad || ''}`);

                marker.on('click', () => irAFavorito(fav));
                favoriteMarkers.push(marker);
            });
        }

        // === Helpers del popup de la playa ===
        window.seleccionarPlayaDesdePopup = function (plyID) {
        const playa = playas.find(p => p.plyID === plyID);
        if (!playa) return;

        // Abrir el popup del marcador si existe
        const mk = playaIdToMarker.get(plyID);
        if (mk) mk.openPopup();

        // Mostrar el detalle en el footer
        seleccionarPlaya(playa);
        };

        window.agregarFavoritaDesdePopup = function (plyID) {
        const playa = playas.find(p => p.plyID === plyID);
        if (!playa) return alert('No se pudo guardar la playa como favorita.');

        const apodo = prompt('¬øC√≥mo quer√©s llamar a esta playa favorita?', playa.plyNom);
        if (apodo == null || apodo.trim() === '') return;

        const payload = {
            apodo: apodo.trim(),
            provincia: playa.plyProv || '',
            ciudad: playa.plyCiu || '',
            direccion: playa.plyDir || '',
            tipo: 'Playa',
            lat: playa.plyLat,
            lon: playa.plyLon
        };

        guardarUbicacionFavorita(payload).then(() => refreshFavoritesUI());
        };

        // === Refrescar UI de favoritos (lista + estrellas en el mapa) ===
        function refreshFavoritesUI() {
        cargarUbicacionesFavoritas(); // recarga lista + marcadores del mapa
        }


        window.agregarFavoritaDesdePopup = function(plyID){
            const playa = playas.find(p => p.plyID === plyID);
            if (!playa) return alert('No se pudo guardar la playa como favorita.');
            const apodo = prompt('¬øC√≥mo quer√©s llamar a esta playa favorita?', playa.plyNom);
            if (apodo == null || apodo.trim() === '') return;
            const payload = { apodo: apodo.trim(), provincia: playa.plyProv || '', ciudad: playa.plyCiu || '', direccion: playa.plyDir || '', tipo:'Playa', lat: playa.plyLat, lon: playa.plyLon };
            guardarUbicacionFavorita(payload).then(() => cargarUbicacionesFavoritas());
        };
        if (d.success) {
            fav.apodo = nuevoApodo.trim();
            refreshFavoritesUI(); // en vez de solo renderizar
        }

        function buildPopupContent(playa, esResultadoBusqueda = false){
            return `
                <div style="min-width:220px;">
                    <h6 style="margin:0 0 10px;color:#2c3e50;">${playa.plyNom}</h6>
                    <p style="margin:5px 0;font-size:14px;"><strong>Direcci√≥n:</strong> ${playa.plyDir || ''}</p>
                    <p style="margin:5px 0;font-size:14px;"><strong>Disponibilidad:</strong> ${playa.disponibilidad ?? '‚Äî'}%</p>
                    <p style="margin:5px 0;font-size:14px;"><strong>Estado:</strong> ${playa.estaAbierto ? 'Abierto' : 'Cerrado'}</p>
                    ${esResultadoBusqueda && typeof playa.distancia === 'number' ? `
                        <p style="margin:5px 0;font-size:14px;color:#dc3545;"><strong>üìç Distancia:</strong> ${playa.distancia.toFixed(2)} km</p>
                        <p style="margin:5px 0;font-size:12px;color:#dc3545;font-weight:bold;">üîç Uno de los 3 m√°s cercanos</p>
                    ` : ''}

                    <div class="d-flex gap-1 mt-2">
                        <button class="btn btn-sm btn-primary flex-fill" onclick="window.seleccionarPlayaDesdePopup(${playa.plyID})">Ver detalles</button>
                        <button class="btn btn-sm btn-outline-warning flex-fill" onclick="window.agregarFavoritaDesdePopup(${playa.plyID})">‚òÖ Favorito</button>
                    </div>
                </div>
            `;
        }

        function seleccionarPlaya(playa){
            playaSeleccionada = playa;
            map.setView([playa.plyLat, playa.plyLon], 16);

            $.get('/Conductor/GetDetallePlaya', { id: playa.plyID })
             .done(detalle => {
                 mostrarDetallePlaya(detalle);
                 $('#bottomMenu').addClass('show');
                 // abrir popup (marker o temporal)
                 openMarkerPopup({ ...detalle, plyLat: detalle.plyLat ?? playa.plyLat, plyLon: detalle.plyLon ?? playa.plyLon });
             })
             .fail(() => {
                 mostrarDetallePlayaBasico(playa);
                 $('#bottomMenu').addClass('show');
                 openMarkerPopup(playa);
             });
        }

        function mostrarDetallePlaya(detalle){
            $('#playaNombre').text(detalle.plyNom);
            $('#estadoBadge').text(detalle.estaAbierto ? 'Abierto' : 'Cerrado').removeClass('open closed').addClass(detalle.estaAbierto ? 'open' : 'closed');
            const ocupacion = 100 - detalle.disponibilidad;
            $('#disponibilidadTexto').text(ocupacion + '% ocupado'); $('#disponibilidadBarra').css('width', ocupacion + '%');
            $('#tipoPiso').text(detalle.plyTipoPiso); $('#direccion').text(detalle.plyDir);
            $('#valorPromedio').text('$' + (parseFloat(detalle.plyValProm || 0).toFixed(2)) + '/hora');

            let horariosHtml = '<div style="margin-top:5px;">', tiene=false;
            if (detalle.horariosLunesViernes?.length){ tiene=true; horariosHtml += '<div style="margin-bottom:5px;"><strong>Lunes a Viernes:</strong> ' + detalle.horariosLunesViernes.map(h=>`${h.horaInicio} - ${h.horaFin}`).join(', ') + '</div>'; }
            if (detalle.horariosFinSemana?.length){ tiene=true; horariosHtml += '<div style="margin-bottom:5px;"><strong>S√°bado Domingo:</strong> ' + detalle.horariosFinSemana.map(h=>`${h.horaInicio} - ${h.horaFin}`).join(', ') + '</div>'; }
            horariosHtml += '</div>';
            $('#horariosInfo').html(tiene ? horariosHtml : '<span style="color:#dc3545;">No hay horarios configurados</span>');
            $('#horariosSection').show(); $('#debugInfoSection').hide(); $('#playaInfo').show();
        }

        function mostrarDetallePlayaBasico(playa){
            $('#playaNombre').text(playa.plyNom);
            $('#estadoBadge').text(playa.estaAbierto ? 'Abierto' : 'Cerrado').removeClass('open closed').addClass(playa.estaAbierto ? 'open' : 'closed');
            const ocupacion = 100 - playa.disponibilidad; $('#disponibilidadTexto').text(ocupacion + '% ocupado'); $('#disponibilidadBarra').css('width', ocupacion + '%');
            $('#tipoPiso').text(playa.plyTipoPiso); $('#direccion').text(playa.plyDir);
            $('#valorPromedio').text('$' + (parseFloat(playa.plyValProm || 0).toFixed(2)) + '/hora');
            $('#playaInfo').show();
        }

        function closeMenu(){ $('#bottomMenu').removeClass('show'); playaSeleccionada = null; }
        function centerOnConductor(){ map.setView([conductorLat, conductorLon], 15); }
        function abrirNavegacion(){ if (playaSeleccionada) window.open(`https://www.google.com/maps/dir/?api=1&destination=${playaSeleccionada.plyLat},${playaSeleccionada.plyLon}`, '_blank'); }

        function buscarDireccion(){
            const direccion = $('#searchInput').val().trim();
            if (!direccion) return alert('Por favor ingresa una direcci√≥n');
            $('#clearBtn').addClass('show');
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion + ', Resistencia, Chaco')}&limit=1`;
            $('#loading').show();
            $.get(url)
             .done(data => {
                 if (data?.length){
                    const lat = parseFloat(data[0].lat), lon = parseFloat(data[0].lon);
                    map.setView([lat, lon], 15);
                    buscarPlayasCercanas(lat, lon);
                 } else { alert('No se encontr√≥ la direcci√≥n.'); $('#loading').hide(); }
             })
             .fail(()=>{ alert('Error al buscar la direcci√≥n.'); $('#loading').hide(); });
        }

        function buscarPlayasCercanas(lat, lon){
            $.get('/Conductor/GetPlayasCercanas', { lat, lon, radioKm:10 })
             .done(data => {
                 searchResults = (data || []).sort((a,b)=>a.distancia - b.distancia).slice(0,3);
                 if (searchLocationMarker) map.removeLayer(searchLocationMarker);
                 searchLocationMarker = L.marker([lat, lon], { icon: L.divIcon({ className:'search-location-marker', html:'<i class="fa-solid fa-location-dot" style="color:#dc3545;font-size:24px;text-shadow:2px 2px 4px rgba(0,0,0,.3);"></i>', iconSize:[30,30], iconAnchor:[15,15] }) }).addTo(map);
                 searchLocationMarker.bindPopup('<b>Ubicaci√≥n buscada</b><br>Direcci√≥n: ' + $('#searchInput').val()).openPopup();
                 isSearchMode = true; mostrarPlayasEnMapa(); $('#loading').hide();
             })
             .fail(()=> $('#loading').hide());
        }

        function volverAVistaNormal(){
            isSearchMode = false; searchResults = []; $('#searchInput').val(''); $('#clearBtn').removeClass('show');
            if (searchLocationMarker){ map.removeLayer(searchLocationMarker); searchLocationMarker = null; }
            cargarPlayas();
        }
        function limpiarBusqueda(){ $('#searchInput').val(''); $('#clearBtn').removeClass('show'); volverAVistaNormal(); }

        function inicializarEscalaPersonalizada(){ map.on('zoomend', actualizarEscala); map.on('moveend', actualizarEscala); actualizarEscala(); }
        function actualizarEscala(){
            if (!map?.getCenter) return;
            try{
                const d = map.containerPointToLatLng([0,0]).distanceTo(map.containerPointToLatLng([100,0]));
                let text='1 km';
                if (d >= 1000) text = Math.round(d/1000) + ' km';
                else if (d >= 100) text = Math.round(d/100)*100 + ' m';
                else if (d >= 10) text = Math.round(d/10)*10 + ' m';
                else text = Math.round(d) + ' m';
                $('#scaleText').text(text); $('#scaleLine').css('width', '100px');
            } catch(e){ $('#scaleText').text('1 km'); $('#scaleLine').css('width','100px'); }
        }

        /* ===== Favoritos (panel) ===== */
        function toggleFavorites(){
            const panel = document.getElementById('favoritesPanel');
            const icon = document.getElementById('favoritesToggleIcon');
            panel.classList.toggle('collapsed');
            if (panel.classList.contains('collapsed')){ icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-up'); }
            else { icon.classList.remove('fa-chevron-up'); icon.classList.add('fa-chevron-down'); }
        }

        function guardarUbicacionFavorita(ubicacion){
            return fetch('@Url.Action("AgregarUbicacionFavorita", "Conductor")', {
                method:'POST', headers:{ 'Content-Type':'application/json', 'RequestVerificationToken': antiforgeryToken }, body: JSON.stringify(ubicacion)
            }).then(r=>r.json()).then(d=>{
                if (d.success) alert('Ubicaci√≥n favorita guardada correctamente.');
                else alert(d.error || 'No se pudo guardar la ubicaci√≥n favorita.');
                return d;
            }).catch(()=> alert('Ocurri√≥ un error al guardar la ubicaci√≥n favorita.'));
        }

        function cargarUbicacionesFavoritas(){
            $.get('@Url.Action("GetUbicacionesFavoritas", "Conductor")')
             .done(data => { if (data && !data.error){ favoritos = data; renderizarFavoritos(); mostrarFavoritosEnMapa(); }});
        }

        function renderizarFavoritos(){
            const lista = document.getElementById('listaFavoritos');
            const mensajeVacio = document.getElementById('favoritosVacio');
            lista.innerHTML = '';
            if (!favoritos?.length){ mensajeVacio.style.display = 'block'; return; }
            mensajeVacio.style.display = 'none';

            favoritos.forEach(fav => {
                const li = document.createElement('li'); li.classList.add('favorite-item');

                const mainBtn = document.createElement('button');
                mainBtn.type = 'button'; mainBtn.className = 'favorite-main-btn';
                mainBtn.innerHTML = `<span>${fav.apodo}</span><span>${fav.direccion || (fav.ciudad || '')}</span>`;
                mainBtn.onclick = () => irAFavorito(fav);

                const viewBtn = document.createElement('button');
                viewBtn.type = 'button'; viewBtn.className = 'favorite-view-btn'; viewBtn.innerHTML = '<i class="fa-solid fa-eye"></i>';
                viewBtn.onclick = (e)=>{ e.stopPropagation(); irAFavorito(fav); };

                const editBtn = document.createElement('button');
                editBtn.type = 'button'; editBtn.className = 'favorite-edit-btn'; editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
                editBtn.onclick = (e)=>{ e.stopPropagation(); editarFavorito(fav); };

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button'; removeBtn.className = 'favorite-remove-btn'; removeBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                removeBtn.onclick = (e)=>{ e.stopPropagation(); eliminarFavorito(fav); };

                li.appendChild(mainBtn); li.appendChild(viewBtn); li.appendChild(editBtn); li.appendChild(removeBtn);
                lista.appendChild(li);
            });
        }

        function irAFavorito(fav){
            const lat = parseFloat(fav.lat ?? fav.ubfLat ?? fav.UbfLat);
            const lon = parseFloat(fav.lon ?? fav.ubfLon ?? fav.UbfLon);
            if (isNaN(lat) || isNaN(lon)) return alert('Este favorito no tiene coordenadas v√°lidas.');

            map.setView([lat, lon], 16);
            $('#loading').show();

            // ¬øExiste ya alguna playa en memoria en esas coords?
            const playaCoincidente = playas.find(p => p.plyLat && p.plyLon && Math.abs(parseFloat(p.plyLat)-lat) < 0.0001 && Math.abs(parseFloat(p.plyLon)-lon) < 0.0001);

            if (playaCoincidente){
                $('#loading').hide();
                seleccionarPlaya(playaCoincidente);
                openMarkerPopup(playaCoincidente);
                return;
            }

            // Buscar en servidor
            $.get('/Conductor/GetPlayasCercanas', { lat, lon, radioKm:2 })
             .done(data => {
                 $('#loading').hide();
                 if (data?.length){
                    const playa = data[0];
                    seleccionarPlaya(playa);
                    setTimeout(()=> openMarkerPopup(playa), 300);
                 } else {
                    // No hay playas ‚Üí mostrar datos del favorito y popup de ubicaci√≥n
                    $('#playaNombre').text(fav.apodo);
                    $('#estadoBadge').text('N/A').removeClass('open closed');
                    $('#disponibilidadTexto').text('Sin datos'); $('#disponibilidadBarra').css('width','0%');
                    $('#tipoPiso').text('No disponible'); $('#direccion').text(fav.direccion || fav.ciudad || ''); $('#valorPromedio').text('N/A');
                    $('#horariosInfo').html('<span style="color:#dc3545;">Sin playas cercanas</span>'); $('#horariosSection').show(); $('#playaInfo').show(); $('#bottomMenu').addClass('show');

                    if (transientPopup) map.closePopup(transientPopup);
                    transientPopup = L.popup().setLatLng([lat, lon]).setContent(`<strong>${fav.apodo}</strong><br>${fav.direccion || ''}`).openOn(map);
                 }
                 setTimeout(()=> map.invalidateSize(), 200);
             })
             .fail(()=> $('#loading').hide());
        }

        function eliminarFavorito(fav) {
            if (!confirm(`¬øEliminar "${fav.apodo}" de tus favoritos?`)) return;

            $.ajax({
                url: '@Url.Action("EliminarUbicacionFavorita", "Conductor")' + '?apodo=' + encodeURIComponent(fav.apodo),
                type: 'DELETE'
            })
            .done(function(data) {
            if (data.success) {
                favoritos = favoritos.filter(f => f.apodo !== fav.apodo);
                refreshFavoritesUI(); // üëà tambi√©n se actualiza
            } else {
                alert(data.error || 'No se pudo eliminar el favorito.');
            }
            })

            .fail(function() {
                alert('Ocurri√≥ un error al eliminar el favorito.');
            });
        }


        function refreshFavoritesUI() {
            renderizarFavoritos();
            mostrarFavoritosEnMapa(); // limpia y vuelve a dibujar estrellas seg√∫n "favoritos"
        }

        function editarFavorito(fav){
            const nuevo = prompt('Nuevo nombre para esta ubicaci√≥n favorita:', fav.apodo);
            if (nuevo == null) return;
            if (nuevo.trim() === '') return alert('El nombre no puede estar vac√≠o.');
            fetch('@Url.Action("EditarUbicacionFavorita", "Conductor")', {
                method:'POST', headers:{ 'Content-Type':'application/json', 'RequestVerificationToken': antiforgeryToken },
                body: JSON.stringify({ apodoActual: fav.apodo, nuevoApodo: nuevo.trim() })
            }).then(r=>r.json()).then(d=>{
                if (d.success){ fav.apodo = nuevoApodo.trim(); refreshFavoritesUI(); }
                else alert(d.error || 'No se pudo renombrar la ubicaci√≥n favorita.');
            }).catch(()=> alert('Ocurri√≥ un error al renombrar la ubicaci√≥n favorita.'));
        }

        // Teclado
        $(document).keydown(function(e){
            if (e.key === 'Escape') closeMenu();
            if (e.key === 'c' || e.key === 'C') centerOnConductor();
        });
    </script>
</body>
</html>