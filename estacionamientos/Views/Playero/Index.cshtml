@using estacionamientos.ViewModels
@model PlayeroIndexFilterVM

@{
    ViewData["Title"] = "Playeros";

    string LabelFiltro(string v) => v?.ToLower() switch {
        "nombre" => "Nombre",
        "playa" => "Playa",
        _ => "Todos"
    };

    bool showAddButton = !string.IsNullOrWhiteSpace(Model.Q) && Model.FilterBy != "playa";

    var ultMovimientos = ViewBag.ultMovimientos as List<MovimientoPlayero>;
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />

<div class="container">
    <!-- Encabezado: título a la izquierda, botones a la derecha -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Playeros</h1>
    </div>

    <!-- Formulario de búsqueda/filtros -->
    <form method="get" id="searchForm" class="row g-2 align-items-center mb-3">
        <!-- Campo de texto -->
        <div class="col-md-5 @(Model.FilterBy == "playa" ? "d-none" : "")" id="qWrapper">
            <input name="Q" id="qInput" value="@Model.Q" class="form-control" placeholder="Buscar playeros..." />
        </div>

        <!-- Dropdown de playas -->
        <div class="col-md-5 @(Model.FilterBy == "playa" ? "" : "d-none")" id="playaWrapper">
            <select name="SelectedPlaya" id="playaSelect" class="form-select">
                <option value="">Seleccionar playa...</option>
                @if (ViewBag.PlayasDelDuenio != null)
                {
                    @foreach (var playa in ViewBag.PlayasDelDuenio)
                    {
                        <option value="@playa.Nombre">@playa.Nombre</option>
                    }
                }
            </select>
        </div>

        <!-- Botón Filtrar -->
        <div class="col-auto">
            <div class="btn-group">
                <input type="hidden" name="FilterBy" id="filterBy" value="@Model.FilterBy" />
                <button type="button" class="btn btn-outline-secondary dropdown-toggle"
                        data-bs-toggle="dropdown" aria-expanded="false" id="filterBtn">
                    <i class="fa-solid fa-filter"></i> Filtrar: @LabelFiltro(Model.FilterBy)
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" data-value="todos">Todos</a></li>
                    <li><a class="dropdown-item" href="#" data-value="nombre">Nombre</a></li>
                    <li><a class="dropdown-item" href="#" data-value="playa">Playa</a></li>
                </ul>
            </div>
        </div>

        <!-- Buscar + Limpiar -->
        <div class="col-auto">
            <button type="submit" class="btn btn-secondary" title="Buscar">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
            <a id="btnLimpiar"
               class="btn btn-outline-secondary @(Model.HayFiltros ? "" : "d-none")"
               asp-action="Index"
               title="Limpiar filtros">
                <i class="fa-regular fa-circle-xmark"></i>
            </a>
        </div>

        <!-- Botón Agregar Playero alineado a la derecha -->
        <div class="col-auto ms-auto">
            <a class="btn btn-primary" asp-controller="Playero" asp-action="Create" title="Agregar playero">
                <i class="fa-solid fa-plus"></i> Agregar playero
            </a>
            <a class="btn btn-outline-secondary ms-2" asp-controller="Playero" asp-action="HistorialAgrupado">
                <i class="fa-solid fa-clock-rotate-left"></i> Historial
            </a>
        </div>

        <!-- Botón Añadir filtro -->
        <div class="w-100"></div>
        <div class="col-md-5 mt-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnAddOne" disabled>
                Añadir filtro
            </button>
        </div>

        <!-- Inputs ocultos para preservar filtros acumulados -->
        @for (int i = 0; i < Model.Nombres.Count; i++)
        {
            <input type="hidden" name="Nombres[@i]" value="@Model.Nombres[i]" />
        }
        @for (int i = 0; i < Model.Playas.Count; i++)
        {
            <input type="hidden" name="Playas[@i]" value="@Model.Playas[i]" />
        }
        @for (int i = 0; i < Model.Todos.Count; i++)
        {
            <input type="hidden" name="Todos[@i]" value="@Model.Todos[i]" />
        }
    </form>

    <!-- Badges de filtros acumulados -->
    @if ((Model.Nombres?.Any() ?? false) || (Model.Playas?.Any() ?? false) || (Model.Todos?.Any() ?? false))
    {
        <div class="mb-3 d-flex flex-wrap gap-2">
            @* TODOS *@
            @if (Model.Todos != null)
            {
                @foreach (var v in Model.Todos)
                {
                    <span class="badge rounded-pill text-bg-light border">
                        @v
                        <a class="ms-2 text-decoration-none"
                          asp-action="Index"
                          asp-route-Q="@Model.Q"
                          asp-route-FilterBy="@Model.FilterBy"
                          asp-route-Remove="todos:@v"
                          asp-route-Nombres="@(string.Join(",", Model.Nombres ?? new List<string>()))"
                          asp-route-Playas="@(string.Join(",", Model.Playas ?? new List<string>()))"
                          asp-route-Todos="@(string.Join(",", Model.Todos ?? new List<string>()))"
                          title="Quitar">
                            <i class="fa-regular fa-circle-xmark"></i>
                        </a>
                    </span>
                }
            }

            @* NOMBRES *@
            @if (Model.Nombres != null)
            {
                @foreach (var v in Model.Nombres)
                {
                    <span class="badge rounded-pill text-bg-light border">
                        @v
                        <a class="ms-2 text-decoration-none"
                          asp-action="Index"
                          asp-route-Q="@Model.Q"
                          asp-route-FilterBy="@Model.FilterBy"
                          asp-route-Remove="nombre:@v"
                          asp-route-Nombres="@(string.Join(",", Model.Nombres ?? new List<string>()))"
                          asp-route-Playas="@(string.Join(",", Model.Playas ?? new List<string>()))"
                          asp-route-Todos="@(string.Join(",", Model.Todos ?? new List<string>()))"
                          title="Quitar">
                            <i class="fa-regular fa-circle-xmark"></i>
                        </a>
                    </span>
                }
            }

            @* PLAYAS *@
            @if (Model.Playas != null)
            {
                @foreach (var v in Model.Playas)
                {
                    <span class="badge rounded-pill text-bg-light border">
                        @v
                        <a class="ms-2 text-decoration-none"
                          asp-action="Index"
                          asp-route-Q="@Model.Q"
                          asp-route-FilterBy="@Model.FilterBy"
                          asp-route-Remove="playa:@v"
                          asp-route-Nombres="@(string.Join(",", Model.Nombres ?? new List<string>()))"
                          asp-route-Playas="@(string.Join(",", Model.Playas ?? new List<string>()))"
                          asp-route-Todos="@(string.Join(",", Model.Todos ?? new List<string>()))"
                          title="Quitar">
                            <i class="fa-regular fa-circle-xmark"></i>
                        </a>
                    </span>
                }
            }
        </div>
    }

    <table id="playerosTable" class="table table-striped table-hover table-sm align-middle text-center mt-3">
        <thead>
            <tr>
                <th class="text-center">Nombre</th>
                <th class="text-center">Playas asignadas</th>
                <th class="text-center">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Playeros is { Count: > 0 })
            {
                foreach (var row in Model.Playeros)
                {
                    var p = row.Playero;
                    <tr>
                        <td>@p.UsuNyA</td>
                        <td>
                            @if (row.Playas.Count == 0)
                            {
                                <span class="text-muted">Sin asignaciones</span>
                            }
                            else
                            {
                                foreach (var playa in row.Playas)
                                {
                                    var etiqueta = !string.IsNullOrWhiteSpace(playa.PlyNom)
                                    ? playa.PlyNom
                                    : $"{playa.PlyCiu} - {playa.PlyDir}";

                                    <!-- Desasignar (marca histórico) -->
                                        <div class="playa-chip">
                                            @etiqueta
                                        <button type="button"
                                                    class="remove-btn"
                                                    title="Desasignar"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#confirmUnassignModal"
                                                data-playero-id="@p.UsuNU"
                                                data-playero-name="@p.UsuNyA"
                                                data-playa-id="@playa.PlyID"
                                                data-playa-name="@etiqueta">
                                                <i class="fa-regular fa-circle-xmark"></i>
                                            </button>
                                        </div>
                                }
                            }
                        </td>
                        <td class="text-center">
                            <!-- Comentado el editar playero porque no considero que esté bien -->
                            <!--
                            <a class="btn btn-outline-primary btn-sm me-2" asp-controller="Playero" asp-action="Edit"
                                asp-route-id="@p.UsuNU" title="Editar">
                                        <i class="fa-regular fa-pen-to-square"></i>
                            </a>
                            -->
                            <a class="btn btn-outline-secondary btn-sm me-2" asp-controller="Playero" asp-action="Assign"
                                asp-route-id="@p.UsuNU" title="Vincular a una playa">
                                <i class="fa-solid fa-link"></i>
                            </a>

                            <button type="button" 
                                    class="btn btn-outline-danger btn-sm"
                                    title="Desvincular todas las playas"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#confirmUnlinkModal"
                                    data-playero-id="@p.UsuNU"
                                    data-playero-name="@p.UsuNyA">
                                <i class="fa-solid fa-link-slash"></i>
                            </button>

                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="3" class="text-center text-muted">
                        No tenés playeros asignados en tus playas.
                    </td>
                </tr>
            }
        </tbody>
    </table>


    <!-- Tabla ultimos movimientos general -->
    <div class="card shadow-sm mt-5">
        <div class="card-header bg-light fw-bold text-center fs-5">
            Últimos movimientos
        </div>

        <div class="d-flex justify-content-between gap-3 card-body pb-0">
            <!-- Botón para mostrar/ocultar filtros -->
            <div class="text-end mb-3">
                <button class="btn btn-outline-secondary btn-sm" style="" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse" aria-expanded="false" aria-controls="filtrosCollapse">
                    Mostrar filtros
                    <i class="fa-solid fa-caret-down"></i>
                </button>
            </div>

            <!-- Filtros -->
            <div class="collapse flex-fill" id="filtrosCollapse">
                <form class="d-flex gap-5 justify-content-center align-items-end mb-3 px-3 py-2" id="filtrosForm" style="background-color: #f5f5f5; border-radius: 5px;">
                    <div class="">
                        <label for="filtroFechaDesde" class="form-label mb-1 fs-6">Fecha desde</label>
                        <input type="date" id="filtroFechaDesde" class="form-control form-control-sm" style="width: max-content" />
                    </div>
                    <div class="">
                        <label for="filtroFechaHasta" class="form-label mb-1 fs-6">Fecha hasta</label>
                        <input type="date" id="filtroFechaHasta" class="form-control form-control-sm" style="width: max-content" />
                    </div>
                    <div class="">
                        <label for="filtroPlaya" class="form-label mb-1 fs-6">Playa</label>
                        <input type="text" id="filtroPlaya" class="form-control form-control-sm" style="width: max-content" placeholder="Nombre de playa" />
                    </div>
                    <div class="">
                        <label for="filtroPlayero" class="form-label mb-1 fs-6">Playero</label>
                        <input type="text" id="filtroPlayero" class="form-control form-control-sm" style="width: max-content" placeholder="Nombre de playero" />
                    </div>

                    <div class="text-end mt-2">
                        <button id="btnLimpiarMov" type="button" class="btn btn-outline-secondary btn-sm">Limpiar filtros</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card-body p-0">
            @if (ultMovimientos is { Count: > 0 })
            {
                <ul id="listaMovimientos" class="list-group list-group-flush">
                    @foreach (var m in ultMovimientos)
                    {
                        string textoTipoMov = m.TipoMov switch
                        {
                            TipoMovimiento.IngresoVehiculo => $"ingresó el vehículo <span class='fw-semibold'>{m.VehPtnt}</span> a la plaza",
                            TipoMovimiento.EgresoVehiculo => $"egresó el vehículo <span class='fw-semibold'>{m.VehPtnt}</span> de la plaza",
                            TipoMovimiento.ReubicacionVehiculo => $"movió el vehículo <span class='fw-semibold'>{m.VehPtnt}</span> a la plaza",
                            _ => "realizó un movimiento"
                        };

                        <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start py-3 px-4 border-0 border-bottom movimiento"
                            data-fecha="@m.FechaMov.ToString("yyyy-MM-dd")"
                            data-playa="@m.Playa?.PlyNom"
                            data-playero="@m.Playero?.UsuNyA">
                            <div>
                                <span class="fw-semibold">@m.Playero?.UsuNyA</span>
                                <span>@Html.Raw(textoTipoMov)</span>
                                <span class="fw-semibold">@m.PlzNum</span>
                            </div>
                            <small class="text-muted mt-2 mt-md-0">@m.Playa?.PlyNom - @m.FechaMov.ToString("dd/MM/yyyy HH:mm")</small>
                        </li>
                    }
                </ul>

                <div id="pagination-controls" class="d-flex justify-content-center my-3"></div>
            }
            else
            {
                <div class="text-center text-muted p-4">
                    No hay movimientos recientes.
                </div>
            }
        </div>
    </div>


    <!-- Modal de confirmación para desvincular playero de todas las playas -->
    <div class="modal fade" id="confirmUnlinkModal" tabindex="-1" aria-labelledby="confirmUnlinkModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmUnlinkModalLabel">Confirmar desvinculación total</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres desvincular este playero de todas sus playas?</p>
                    <p class="mb-0"><strong>Playero:</strong> <span id="playeroName"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <form id="confirmUnlinkForm" asp-controller="Playero" asp-action="Delete" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="playeroId" name="id" />
                        <button type="submit" class="btn btn-danger">Desvincular</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para desvincular playero de una playa específica -->
    <div class="modal fade" id="confirmUnassignModal" tabindex="-1" aria-labelledby="confirmUnassignModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmUnassignModalLabel">Confirmar desvinculación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres desvincular este playero de esta playa?</p>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="mb-1"><strong>Playero:</strong> <span id="unassignPlayeroName"></span></p>
                            <p class="mb-0"><strong>Playa:</strong> <span id="unassignPlayaName"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <form id="confirmUnassignForm" asp-controller="Playero" asp-action="Unassign" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="unassignPlayeroId" name="plaNU" />
                        <input type="hidden" id="unassignPlayaId" name="plyID" />
                        <button type="submit" class="btn btn-danger">Desvincular</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .playa-chip {
        display: inline-flex;
        align-items: center;
        background: #f1f8ff;
        /* azul muy claro */
        color: #1b3a68;
        /* azul Bootstrap */
        border: 1px solid #0f2647;
        border-radius: 999px;
        padding: 0.25rem 0.6rem;
        font-size: .85rem;
        margin: 0.15rem;
    }

    .playa-chip .remove-btn {
        background: none;
        border: none;
        color: #dc3545;
        /* rojo Bootstrap */
        margin-left: .4rem;
        padding: 0;
        cursor: pointer;
    }

    .playa-chip .remove-btn:hover {
        color: #a71d2a;
    }
</style>

@section Scripts {
    <script>
        const mapLbl = {todos:'Todos', nombre:'Nombre', playa:'Playa'};

        // Habilita/oculta inputs de búsqueda según el filtro elegido y actualiza la etiqueta
        function updateFilterUI() {
            const fb = document.getElementById('filterBy').value;
            const qW = document.getElementById('qWrapper');
            const pW = document.getElementById('playaWrapper');
            const qI = document.getElementById('qInput');
            const pS = document.getElementById('playaSelect');

            if (fb === 'playa') {
                qW?.classList.add('d-none');
                pW?.classList.remove('d-none');
                if (qI) qI.value = '';
            } else {
                pW?.classList.add('d-none');
                if (pS) pS.value = '';
                qW?.classList.remove('d-none');
            }

            document.getElementById('filterBtn').innerHTML =
                '<i class="fa-solid fa-filter"></i> Filtrar: ' + (mapLbl[fb] || 'Todos');

            toggleLimpiar();
            toggleAddButton();
        }

        // Muestra/oculta el botón "Limpiar" según haya algo que limpiar
        function toggleLimpiar() {
            const fb = document.getElementById('filterBy')?.value || 'todos';
            const q = document.getElementById('qInput')?.value?.trim() || '';
            const pS = document.getElementById('playaSelect')?.value?.trim() || '';
            const show = (fb && fb !== 'todos') || q.length > 0 || pS.length > 0;
            const limpiar = document.getElementById('btnLimpiar');
            if (limpiar) limpiar.classList.toggle('d-none', !show);
        }

        // ¿Hay algo que se pueda añadir como filtro según el tipo actual?
        function canAddCurrent() {
            const fb = document.getElementById('filterBy')?.value || 'todos';
            const q = document.getElementById('qInput')?.value?.trim() || '';
            const pS = document.getElementById('playaSelect')?.value?.trim() || '';
            
            if (fb === 'playa') {
                return pS.length > 0;
            } else {
                return q.length > 0;
            }
        }

        // Habilita/Deshabilita el botón "Añadir filtro"
        function toggleAddButton() {
            const btn = document.getElementById('btnAddOne');
            if (btn) btn.disabled = !canAddCurrent();
        }

        // Manejar el botón "Añadir filtro"
        document.getElementById('btnAddOne')?.addEventListener('click', function() {
            const fb = document.getElementById('filterBy')?.value || 'todos';
            const q = document.getElementById('qInput')?.value?.trim() || '';
            const pS = document.getElementById('playaSelect')?.value?.trim() || '';
            
            if (fb === 'playa' && pS.length > 0) {
                // Para playas, agregar la playa seleccionada como filtro
                const url = new URL(window.location);
                url.searchParams.append('Playas', pS);
                url.searchParams.delete('SelectedPlaya');
                url.searchParams.set('FilterBy', 'todos');
                window.location.href = url.toString();
            } else if (q.length > 0) {
                // Para otros filtros, agregar el valor según el tipo
                const url = new URL(window.location);
                
                if (fb === 'nombre') {
                    url.searchParams.append('Nombres', q);
                } else {
                    // Para "todos", agregar a la lista "Todos" para mantener la búsqueda flexible
                    url.searchParams.append('Todos', q);
                }
                
                url.searchParams.delete('Q');
                url.searchParams.set('FilterBy', 'todos');
                window.location.href = url.toString();
            }
        });

        // Manejar el modal de confirmación para desvincular playero
        document.addEventListener('DOMContentLoaded', function() {
            // Modal para desvincular de todas las playas
            const confirmUnlinkModal = document.getElementById('confirmUnlinkModal');
            const playeroNameSpan = document.getElementById('playeroName');
            const playeroIdInput = document.getElementById('playeroId');

            if (confirmUnlinkModal) {
                confirmUnlinkModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const playeroId = button.getAttribute('data-playero-id');
                    const playeroName = button.getAttribute('data-playero-name');

                    // Actualizar el contenido del modal
                    playeroNameSpan.textContent = playeroName;
                    playeroIdInput.value = playeroId;
                });
            }

            // Modal para desvincular de una playa específica
            const confirmUnassignModal = document.getElementById('confirmUnassignModal');
            const unassignPlayeroNameSpan = document.getElementById('unassignPlayeroName');
            const unassignPlayaNameSpan = document.getElementById('unassignPlayaName');
            const unassignPlayeroIdInput = document.getElementById('unassignPlayeroId');
            const unassignPlayaIdInput = document.getElementById('unassignPlayaId');

            if (confirmUnassignModal) {
                confirmUnassignModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const playeroId = button.getAttribute('data-playero-id');
                    const playeroName = button.getAttribute('data-playero-name');
                    const playaId = button.getAttribute('data-playa-id');
                    const playaName = button.getAttribute('data-playa-name');

                    // Actualizar el contenido del modal
                    unassignPlayeroNameSpan.textContent = playeroName;
                    unassignPlayaNameSpan.textContent = playaName;
                    unassignPlayeroIdInput.value = playeroId;
                    unassignPlayaIdInput.value = playaId;
                });
            }

            @* Script filtros movimientos *@
            const fechaDesdeInput = document.getElementById('filtroFechaDesde');
            const fechaHastaInput = document.getElementById('filtroFechaHasta');
            const playaInput = document.getElementById('filtroPlaya');
            const playeroInput = document.getElementById('filtroPlayero');
            const limpiarBtn = document.getElementById('btnLimpiarMov');
            const movimientos = Array.from(document.querySelectorAll('.movimiento'));

            // parsea 'yyyy-mm-dd' a Date
            function parseIsoDate(value) {
                if (!value) return null;
                const parts = value.split('-');
                if (parts.length !== 3) return null;
                return new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
            }

            function fechaEnRango(fechaStr, desdeDate, hastaDate) {
                if (!fechaStr) return true;
                const itemDate = parseIsoDate(fechaStr);
                if (!itemDate) return true;
                if (desdeDate && itemDate < desdeDate) return false;
                if (hastaDate) {
                    // incluir todo el día
                    hastaDate.setHours(23, 59, 59, 999);
                    if (itemDate > hastaDate) return false;
                }
                return true;
            }

            function filtrar() {
                const fechaDesdeVal = fechaDesdeInput.value;
                const fechaHastaVal = fechaHastaInput.value;
                const playaVal = (playaInput.value || '').trim().toLowerCase();
                const playeroVal = (playeroInput.value || '').trim().toLowerCase();

                const desdeDate = parseIsoDate(fechaDesdeVal);
                const hastaDate = parseIsoDate(fechaHastaVal);

                movimientos.forEach(m => {
                    const mFecha = (m.dataset.fecha || '').trim();
                    const textoCompleto = m.textContent.toLowerCase(); // toma todo el texto visible del <li>

                    const okFecha = fechaEnRango(mFecha, desdeDate, hastaDate);
                    const okPlaya = !playaVal || textoCompleto.includes(playaVal.toLowerCase());
                    const okPlayero = !playeroVal || textoCompleto.includes(playeroVal.toLowerCase());

                    m.style.display = (okFecha && okPlaya && okPlayero) ? '' : 'none';
                });

                // mensaje "no hay movimientos"
                const anyVisible = movimientos.some(m => m.style.display !== 'none');
                const lista = document.getElementById('listaMovimientos');
                if (lista) {
                    let noItemsEl = document.getElementById('noMovimientosMsg');
                    if (!anyVisible) {
                        if (!noItemsEl) {
                            noItemsEl = document.createElement('div');
                            noItemsEl.id = 'noMovimientosMsg';
                            noItemsEl.className = 'text-center text-muted p-4';
                            noItemsEl.textContent = 'No hay movimientos que coincidan con los filtros.';
                            lista.parentNode.insertBefore(noItemsEl, lista.nextSibling);
                        }
                        lista.style.display = 'none';
                    } else {
                        if (noItemsEl) noItemsEl.remove();
                        lista.style.display = '';
                    }
                }
            }

            // listeners
            [fechaDesdeInput, fechaHastaInput, playaInput, playeroInput].forEach(el => {
                if (!el) return;
                el.addEventListener('input', filtrar);
            });

            // bloquear fechas anteriores en fechaHasta
            fechaDesdeInput.addEventListener('input', () => {
                if (fechaHastaInput) {
                    fechaHastaInput.min = fechaDesdeInput.value || '';
                    // si la fechaHasta actual es menor que fechaDesde, ajustarla
                    if (fechaHastaInput.value && fechaHastaInput.value < fechaDesdeInput.value) {
                        fechaHastaInput.value = fechaDesdeInput.value;
                    }
                }
                filtrar();
            });

            if (limpiarBtn) {
                limpiarBtn.addEventListener('click', () => {
                    fechaDesdeInput.value = '';
                    fechaHastaInput.value = '';
                    playaInput.value = '';
                    playeroInput.value = '';
                    if (fechaHastaInput) fechaHastaInput.min = '';
                    filtrar();
                });
            }

            filtrar();
        });

        // Event listeners para el formulario de filtros
        const formEl = document.getElementById('searchForm');

        document.querySelectorAll('.dropdown-menu .dropdown-item').forEach(el => {
            el.addEventListener('click', (e) => {
                e.preventDefault();
                const value = el.getAttribute('data-value');
                document.getElementById('filterBy').value = value;
                document.getElementById('filterBtn').innerHTML =
                    '<i class="fa-solid fa-filter"></i> Filtrar: ' + (mapLbl[value] || 'Todos');
                formEl.submit();
            });
        });

        document.getElementById('qInput')?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                formEl.submit();
            }
        });

        // Event listeners para habilitar/deshabilitar el botón "Añadir filtro"
        document.getElementById('qInput')?.addEventListener('input', () => {
            toggleAddButton();
            toggleLimpiar();
        });

        document.getElementById('playaSelect')?.addEventListener('change', () => {
            toggleAddButton();
            toggleLimpiar();
        });

        // Inicializar la UI
        updateFilterUI();
    </script>

    @* // Script paginacion *@
    <script>
        $(document).ready(function() {
            const itemsPerPage = 10; // Usamos 2 para la prueba
            const $list = $('#listaMovimientos');
            // Usaremos esta variable global para almacenar la función showPage
            let showPageFunction; 

            function initializePagination() {
                // Re-selecciona los items, ya que la visibilidad pudo haber cambiado por filtros
                const $items = $list.find('.movimiento'); 
                const totalItems = $items.length;
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                let currentPage = 1;
                const displayType = 'flex'; // d-flex

                // ---------------------------------------------------
                // LÓGICA DE PAGINACIÓN INTERNA
                // ---------------------------------------------------
                function showPage(page) {
                    currentPage = page;
                    const start = (page - 1) * itemsPerPage;
                    const end = start + itemsPerPage;

                    // Paso CRÍTICO: Oculta TODOS explícitamente
                    $items.attr('style', 'display: none !important'); 

                    // Muestra el subconjunto
                    const $itemsToShow = $items.slice(start, end);

                    // Paso CRÍTICO: Muestra el subconjunto explícitamente
                    $itemsToShow.attr('style', 'display: flex !important');

                    updatePaginationControls(totalPages, currentPage, showPage);
                }
                
                // Re-ejecutar la inicialización si hay suficientes items
                if (totalItems > itemsPerPage) {
                    showPageFunction = showPage; // Almacenamos la función para uso externo
                    showPage(1); // Muestra la primera página del nuevo conjunto filtrado
                } else {
                    // Si no hay suficiente para paginar, solo muéstralos y limpia los controles
                    $items.attr('style', 'display: flex !important'); 
                    $('#pagination-controls').empty();
                    showPageFunction = null; // Reiniciamos la referencia
                }

                // --- Solo la lógica de generación de controles (refactorizada) ---
                function updatePaginationControls(totalPages, currentPage, showPage) {
                    const $controls = $('#pagination-controls');
                    $controls.empty(); 
                    if (totalPages <= 1) return;

                    const $ul = $('<ul class="pagination pagination-sm"></ul>');
                    
                    // --- Botón 'Anterior' ---
                    const $prevLi = $('<li class="page-item"></li>');
                    const $prevLink = $('<a class="page-link" href="#">Anterior</a>')
                        .toggleClass('disabled', currentPage === 1)
                        .on('click', function(e) {
                            e.preventDefault();
                            if (currentPage > 1) {
                                showPage(currentPage - 1);
                            }
                        });
                    $prevLi.append($prevLink);
                    $ul.append($prevLi);

                    // --- Botones de número de página ---
                    for (let i = 1; i <= totalPages; i++) {
                        const $li = $('<li class="page-item"></li>');
                        const $link = $('<a class="page-link" href="#"></a>').text(i)
                            .toggleClass('active', i === currentPage)
                            .on('click', (function(pageNumber) {
                                return function(e) {
                                    e.preventDefault();
                                    showPage(pageNumber);
                                };
                            })(i));
                        $li.append($link);
                        $ul.append($li);
                    }

                    // --- Botón 'Siguiente' ---
                    const $nextLi = $('<li class="page-item"></li>');
                    const $nextLink = $('<a class="page-link" href="#">Siguiente</a>')
                        .toggleClass('disabled', currentPage === totalPages)
                        .on('click', function(e) {
                            e.preventDefault();
                            if (currentPage < totalPages) {
                                showPage(currentPage + 1);
                            }
                        });
                    $nextLi.append($nextLink);
                    $ul.append($nextLi);

                    $controls.append($ul);
                }
            }

            // ---------------------------------------------------
            // 3. INTEGRACIÓN CON FILTROS
            // ---------------------------------------------------
            // Asumiendo que esta función es la que aplica todos tus filtros
            function applyMovementFilters() {
                // Lógica de filtrado: Obtener valores de los filtros (fechas, playa, playero)
                const fechaDesde = $('#filtroFechaDesde').val();
                const fechaHasta = $('#filtroFechaHasta').val();
                const playa = $('#filtroPlaya').val().toLowerCase();
                const playero = $('#filtroPlayero').val().toLowerCase();

                // Iterar sobre todos los movimientos y aplicar el filtro de visibilidad
                $('#listaMovimientos').find('.movimiento').each(function() {
                    const $mov = $(this);
                    const movFecha = $mov.data('fecha');
                    const movPlaya = $mov.data('playa').toLowerCase();
                    const movPlayero = $mov.data('playero').toLowerCase();
                    let show = true;

                    // Lógica de filtrado (debes completarla según tus necesidades)
                    if (fechaDesde && movFecha < fechaDesde) { show = false; }
                    if (fechaHasta && movFecha > fechaHasta) { show = false; }
                    if (playa && movPlaya.indexOf(playa) === -1) { show = false; }
                    if (playero && movPlayero.indexOf(playero) === -1) { show = false; }

                    // El movimiento cumple con los filtros, lo marcamos como 'visible'
                    // OJO: Aquí NO usamos .show()/.hide(), solo manipulamos la clase
                    $mov.toggleClass('filtered-hidden', !show); 
                });

                // Después de que el filtrado cambia la visibilidad, REINICIAMOS LA PAGINACIÓN
                initializePagination();
            }

            // Asocia la función de filtrado a los eventos de los inputs
            $('#filtrosForm input').on('change keyup', function() {
                applyMovementFilters();
            });

            // Asocia el botón Limpiar filtros
            $('#btnLimpiarMov').on('click', function() {
                // Lógica para limpiar los inputs
                $('#filtrosForm input').val('');

                // Y luego aplicar el filtro (que ahora mostrará todo)
                applyMovementFilters();
            });

            // ---------------------------------------------------
            // 4. INICIALIZACIÓN INICIAL
            // ---------------------------------------------------
            // Primera carga de la página
            initializePagination(); 
        });
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
    (function () {
        const datatableLanguage = {
            url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json",
            lengthMenu: "Mostrar _MENU_ playeros",
            paginate: {
                previous: "« Anterior",
                next: "Siguiente »"
            }
        };

        const domLayout =
            "<'row mb-3'<'col-12 col-md-6'l>>" +
            "<'row'<'col-12'tr>>" +
            "<'row mt-3'<'col-12 col-md-6'i><'col-12 col-md-6 d-flex justify-content-md-end'p>>";

        function initIfExists(selector) {
            try {
                if (!document.querySelector(selector)) return;

                // evitar inicializar dos veces
                if ($.fn.DataTable.isDataTable(selector)) return;

                $(selector).DataTable({
                    dom: domLayout,
                    order: [[0, "asc"]],
                    pageLength: 10,
                    lengthMenu: [5, 10, 25, 50],
                    pagingType: "simple_numbers",
                    language: datatableLanguage,
                    columnDefs: [{ "orderable": false, "targets": -1 }],
                    searching: false,
                    responsive: true,
                    info: false,
                });
            } catch (err) {
                console.error("Error inicializando DataTable para", selector, err);
            }
        }

        $(document).ready(function () {
            initIfExists('#playerosTable');
        });
    })();
    </script>
}