@using estacionamientos.ViewModels
@model PlayeroIndexFilterVM

@{
    ViewData["Title"] = "Playeros";

    string LabelFiltro(string v) => v?.ToLower() switch {
        "nombre" => "Nombre",
        "playa" => "Playa",
        _ => "Todos"
    };

    bool showAddButton = !string.IsNullOrWhiteSpace(Model.Q) && Model.FilterBy != "playa";

    var ultMovimientos = ViewBag.ultMovimientos as List<MovimientoPlayero>;
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />

<div class="container">
    <!-- Encabezado: título a la izquierda, botones a la derecha -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Playeros</h1>
    </div>

    <!-- Formulario de búsqueda/filtros -->
    <form method="get" id="searchForm" class="row g-2 align-items-center mb-3">
        <!-- Campo de texto -->
        <div class="col-md-5 @(Model.FilterBy == "playa" ? "d-none" : "")" id="qWrapper">
            <input name="Q" id="qInput" value="@Model.Q" class="form-control" placeholder="Buscar playeros..." />
        </div>

        <!-- Dropdown de playas -->
        <div class="col-md-5 @(Model.FilterBy == "playa" ? "" : "d-none")" id="playaWrapper">
            <select name="SelectedPlaya" id="playaSelect" class="form-select">
                <option value="">Seleccionar playa...</option>
                @if (ViewBag.PlayasDelDuenio != null)
                {
                    @foreach (var playa in ViewBag.PlayasDelDuenio)
                    {
                        <option value="@playa.Nombre">@playa.Nombre</option>
                    }
                }
            </select>
        </div>

        <!-- Botón Filtrar -->
        <div class="col-auto">
            <div class="btn-group">
                <input type="hidden" name="FilterBy" id="filterBy" value="@Model.FilterBy" />
                <button type="button" class="btn btn-outline-secondary dropdown-toggle"
                        data-bs-toggle="dropdown" aria-expanded="false" id="filterBtn">
                    <i class="fa-solid fa-filter"></i> Filtrar: @LabelFiltro(Model.FilterBy)
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" data-value="todos">Todos</a></li>
                    <li><a class="dropdown-item" href="#" data-value="nombre">Nombre</a></li>
                    <li><a class="dropdown-item" href="#" data-value="playa">Playa</a></li>
                </ul>
            </div>
        </div>

        <!-- Buscar + Limpiar -->
        <div class="col-auto">
            <button type="submit" class="btn btn-secondary" title="Buscar">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
            <a id="btnLimpiar"
               class="btn btn-outline-secondary @(Model.HayFiltros ? "" : "d-none")"
               asp-action="Index"
               title="Limpiar filtros">
                <i class="fa-regular fa-circle-xmark"></i>
            </a>
        </div>

        <!-- Botón Agregar Playero alineado a la derecha -->
        <div class="col-auto ms-auto">
            <a class="btn btn-primary" asp-controller="Playero" asp-action="Create" title="Agregar playero">
                <i class="fa-solid fa-plus"></i> Agregar playero
            </a>
            <a class="btn btn-outline-secondary ms-2" asp-controller="Playero" asp-action="HistorialAgrupado">
                <i class="fa-solid fa-clock-rotate-left"></i> Historial
            </a>
        </div>

        <!-- Botón Añadir filtro -->
        <div class="w-100"></div>
        <div class="col-md-5 mt-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnAddOne" disabled>
                Añadir filtro
            </button>
        </div>

        <!-- Inputs ocultos para preservar filtros acumulados -->
        @for (int i = 0; i < Model.Nombres.Count; i++)
        {
            <input type="hidden" name="Nombres[@i]" value="@Model.Nombres[i]" />
        }
        @for (int i = 0; i < Model.Playas.Count; i++)
        {
            <input type="hidden" name="Playas[@i]" value="@Model.Playas[i]" />
        }
        @for (int i = 0; i < Model.Todos.Count; i++)
        {
            <input type="hidden" name="Todos[@i]" value="@Model.Todos[i]" />
        }
    </form>

    <!-- Badges de filtros acumulados -->
    @if ((Model.Nombres?.Any() ?? false) || (Model.Playas?.Any() ?? false) || (Model.Todos?.Any() ?? false))
    {
        <div class="mb-3 d-flex flex-wrap gap-2">
            @* TODOS *@
            @if (Model.Todos != null)
            {
                @foreach (var v in Model.Todos)
                {
                    <span class="badge rounded-pill text-bg-light border">
                        @v
                        <a class="ms-2 text-decoration-none"
                          asp-action="Index"
                          asp-route-Q="@Model.Q"
                          asp-route-FilterBy="@Model.FilterBy"
                          asp-route-Remove="todos:@v"
                          asp-route-Nombres="@(string.Join(",", Model.Nombres ?? new List<string>()))"
                          asp-route-Playas="@(string.Join(",", Model.Playas ?? new List<string>()))"
                          asp-route-Todos="@(string.Join(",", Model.Todos ?? new List<string>()))"
                          title="Quitar">
                            <i class="fa-regular fa-circle-xmark"></i>
                        </a>
                    </span>
                }
            }

            @* NOMBRES *@
            @if (Model.Nombres != null)
            {
                @foreach (var v in Model.Nombres)
                {
                    <span class="badge rounded-pill text-bg-light border">
                        @v
                        <a class="ms-2 text-decoration-none"
                          asp-action="Index"
                          asp-route-Q="@Model.Q"
                          asp-route-FilterBy="@Model.FilterBy"
                          asp-route-Remove="nombre:@v"
                          asp-route-Nombres="@(string.Join(",", Model.Nombres ?? new List<string>()))"
                          asp-route-Playas="@(string.Join(",", Model.Playas ?? new List<string>()))"
                          asp-route-Todos="@(string.Join(",", Model.Todos ?? new List<string>()))"
                          title="Quitar">
                            <i class="fa-regular fa-circle-xmark"></i>
                        </a>
                    </span>
                }
            }

            @* PLAYAS *@
            @if (Model.Playas != null)
            {
                @foreach (var v in Model.Playas)
                {
                    <span class="badge rounded-pill text-bg-light border">
                        @v
                        <a class="ms-2 text-decoration-none"
                          asp-action="Index"
                          asp-route-Q="@Model.Q"
                          asp-route-FilterBy="@Model.FilterBy"
                          asp-route-Remove="playa:@v"
                          asp-route-Nombres="@(string.Join(",", Model.Nombres ?? new List<string>()))"
                          asp-route-Playas="@(string.Join(",", Model.Playas ?? new List<string>()))"
                          asp-route-Todos="@(string.Join(",", Model.Todos ?? new List<string>()))"
                          title="Quitar">
                            <i class="fa-regular fa-circle-xmark"></i>
                        </a>
                    </span>
                }
            }
        </div>
    }

    <table id="playerosTable" class="table table-striped table-hover table-sm align-middle text-center mt-3">
        <thead>
            <tr>
                <th class="text-center">Nombre</th>
                <th class="text-center">Playas asignadas</th>
                <th class="text-center">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Playeros is { Count: > 0 })
            {
                foreach (var row in Model.Playeros)
                {
                    var p = row.Playero;
                    <tr>
                        <td>@p.UsuNyA</td>
                        <td>
                            @if (row.Playas.Count == 0)
                            {
                                <span class="text-muted">Sin asignaciones</span>
                            }
                            else
                            {
                                foreach (var playa in row.Playas)
                                {
                                    var etiqueta = !string.IsNullOrWhiteSpace(playa.PlyNom)
                                    ? playa.PlyNom
                                    : $"{playa.PlyCiu} - {playa.PlyDir}";

                                    <!-- Desasignar (marca histórico) -->
                                        <div class="playa-chip">
                                            @etiqueta
                                        <button type="button"
                                                    class="remove-btn"
                                                    title="Desasignar"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#confirmUnassignModal"
                                                data-playero-id="@p.UsuNU"
                                                data-playero-name="@p.UsuNyA"
                                                data-playa-id="@playa.PlyID"
                                                data-playa-name="@etiqueta">
                                                <i class="fa-regular fa-circle-xmark"></i>
                                            </button>
                                        </div>
                                }
                            }
                        </td>
                        <td class="text-center">
                            <!-- Comentado el editar playero porque no considero que esté bien -->
                            <!--
                            <a class="btn btn-outline-primary btn-sm me-2" asp-controller="Playero" asp-action="Edit"
                                asp-route-id="@p.UsuNU" title="Editar">
                                        <i class="fa-regular fa-pen-to-square"></i>
                            </a>
                            -->
                            <a class="btn btn-outline-secondary btn-sm me-2" asp-controller="Playero" asp-action="Assign"
                                asp-route-id="@p.UsuNU" title="Vincular a una playa">
                                <i class="fa-solid fa-link"></i>
                            </a>

                            <button type="button" 
                                    class="btn btn-outline-danger btn-sm"
                                    title="Desvincular todas las playas"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#confirmUnlinkModal"
                                    data-playero-id="@p.UsuNU"
                                    data-playero-name="@p.UsuNyA">
                                <i class="fa-solid fa-link-slash"></i>
                            </button>

                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="3" class="text-center text-muted">
                        No tenés playeros asignados en tus playas.
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Modal de confirmación para desvincular playero de todas las playas -->
    <div class="modal fade" id="confirmUnlinkModal" tabindex="-1" aria-labelledby="confirmUnlinkModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmUnlinkModalLabel">Confirmar desvinculación total</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres desvincular este playero de todas sus playas?</p>
                    <p class="mb-0"><strong>Playero:</strong> <span id="playeroName"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <form id="confirmUnlinkForm" asp-controller="Playero" asp-action="Delete" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="playeroId" name="id" />
                        <button type="submit" class="btn btn-danger">Desvincular</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para desvincular playero de una playa específica -->
    <div class="modal fade" id="confirmUnassignModal" tabindex="-1" aria-labelledby="confirmUnassignModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmUnassignModalLabel">Confirmar desvinculación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres desvincular este playero de esta playa?</p>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="mb-1"><strong>Playero:</strong> <span id="unassignPlayeroName"></span></p>
                            <p class="mb-0"><strong>Playa:</strong> <span id="unassignPlayaName"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <form id="confirmUnassignForm" asp-controller="Playero" asp-action="Unassign" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="unassignPlayeroId" name="plaNU" />
                        <input type="hidden" id="unassignPlayaId" name="plyID" />
                        <button type="submit" class="btn btn-danger">Desvincular</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Tabla ultimos movimientos general -->
    <div class="card shadow-sm mt-5">
        <div class="card-header bg-light fw-bold text-center fs-5">
            Últimos movimientos
        </div>

        <div class="card-body pb-0">

            <div class="d-flex justify-content-between align-items-center mb-3">
            <!-- Paginación a la izquierda -->
            <div id="pagination-controls" class="mb-0"></div>

            <!-- Botón mostrar filtros a la derecha -->
            <div class="text-end">
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse"
                    data-bs-target="#filtrosCollapse" aria-expanded="false" aria-controls="filtrosCollapse">
                    Mostrar filtros
                    <i class="fa-solid fa-caret-down"></i>
                </button>
            </div>
        </div>

            <!-- Filtros -->
            <div class="collapse mb-3" id="filtrosCollapse">
                <div class="p-3 rounded" style="background-color: #f5f5f5;">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label mb-0">Desde</label>
                            <input type="date" id="filtroFechaDesde" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label mb-0">Hasta</label>
                            <input type="date" id="filtroFechaHasta" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label mb-0">Playa</label>
                            <select id="filtroPlaya" class="form-select form-select-sm">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label mb-0">Playero</label>
                            <select id="filtroPlayero" class="form-select form-select-sm">
                                <option value="">Todos</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-end mt-3">
                        <button id="btnLimpiarMov" class="btn btn-outline-secondary btn-sm">Limpiar filtros</button>
                    </div>
                </div>
            </div>

            <!-- Tabla de movimientos -->
            @if (ultMovimientos is { Count: > 0 })
            {
                <table id="tablaMovimientos" class="table table-borderless table-striped mb-0">
                    <tbody>
                        @foreach (var m in ultMovimientos.OrderByDescending(x => x.FechaMov))
                        {
                            string textoTipoMov = m.TipoMov switch
                            {
                                TipoMovimiento.IngresoVehiculo => $"ingresó el vehículo <span class='fw-semibold'>{m.VehPtnt}</span> a la plaza",
                                TipoMovimiento.EgresoVehiculo => $"egresó el vehículo <span class='fw-semibold'>{m.VehPtnt}</span> de la plaza",
                                TipoMovimiento.ReubicacionVehiculo => $"movió el vehículo <span class='fw-semibold'>{m.VehPtnt}</span> a la plaza",
                                _ => "realizó un movimiento"
                            };

                            <tr class="movimiento" 
                                data-fecha="@m.FechaMov.ToString("yyyy-MM-dd")" 
                                data-playa="@m.Playa?.PlyNom" 
                                data-playero="@m.Playero?.UsuNyA">
                                <td class="d-flex py-3 px-4" style="width: 100%;">
                                    <div style="flex: 1 1 auto; min-width: 0;">
                                        <span class="fw-semibold">@m.Playero?.UsuNyA</span>
                                        <span>@Html.Raw(textoTipoMov)</span>
                                        <span class="fw-semibold">@m.PlzNum</span>
                                    </div>
                                    <div style="flex-shrink: 0; margin-left: 1rem; text-align: right;">
                                        <small class="text-muted">@m.Playa?.PlyNom - @m.FechaMov.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <!-- Controles de paginación -->
                <div id="pagination-controls" class="d-flex justify-content-center my-3"></div>
            }
            else
            {
                <div class="text-center text-muted p-4">
                    No hay movimientos recientes.
                </div>
            }
        </div>
    </div>
</div>

<style>
    .playa-chip {
        display: inline-flex;
        align-items: center;
        background: #f1f8ff;
        /* azul muy claro */
        color: #1b3a68;
        /* azul Bootstrap */
        border: 1px solid #0f2647;
        border-radius: 999px;
        padding: 0.25rem 0.6rem;
        font-size: .85rem;
        margin: 0.15rem;
    }

    .playa-chip .remove-btn {
        background: none;
        border: none;
        color: #dc3545;
        /* rojo Bootstrap */
        margin-left: .4rem;
        padding: 0;
        cursor: pointer;
    }

    .playa-chip .remove-btn:hover {
        color: #a71d2a;
    }
</style>

@section Scripts {
    <script>
        const mapLbl = {todos:'Todos', nombre:'Nombre', playa:'Playa'};

        // Habilita/oculta inputs de búsqueda según el filtro elegido y actualiza la etiqueta
        function updateFilterUI() {
            const fb = document.getElementById('filterBy').value;
            const qW = document.getElementById('qWrapper');
            const pW = document.getElementById('playaWrapper');
            const qI = document.getElementById('qInput');
            const pS = document.getElementById('playaSelect');

            if (fb === 'playa') {
                qW?.classList.add('d-none');
                pW?.classList.remove('d-none');
                if (qI) qI.value = '';
            } else {
                pW?.classList.add('d-none');
                if (pS) pS.value = '';
                qW?.classList.remove('d-none');
            }

            document.getElementById('filterBtn').innerHTML =
                '<i class="fa-solid fa-filter"></i> Filtrar: ' + (mapLbl[fb] || 'Todos');

            toggleLimpiar();
            toggleAddButton();
        }

        // Muestra/oculta el botón "Limpiar" según haya algo que limpiar
        function toggleLimpiar() {
            const fb = document.getElementById('filterBy')?.value || 'todos';
            const q = document.getElementById('qInput')?.value?.trim() || '';
            const pS = document.getElementById('playaSelect')?.value?.trim() || '';
            const show = (fb && fb !== 'todos') || q.length > 0 || pS.length > 0;
            const limpiar = document.getElementById('btnLimpiar');
            if (limpiar) limpiar.classList.toggle('d-none', !show);
        }

        // ¿Hay algo que se pueda añadir como filtro según el tipo actual?
        function canAddCurrent() {
            const fb = document.getElementById('filterBy')?.value || 'todos';
            const q = document.getElementById('qInput')?.value?.trim() || '';
            const pS = document.getElementById('playaSelect')?.value?.trim() || '';
            
            if (fb === 'playa') {
                return pS.length > 0;
            } else {
                return q.length > 0;
            }
        }

        // Habilita/Deshabilita el botón "Añadir filtro"
        function toggleAddButton() {
            const btn = document.getElementById('btnAddOne');
            if (btn) btn.disabled = !canAddCurrent();
        }

        // Manejar el botón "Añadir filtro"
        document.getElementById('btnAddOne')?.addEventListener('click', function() {
            const fb = document.getElementById('filterBy')?.value || 'todos';
            const q = document.getElementById('qInput')?.value?.trim() || '';
            const pS = document.getElementById('playaSelect')?.value?.trim() || '';
            
            if (fb === 'playa' && pS.length > 0) {
                // Para playas, agregar la playa seleccionada como filtro
                const url = new URL(window.location);
                url.searchParams.append('Playas', pS);
                url.searchParams.delete('SelectedPlaya');
                url.searchParams.set('FilterBy', 'todos');
                window.location.href = url.toString();
            } else if (q.length > 0) {
                // Para otros filtros, agregar el valor según el tipo
                const url = new URL(window.location);
                
                if (fb === 'nombre') {
                    url.searchParams.append('Nombres', q);
                } else {
                    // Para "todos", agregar a la lista "Todos" para mantener la búsqueda flexible
                    url.searchParams.append('Todos', q);
                }
                
                url.searchParams.delete('Q');
                url.searchParams.set('FilterBy', 'todos');
                window.location.href = url.toString();
            }
        });

        // Manejar el modal de confirmación para desvincular playero
        document.addEventListener('DOMContentLoaded', function() {
            // Modal para desvincular de todas las playas
            const confirmUnlinkModal = document.getElementById('confirmUnlinkModal');
            const playeroNameSpan = document.getElementById('playeroName');
            const playeroIdInput = document.getElementById('playeroId');

            if (confirmUnlinkModal) {
                confirmUnlinkModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const playeroId = button.getAttribute('data-playero-id');
                    const playeroName = button.getAttribute('data-playero-name');

                    // Actualizar el contenido del modal
                    playeroNameSpan.textContent = playeroName;
                    playeroIdInput.value = playeroId;
                });
            }

            // Modal para desvincular de una playa específica
            const confirmUnassignModal = document.getElementById('confirmUnassignModal');
            const unassignPlayeroNameSpan = document.getElementById('unassignPlayeroName');
            const unassignPlayaNameSpan = document.getElementById('unassignPlayaName');
            const unassignPlayeroIdInput = document.getElementById('unassignPlayeroId');
            const unassignPlayaIdInput = document.getElementById('unassignPlayaId');

            if (confirmUnassignModal) {
                confirmUnassignModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const playeroId = button.getAttribute('data-playero-id');
                    const playeroName = button.getAttribute('data-playero-name');
                    const playaId = button.getAttribute('data-playa-id');
                    const playaName = button.getAttribute('data-playa-name');

                    // Actualizar el contenido del modal
                    unassignPlayeroNameSpan.textContent = playeroName;
                    unassignPlayaNameSpan.textContent = playaName;
                    unassignPlayeroIdInput.value = playeroId;
                    unassignPlayaIdInput.value = playaId;
                });
            }

            // SCRIPT FILTRO ULTIMOS MOVIMIENTOS DE PLAYERO
            const fechaDesde = document.getElementById('filtroFechaDesde');
            const fechaHasta = document.getElementById('filtroFechaHasta');
            const playaSelect = document.getElementById('filtroPlaya');
            const playeroSelect = document.getElementById('filtroPlayero');
            const limpiarBtn = document.getElementById('btnLimpiarMov');
            const movimientos = Array.from(document.querySelectorAll('.movimiento'));

            // Bloqueo de fechas: fechaHasta no puede ser menor que fechaDesde
            fechaDesde.addEventListener('input', () => {
                if (fechaHasta) {
                    fechaHasta.min = fechaDesde.value || '';
                    if (fechaHasta.value && fechaHasta.value < fechaDesde.value) {
                        fechaHasta.value = fechaDesde.value;
                    }
                }
                filtrar();
            });

            // Función para parsear yyyy-mm-dd a Date
            const parseDate = iso => iso ? new Date(iso + 'T00:00:00') : null;

            // Generar opciones solo a partir de movimientos visibles
            const playas = [...new Set(movimientos.map(m => m.dataset.playa).filter(Boolean))].sort();
            const playeros = [...new Set(movimientos.map(m => m.dataset.playero).filter(Boolean))].sort();

            playas.forEach(p => playaSelect.insertAdjacentHTML('beforeend', `<option value="${p}">${p}</option>`));
            playeros.forEach(p => playeroSelect.insertAdjacentHTML('beforeend', `<option value="${p}">${p}</option>`));

            const fechaEnRango = (fechaStr, desde, hasta) => {
                if (!fechaStr) return true;
                const f = parseDate(fechaStr);
                if (!f) return true;
                if (desde && f < desde) return false;
                if (hasta) {
                    const limite = new Date(hasta);
                    limite.setHours(23, 59, 59, 999);
                    if (f > limite) return false;
                }
                return true;
            };

            const filtrar = () => {
                const desde = parseDate(fechaDesde.value);
                const hasta = parseDate(fechaHasta.value);
                const playa = playaSelect.value;
                const playero = playeroSelect.value;

                let visibles = 0;

                movimientos.forEach(m => {
                    const okFecha = fechaEnRango(m.dataset.fecha, desde, hasta);
                    const okPlaya = !playa || m.dataset.playa === playa;
                    const okPlayero = !playero || m.dataset.playero === playero;

                    const mostrar = okFecha && okPlaya && okPlayero;
                    m.style.display = mostrar ? 'flex' : 'none';
                    if (mostrar) visibles++;
                });

                // Mensaje si no hay movimientos visibles
                let msg = document.getElementById('noMovimientosMsg');
                const tablaMovimientos = document.getElementById('tablaMovimientos');
                if (visibles === 0) {
                    if (!msg && tablaMovimientos) {
                        msg = document.createElement('div');
                        msg.id = 'noMovimientosMsg';
                        msg.className = 'text-center text-muted p-3';
                        msg.textContent = 'No hay movimientos que coincidan con los filtros.';
                        tablaMovimientos.insertAdjacentElement('afterend', msg);
                    }
                    if (tablaMovimientos) tablaMovimientos.style.display = 'none';
                } else {
                    if (msg) msg.remove();
                    if (tablaMovimientos) tablaMovimientos.style.display = '';
                }

                // Actualizar paginación
                if (typeof showPageFunction === 'function') showPageFunction(1);
            };

            [fechaHasta, playaSelect, playeroSelect].forEach(el => {
                if (el) el.addEventListener('input', filtrar);
                if (el) el.addEventListener('change', filtrar);
            });

            if (limpiarBtn) {
                limpiarBtn.addEventListener('click', () => {
                    fechaDesde.value = '';
                    fechaHasta.value = '';
                    playaSelect.value = '';
                    playeroSelect.value = '';
                    filtrar();
                });
            }

            filtrar(); // filtrar al cargar
        });

        // Event listeners para el formulario de filtros
        const formEl = document.getElementById('searchForm');

        document.querySelectorAll('.dropdown-menu .dropdown-item').forEach(el => {
            el.addEventListener('click', (e) => {
                e.preventDefault();
                const value = el.getAttribute('data-value');
                document.getElementById('filterBy').value = value;
                document.getElementById('filterBtn').innerHTML =
                    '<i class="fa-solid fa-filter"></i> Filtrar: ' + (mapLbl[value] || 'Todos');
                formEl.submit();
            });
        });

        document.getElementById('qInput')?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                formEl.submit();
            }
        });

        // Event listeners para habilitar/deshabilitar el botón "Añadir filtro"
        document.getElementById('qInput')?.addEventListener('input', () => {
            toggleAddButton();
            toggleLimpiar();
        });

        document.getElementById('playaSelect')?.addEventListener('change', () => {
            toggleAddButton();
            toggleLimpiar();
        });

        // Inicializar la UI
        updateFilterUI();
    </script>


    @* SCRIPT PAGINACION ULTIMOS MOVIMIENTOS DE PLAYERO *@
    <script>
    // Función que devuelve solo los elementos visibles
    function getVisibleItems() {
        return $('#tablaMovimientos tr.movimiento').filter(function() {
            return $(this).is(':visible');
        });
    }

    // Inicializar paginación sobre un conjunto específico
    function initializePagination(itemsPerPage = 10) {
        const $items = getVisibleItems();
        const totalItems = $items.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;
        let currentPage = 1;

        function showPage(page) {
            currentPage = page;
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;

            // ocultar todos los elementos visibles primero
            $items.hide();

            // mostrar solo los del rango
            $items.slice(start, end).css('display', 'table-row');

            updatePaginationControls(totalPages, currentPage);
        }

        function updatePaginationControls(totalPages, currentPage) {
            const $controls = $('#pagination-controls');
            $controls.empty();

            const $ul = $('<ul class="pagination pagination-sm"></ul>');

            const $prevLi = $('<li class="page-item"><a class="page-link" href="#">« Anterior</a></li>');
            $prevLi.toggleClass('disabled', currentPage === 1);
            $prevLi.find('a').click(e => { e.preventDefault(); if(currentPage>1) showPage(currentPage-1); });
            $ul.append($prevLi);

            for(let i=1;i<=totalPages;i++){
                const $li = $('<li class="page-item"></li>');
                const $link = $('<a class="page-link" href="#">'+i+'</a>');
                if(i===currentPage) $li.addClass('active');
                $link.click((e)=>{ e.preventDefault(); showPage(i); });
                $li.append($link);
                $ul.append($li);
            }

            const $nextLi = $('<li class="page-item"><a class="page-link" href="#">Siguiente »</a></li>');
            $nextLi.toggleClass('disabled', currentPage === totalPages);
            $nextLi.find('a').click(e => { e.preventDefault(); if(currentPage<totalPages) showPage(currentPage+1); });
            $ul.append($nextLi);

            $controls.append($ul);
        }

        showPage(1);

        // exportar la función para reiniciar al filtrar
        window.showPageMovimientos = showPage;
    }

    // Cada vez que aplicas filtros:
    function applyFilters() {
        $('#tablaMovimientos tr.movimiento').each(function() {
            const $tr = $(this);
            const playa = $('#filtroPlaya').val();
            const playero = $('#filtroPlayero').val();
            const fechaDesde = $('#filtroFechaDesde').val();
            const fechaHasta = $('#filtroFechaHasta').val();

            let visible = true;

            if(playa && $tr.data('playa') !== playa) visible = false;
            if(playero && $tr.data('playero') !== playero) visible = false;
            if(fechaDesde && $tr.data('fecha') < fechaDesde) visible = false;
            if(fechaHasta && $tr.data('fecha') > fechaHasta) visible = false;

            $tr.toggle(visible);
        });

        // mensaje "no hay movimientos"
        if ($('#tablaMovimientos tr.movimiento:visible').length === 0) {
            if (!$('#noMovimientosMsg').length) {
                $('#tablaMovimientos').after('<div id="noMovimientosMsg" class="text-center text-muted p-3">No hay movimientos que coincidan con los filtros.</div>');
            }
        } else {
            $('#noMovimientosMsg').remove();
        }

        // reinicia la paginación con los elementos filtrados
        initializePagination();
    }

    // Asociar filtros
    $('#filtroPlaya, #filtroPlayero, #filtroFechaDesde, #filtroFechaHasta').on('change input', applyFilters);
    $('#btnLimpiarMov').on('click', function() {
        $('#filtroPlaya, #filtroPlayero, #filtroFechaDesde, #filtroFechaHasta').val('');
        applyFilters();
    });

    // Inicializa al cargar
    $(document).ready(function() {
        initializePagination();
    });

    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
    (function () {
        const datatableLanguage = {
            lengthMenu: "Mostrar _MENU_ playeros",
            paginate: {
                previous: "« Anterior",
                next: "Siguiente »"
            },
            emptyTable: "No hay datos disponibles",
            info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
            infoEmpty: "Mostrando 0 a 0 de 0 registros",
            infoFiltered: "(filtrado de _MAX_ registros totales)",
            search: "Buscar:",
            zeroRecords: "No se encontraron registros"
        };

        const domLayout =
            "<'row mb-3'<'col-12 col-md-6'l>>" +
            "<'row'<'col-12'tr>>" +
            "<'row mt-3'<'col-12 col-md-6'i><'col-12 col-md-6 d-flex justify-content-md-end'p>>";

        function initIfExists(selector) {
            try {
                if (!document.querySelector(selector)) return;

                // evitar inicializar dos veces
                if ($.fn.DataTable.isDataTable(selector)) return;

                const $table = $(selector);
                
                // Verificar que la tabla tenga la estructura correcta
                const $thead = $table.find('thead tr');
                const $tbody = $table.find('tbody');
                
                if ($thead.length === 0 || $thead.find('th').length === 0) {
                    console.warn("La tabla no tiene encabezados válidos");
                    return;
                }

                const colCount = $thead.find('th').length;
                
                // Verificar si hay filas válidas (sin colspan)
                const $validRows = $tbody.find('tr').filter(function() {
                    return $(this).find('td[colspan]').length === 0;
                });
                
                // Si no hay filas válidas, no inicializar DataTables
                if ($validRows.length === 0) {
                    return;
                }
                
                // Verificar que todas las filas válidas tengan el mismo número de columnas
                let hasInvalidRows = false;
                $validRows.each(function() {
                    const $row = $(this);
                    const tdCount = $row.find('td').length;
                    if (tdCount !== colCount) {
                        console.warn(`Fila con número incorrecto de columnas: ${tdCount} en lugar de ${colCount}`);
                        hasInvalidRows = true;
                    }
                });
                
                if (hasInvalidRows) {
                    console.warn("No se puede inicializar DataTables debido a filas con estructura incorrecta");
                    return;
                }

                $table.DataTable({
                    dom: domLayout,
                    order: [[0, "asc"]],
                    pageLength: 10,
                    lengthMenu: [5, 10, 25, 50],
                    pagingType: "simple_numbers",
                    language: datatableLanguage,
                    columnDefs: [
                        { "orderable": false, "targets": -1 },
                        { "visible": false, "targets": [] } // No ocultar ninguna columna
                    ],
                    searching: false,
                    responsive: false,
                    info: false,
                    autoWidth: false
                });
            } catch (err) {
                console.error("Error inicializando DataTable para", selector, err);
            }
        }

        $(document).ready(function () {
            initIfExists('#playerosTable');
        });
    })();
    </script>
}